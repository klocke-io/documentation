import{_ as a,c as i,o as e,a2 as n}from"./chunks/framework.Bfq10Vlj.js";const c=JSON.parse('{"title":"Ipv6","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener-extension-provider-gcp","github_subdir":"docs/usage","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/ipv6.md","to":"ipv6.md"},"persona":"Users","title":"Ipv6","prev":false,"next":false},"headers":[],"relativePath":"docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/ipv6/index.md","filePath":"docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/ipv6.md","lastUpdated":null}'),t={name:"docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/ipv6/index.md"};function l(r,s,o,h,p,d){return e(),i("div",null,s[0]||(s[0]=[n(`<h1 id="dual-stack-support-for-gardener-gcp-extension" tabindex="-1">Dual-Stack Support for Gardener GCP Extension <a class="header-anchor" href="#dual-stack-support-for-gardener-gcp-extension" aria-label="Permalink to &quot;Dual-Stack Support for Gardener GCP Extension&quot;">​</a></h1><p>This document provides an overview of dual-stack support for the Gardener GCP extension. Furthermore it clarifies which components are utilized, how the infrastructure is setup and how a dual-stack cluster can be provisioned.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>Gardener allows to create dual-stack clusters on GCP. In this mode, both IPv4 and IPv6 are supported within the cluster. This significantly expands the available address space, enables seamless communication across both IPv4 and IPv6 environments, and ensures compliance with modern networking standards.</p><h3 id="key-components-for-dual-stack-support" tabindex="-1">Key Components for Dual-Stack Support <a class="header-anchor" href="#key-components-for-dual-stack-support" aria-label="Permalink to &quot;Key Components for Dual-Stack Support&quot;">​</a></h3><ul><li><strong><a href="/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/ipv6/#dual-stack-subnets">Dual-Stack Subnets</a></strong>: Separate subnets are created for nodes and services, with explicit IPv4 and external IPv6 ranges.</li><li><strong><a href="/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/ipv6/#ingress-gce">Ingress-GCE</a></strong>: Responsible for creating dual-stack (IPv4,IPv6) Load Balancers.</li><li><strong><a href="/docs/extensions/infrastructure-extensions/gardener-extension-provider-gcp/ipv6/#cloud-allocator">Cloud Allocator</a></strong>: Manages the assignment of IPv4 and IPv6 ranges to nodes and pods.</li></ul><h2 id="dual-stack-subnets" tabindex="-1">Dual-Stack Subnets <a class="header-anchor" href="#dual-stack-subnets" aria-label="Permalink to &quot;Dual-Stack Subnets&quot;">​</a></h2><p>When provisioning a dual-stack cluster, the GCP provider creates distinct subnets:</p><h3 id="_1-node-subnet" tabindex="-1">1. <strong>Node Subnet</strong> <a class="header-anchor" href="#_1-node-subnet" aria-label="Permalink to &quot;1. **Node Subnet**&quot;">​</a></h3><ul><li><strong>Primary IPv4 Range</strong>: Used for IPv4 nodes.</li><li><strong>Secondary IPv4 Range</strong>: Used for IPv4 pods.</li><li><strong>External IPv6 Range</strong>: Auto-assigned with a <code>/64</code> prefix. Each VM gets an interface with a <code>/96</code> prefix.</li><li><strong>Customization</strong>: <ul><li>IPv4 ranges (pods and nodes) can be defined in the shoot object.</li><li>IPv6 ranges are automatically filled by the GCP provider.</li></ul></li></ul><h3 id="_2-service-subnet" tabindex="-1">2. <strong>Service Subnet</strong> <a class="header-anchor" href="#_2-service-subnet" aria-label="Permalink to &quot;2. **Service Subnet**&quot;">​</a></h3><ul><li>This subnet is dedicated to IPv6 services. It is created due to GCP&#39;s limitation of not supporting IPv6 range reservations.</li></ul><h3 id="_3-internal-subnet-optional" tabindex="-1">3. <strong>Internal Subnet (optional)</strong> <a class="header-anchor" href="#_3-internal-subnet-optional" aria-label="Permalink to &quot;3. **Internal Subnet (optional)**&quot;">​</a></h3><ul><li>This subnet is dedicated for internal load balancer. Currently, only internal IPv4 loadbalancer are supported. They are provisioned by the Cloud Controller Manager (CCM).</li></ul><h2 id="ingress-gce" tabindex="-1">Ingress-GCE <a class="header-anchor" href="#ingress-gce" aria-label="Permalink to &quot;Ingress-GCE&quot;">​</a></h2><p>The ingress-gce is a mandatory component for dual-stack clusters. It is responsible for creating dual-stack (IPv4,IPv6) Load Balancers. This is necessary because the GCP Cloud Controller Manager does not support provisioning IPv6 Load Balancer.</p><h2 id="cloud-allocator" tabindex="-1">Cloud Allocator <a class="header-anchor" href="#cloud-allocator" aria-label="Permalink to &quot;Cloud Allocator&quot;">​</a></h2><p>The Cloud Allocator is part of the GCP Cloud Controller Manager and plays a critical role in managing IPAM (IP Address Management) for dual-stack clusters.</p><h3 id="responsibilities" tabindex="-1">Responsibilities <a class="header-anchor" href="#responsibilities" aria-label="Permalink to &quot;Responsibilities&quot;">​</a></h3><ul><li><strong>Assigning PODCIDRs to Node Objects</strong>: Ensures that both IPv4 and IPv6 pod ranges are correctly assigned to the node objects.</li><li><strong>Leveraging Secondary IPv4 Range</strong>: <ul><li>Uses the secondary IPv4 range in the node subnet to allocate pod IP ranges.</li><li>Assigns both IPv4 and IPv6 pod ranges in compliance with GCP’s networking model.</li></ul></li></ul><h3 id="operational-details" tabindex="-1">Operational Details <a class="header-anchor" href="#operational-details" aria-label="Permalink to &quot;Operational Details&quot;">​</a></h3><ul><li>The Cloud Allocator assigns a <code>/112</code> pod cidr range/subrange from the <code>/96</code> cidr range assigned to each VM.</li><li>This ensures efficient utilization of IPv6 address space while maintaining compatibility with Kubernetes networking requirements.</li></ul><h4 id="why-use-a-secondary-ipv4-range-for-pods" tabindex="-1">Why Use a Secondary IPv4 Range for Pods? <a class="header-anchor" href="#why-use-a-secondary-ipv4-range-for-pods" aria-label="Permalink to &quot;Why Use a Secondary IPv4 Range for Pods?&quot;">​</a></h4><p>The secondary IPv4 range is essential for:</p><ul><li>Enabling the Cloud Allocator to function correctly in assigning IP ranges.</li><li>Supporting both IPv4 and IPv6 pods in dual-stack clusters.</li><li>Aligning with GCP CCM’s requirement to separate pod IP ranges within the node subnet.</li></ul><h2 id="creating-a-dual-stack-cluster" tabindex="-1">Creating a Dual-Stack Cluster <a class="header-anchor" href="#creating-a-dual-stack-cluster" aria-label="Permalink to &quot;Creating a Dual-Stack Cluster&quot;">​</a></h2><p>To create a dual-stack cluster, both IP families (IPv4,IPv6) need to be specified under <code>spec.networking.ipFamilies</code>. Below is an example of a dual-stack shoot cluster configuration:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  provider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    infrastructureConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gcp.provider.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">InfrastructureConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      networks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        workers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10.250.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ipFamilies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">IPv4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">IPv6</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    nodes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">10.250.0.0/16</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span></code></pre></div><h2 id="migration-of-ipv4-only-shoot-clusters-to-dual-stack" tabindex="-1">Migration of IPv4-Only Shoot Clusters to Dual-Stack <a class="header-anchor" href="#migration-of-ipv4-only-shoot-clusters-to-dual-stack" aria-label="Permalink to &quot;Migration of IPv4-Only Shoot Clusters to Dual-Stack&quot;">​</a></h2><p>To migrate an IPv4-only shoot cluster to Dual-Stack simply change the <code>.spec.networking.ipFamilies</code> field in the <code>Shoot</code> resource from <code>IPv4</code> to <code>IPv4, IPv6</code> as shown below.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ipFamilies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">IPv4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">IPv6</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span></code></pre></div><p>You can find more information about the process and the steps required <a href="https://gardener.cloud/docs/gardener/networking/dual-stack-networking-migration/" target="_blank" rel="noreferrer">here</a>.</p><div class="warning custom-block github-alert"><p class="custom-block-title">WARNING</p><p>Please note that the dual-stack migration requires the IPv4-only cluster to run in native routing mode, i.e. pod overlay network needs to be disabled. The default quota of static routes per VPC in GCP is 200. This restricts the cluster size. Therefore, please adapt (if necessary) the quota for the routes per VPC (<code>STATIC_ROUTES_PER_NETWORK</code>) in the gcp cloud console accordingly before switching to native routing.</p></div><p>After triggering the migration a constraint of type <code>DualStackNodesMigrationReady</code> is added to the shoot status. It is in state <code>False</code> until all nodes have an IPv4 and IPv6 address assigned. Changing the <code>ipFamilies</code> field triggers immediately an infrastructure reconciliation, where the infrastructure is reconfigured to additionally support IPv6. During this infrastructure migration process the subnets get an external IPv6 range and the node subnet gets a secondary IPv4 range. Pod specific cloud routes are deleted from the VPC route table and alias IP ranges for the pod routes are added to the NIC of Kubernetes nodes/instances. With the next node roll-out which is a manual step and will not be triggered automatically, all nodes will get an IPv6 address and an IPv6 prefix for pods assigned. When all nodes have IPv4 and IPv6 pod ranges, the status of the <code>DualStackNodesMigrationReady</code> constraint will be changed to <code>True</code>. Once all nodes are migrated, the remaining control plane components and the Container Network Interface (CNI) are configured for dual-stack networking and the migration constraint is removed at the end of this step.</p><h2 id="load-balancer-service-configuration" tabindex="-1">Load Balancer Service Configuration <a class="header-anchor" href="#load-balancer-service-configuration" aria-label="Permalink to &quot;Load Balancer Service Configuration&quot;">​</a></h2><p>To create a dual-stack LoadBalancer the <code>spec.ipFamilies</code> and <code>spec.ipFamilyPolicy</code> field needs to be specified in the Kubernetes service. An example configuration is shown below:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    cloud.google.com/l4-rbs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">enabled</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ipFamilies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">IPv4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">IPv6</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ipFamilyPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">PreferDualStack</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12345</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    targetPort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">LoadBalancer</span></span></code></pre></div><p>The required annotation <code>cloud.google.com/l4-rbs: enabled</code> for ingress-gce is added automatically via webhook for services of <code>type: LoadBalancer</code>.</p><h3 id="internal-load-balancer" tabindex="-1">Internal Load Balancer <a class="header-anchor" href="#internal-load-balancer" aria-label="Permalink to &quot;Internal Load Balancer&quot;">​</a></h3><ul><li>Internal IPv6 LoadBalancers are currently <strong>not supported</strong>.</li><li>To create internal IPv4 LoadBalancers, you can set one of the the following annotations: <ul><li><code>&quot;networking.gke.io/load-balancer-type=Internal&quot;</code></li><li><code>&quot;cloud.google.com/load-balancer-type=internal&quot;</code> (deprecated). Internal load balancers are created by cloud-controller-manger and get an IPv4 address from the internal subnet.</li></ul></li></ul>`,40)]))}const g=a(t,[["render",l]]);export{c as __pageData,g as default};
