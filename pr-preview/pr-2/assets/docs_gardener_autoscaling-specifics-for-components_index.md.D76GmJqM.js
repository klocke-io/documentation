import{_ as e,c as i,o as a,a2 as n}from"./chunks/framework.B8WFj13S.js";const k=JSON.parse('{"title":"Autoscaling Specifics for Components","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/development","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/autoscaling-specifics-for-components.md","to":"autoscaling-specifics-for-components.md"},"persona":"Developers","title":"Autoscaling Specifics for Components","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/autoscaling-specifics-for-components/index.md","filePath":"docs/gardener/autoscaling-specifics-for-components.md","lastUpdated":null}'),t={name:"docs/gardener/autoscaling-specifics-for-components/index.md"};function l(o,s,r,h,p,c){return a(),i("div",null,s[0]||(s[0]=[n(`<h1 id="autoscaling-specifics-for-components" tabindex="-1">Autoscaling Specifics for Components <a class="header-anchor" href="#autoscaling-specifics-for-components" aria-label="Permalink to &quot;Autoscaling Specifics for Components&quot;">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>This document describes the used autoscaling mechanism for several components.</p><h2 id="garden-or-shoot-cluster-etcd" tabindex="-1">Garden or Shoot Cluster etcd <a class="header-anchor" href="#garden-or-shoot-cluster-etcd" aria-label="Permalink to &quot;Garden or Shoot Cluster etcd&quot;">​</a></h2><p>The <code>etcd</code> is scaled by a native <code>VPA</code> resource.</p><p>Downscaling is handled more pessimistically to prevent many subsequent etcd restarts. Thus, for <code>production</code> and <code>infrastructure</code> Shoot clusters (or all Garden clusters), downscaling is deactivated for the main etcd. For all other Shoot clusters, lower advertised requests/limits are only applied during the Shoot&#39;s maintenance time window.</p><h2 id="shoot-kubernetes-api-server" tabindex="-1">Shoot Kubernetes API Server <a class="header-anchor" href="#shoot-kubernetes-api-server" aria-label="Permalink to &quot;Shoot Kubernetes API Server&quot;">​</a></h2><p>The Shoot Kubernetes API server is scaled simultaneously by VPA and HPA on the same metric (CPU and memory usage).</p><p>The pod-trashing cycle between VPA and HPA scaling on the same metric is avoided by configuring the HPA to scale on average usage (not on average utilization). This makes possible VPA to first scale vertically on CPU/memory usage. Once all Pods&#39; average CPU/memory usage exceeds the HPA&#39;s target average usage, HPA is scaling horizontally (by adding a new replica). HPA&#39;s average target usage values are <code>6</code> CPU and <code>24G</code>. The initial API server resource requests are <code>250m</code> and <code>500Mi</code>.</p><p>The API server&#39;s min replica count is 2, the max replica count - 6. The min replica count of 2 is imposed by the <a href="documentation/pr-preview/pr-2/docs/gardener/high-availability-of-components/#control-plane-components">High Availability of Shoot Control Plane Components</a>.</p><p>The gardenlet sets the initial API server resource requests only when the Deployment is not found. When the Deployment exists, it is not overwriting the kube-apiserver container resources.</p><h2 id="disabling-scale-down-for-components-in-the-shoot-control-plane" tabindex="-1">Disabling Scale Down for Components in the Shoot Control Plane <a class="header-anchor" href="#disabling-scale-down-for-components-in-the-shoot-control-plane" aria-label="Permalink to &quot;Disabling Scale Down for Components in the Shoot Control Plane&quot;">​</a></h2><p>Some Shoot clusters&#39; control plane components can be overloaded and can have very high resource usage. The existing autoscaling solution could be imperfect to cover these cases. Scale down actions for such overloaded components could be disruptive.</p><p>To prevent such disruptive scale-down actions it is possible to disable scale down of the etcd, Kubernetes API server and Kubernetes controller manager in the Shoot control plane by annotating the Shoot with <code>alpha.control-plane.scaling.shoot.gardener.cloud/scale-down-disabled=true</code>.</p><p>There is the following specific for when disabling scale-down for the Kubernetes API server component:</p><ul><li>If the HPA resource exists and HPA&#39;s <code>spec.minReplicas</code> is not nil then the min replica count is <code>max(spec.minReplicas, status.desiredReplicas)</code>. When scale-down is disabled, this allows operators to specify a custom value for HPA <code>spec.minReplicas</code> and this value not to be reverted by gardenlet. I.e, HPA <em>does</em> scale down to min replicas but not below min replicas. HPA&#39;s max replica count is 6.</li></ul><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p>The <code>alpha.control-plane.scaling.shoot.gardener.cloud/scale-down-disabled</code> annotation is alpha and can be removed anytime without further notice. Only use it if you know what you do.</p></div><h2 id="virtual-kubernetes-api-server-and-gardener-api-server" tabindex="-1">Virtual Kubernetes API Server and Gardener API Server <a class="header-anchor" href="#virtual-kubernetes-api-server-and-gardener-api-server" aria-label="Permalink to &quot;Virtual Kubernetes API Server and Gardener API Server&quot;">​</a></h2><p>The virtual Kubernetes API server&#39;s autoscaling is same as the Shoot Kubernetes API server&#39;s with the following differences:</p><ul><li>The initial API server resource requests are <code>600m</code> and <code>512Mi</code>.</li><li>The min replica count is 2 for a non-HA virtual cluster and 3 for an HA virtual cluster. The max replica count is 6.</li></ul><p>The Gardener API server&#39;s autoscaling is the same as the Shoot Kubernetes API server&#39;s with the following differences:</p><ul><li>The initial API server resource requests are <code>600m</code> and <code>512Mi</code>.</li><li>The replica count is 2 for a non-HA virtual cluster and 3 for an HA virtual cluster.</li><li>Gardener API server is not scaled by HPA. <ul><li>Virtual Kubernetes API servers use one single HTTP2 connection to a Gardener API server. Thus, in case Gardener API server have more replicas its additional pods would not receive any requests.</li></ul></li></ul><h2 id="configure-minallowed-resources-for-control-plane-components" tabindex="-1">Configure <code>minAllowed</code> Resources for Control Plane Components <a class="header-anchor" href="#configure-minallowed-resources-for-control-plane-components" aria-label="Permalink to &quot;Configure \`minAllowed\` Resources for Control Plane Components&quot;">​</a></h2><p>It is possible to configure minimum allowed resources (<code>minAllowed</code>) for CPU/memory for ETCD instances and the Kubernetes API server. This configuration is available for both Shoot clusters and the Garden cluster, see examples below:</p><ul><li><code>Shoot</code><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  kubernetes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    etcd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        autoscaling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          minAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">6Gi</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      events</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        autoscaling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          minAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">3Gi</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    kubeAPIServer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      autoscaling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        minAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">3Gi</span></span></code></pre></div></li><li><code>Garden</code><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  virtualCluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    etcd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        autoscaling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          minAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">6Gi</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      events</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        autoscaling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          minAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">3Gi</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    kubernetes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kubeAPIServer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        autoscaling</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          minAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            cpu</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            memory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">3Gi</span></span></code></pre></div></li></ul><p>A primary use-case for configuring <code>minAllowed</code> resources arises from the need to alleviate delays during consecutive scale-up activities. Typically, in longer-running clusters, resource usage patterns evolve gradually, and the control plane can scale vertically in an adequate manner. However, in the case of newly spun-up clusters requiring immediate heavy usage, setting a <code>minAllowed</code> threshold for CPU and memory ensures that the control plane components are provisioned with sufficient resources to handle abrupt load increases without substantial delay.</p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p>To use this feature effectively, users should thoroughly analyze their cluster usage patterns in advance to identify appropriate resource values.</p></div>`,27)]))}const u=e(t,[["render",l]]);export{k as __pageData,u as default};
