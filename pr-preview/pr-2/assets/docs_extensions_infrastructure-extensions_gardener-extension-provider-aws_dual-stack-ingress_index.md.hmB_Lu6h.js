import{_ as a,c as e,o as i,a2 as n}from"./chunks/framework.Bfq10Vlj.js";const k=JSON.parse('{"title":"Dual Stack Ingress","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener-extension-provider-aws","github_subdir":"docs/usage","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/dual-stack-ingress.md","to":"dual-stack-ingress.md"},"persona":"Users","title":"Dual Stack Ingress","prev":false,"next":false},"headers":[],"relativePath":"docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/dual-stack-ingress/index.md","filePath":"docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/dual-stack-ingress.md","lastUpdated":null}'),t={name:"docs/extensions/infrastructure-extensions/gardener-extension-provider-aws/dual-stack-ingress/index.md"};function o(l,s,r,h,p,d){return i(),e("div",null,s[0]||(s[0]=[n(`<h1 id="using-ipv4-ipv6-dual-stack-ingress-in-an-ipv4-single-stack-cluster" tabindex="-1">Using IPv4/IPv6 (dual-stack) Ingress in an IPv4 single-stack cluster <a class="header-anchor" href="#using-ipv4-ipv6-dual-stack-ingress-in-an-ipv4-single-stack-cluster" aria-label="Permalink to &quot;Using IPv4/IPv6 (dual-stack) Ingress in an IPv4 single-stack cluster&quot;">​</a></h1><h2 id="motivation" tabindex="-1">Motivation <a class="header-anchor" href="#motivation" aria-label="Permalink to &quot;Motivation&quot;">​</a></h2><p>IPv6 adoption is continuously growing, already overtaking IPv4 in certain regions, e.g. India, or scenarios, e.g. mobile. Even though most IPv6 installations deploy means to reach IPv4, it might still be beneficial to expose services natively via IPv4 and IPv6 instead of just relying on IPv4.</p><h2 id="disadvantages-of-full-ipv4-ipv6-dual-stack-deployments" tabindex="-1">Disadvantages of full IPv4/IPv6 (dual-stack) Deployments <a class="header-anchor" href="#disadvantages-of-full-ipv4-ipv6-dual-stack-deployments" aria-label="Permalink to &quot;Disadvantages of full IPv4/IPv6 (dual-stack) Deployments&quot;">​</a></h2><p>Enabling full IPv4/IPv6 (dual-stack) support in a kubernetes cluster is a major endeavor. It requires a lot of changes and restarts of all pods so that all pods get addresses for both IP families. A side-effect of dual-stack networking is that failures may be hidden as network traffic may take the other protocol to reach the target. For this reason and also due to reduced operational complexity, service teams might lean towards staying in a single-stack environment as much as possible. Luckily, this is possible with Gardener and IPv4/IPv6 (dual-stack) ingress on AWS.</p><h2 id="simplifying-ipv4-ipv6-dual-stack-ingress-with-protocol-translation-on-aws" tabindex="-1">Simplifying IPv4/IPv6 (dual-stack) Ingress with Protocol Translation on AWS <a class="header-anchor" href="#simplifying-ipv4-ipv6-dual-stack-ingress-with-protocol-translation-on-aws" aria-label="Permalink to &quot;Simplifying IPv4/IPv6 (dual-stack) Ingress with Protocol Translation on AWS&quot;">​</a></h2><p>Fortunately, the network load balancer on AWS supports automatic protocol translation, i.e. it can expose both IPv4 and IPv6 endpoints while communicating with just one protocol to the backends. Under the hood, automatic protocol translation takes place. Client IP address preservation can be achieved by using proxy protocol.</p><p>This approach enables users to expose IPv4 workload to IPv6-only clients without having to change the workload/service. Without requiring invasive changes, it allows a fairly simple first step into the IPv6 world for services just requiring ingress (incoming) communication.</p><h2 id="necessary-shoot-cluster-configuration-changes-for-ipv4-ipv6-dual-stack-ingress" tabindex="-1">Necessary Shoot Cluster Configuration Changes for IPv4/IPv6 (dual-stack) Ingress <a class="header-anchor" href="#necessary-shoot-cluster-configuration-changes-for-ipv4-ipv6-dual-stack-ingress" aria-label="Permalink to &quot;Necessary Shoot Cluster Configuration Changes for IPv4/IPv6 (dual-stack) Ingress&quot;">​</a></h2><p>To be able to utilize IPv4/IPv6 (dual-stack) Ingress in an IPv4 shoot cluster, the cluster needs to meet two preconditions:</p><ol><li><code>dualStack.enabled</code> needs to be set to <code>true</code> to configure VPC/subnet for IPv6 and add a routing rule for IPv6. (This does not add IPv6 addresses to kubernetes nodes.)</li><li><code>loadBalancerController.enabled</code> needs to be set to <code>true</code> as well to use the load balancer controller, which supports dual-stack ingress.</li></ol><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  provider</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">aws</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    infrastructureConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">aws.provider.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">InfrastructureConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      dualStack</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    controlPlaneConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">aws.provider.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ControlPlaneConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      loadBalancerController</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span></code></pre></div><p>When <code>infrastructureConfig.networks.vpc.id</code> is set to the ID of an existing VPC, please make sure that your VPC has an <a href="https://docs.aws.amazon.com/vpc/latest/userguide/modify-vpcs.html#vpc-associate-ipv6-cidr" target="_blank" rel="noreferrer">Amazon-provided IPv6 CIDR block added</a>.</p><p>After adapting the shoot specification and reconciling the cluster, dual-stack load balancers can be created using kubernetes services objects.</p><h2 id="creating-an-ipv4-ipv6-dual-stack-ingress" tabindex="-1">Creating an IPv4/IPv6 (dual-stack) Ingress <a class="header-anchor" href="#creating-an-ipv4-ipv6-dual-stack-ingress" aria-label="Permalink to &quot;Creating an IPv4/IPv6 (dual-stack) Ingress&quot;">​</a></h2><p>With the preconditions set, creating an IPv4/IPv6 load balancer is as easy as annotating a service with the correct annotations:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    service.beta.kubernetes.io/aws-load-balancer-ip-address-type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">dualstack</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    service.beta.kubernetes.io/aws-load-balancer-scheme</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">internet-facing</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">instance</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    service.beta.kubernetes.io/aws-load-balancer-type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">external</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">LoadBalancer</span></span></code></pre></div><p>In case the client IP address should be preserved, the following annotation can be used to enable proxy protocol. (The pod receiving the traffic needs to be configured for proxy protocol as well.)</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    service.beta.kubernetes.io/aws-load-balancer-proxy-protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*&quot;</span></span></code></pre></div><p>Please note that changing an existing <code>Service</code> to dual-stack may cause the creation of a new load balancer without deletion of the old AWS load balancer resource. While this helps in a seamless migration by not cutting existing connections it may lead to wasted/forgotten resources. Therefore, the (manual) cleanup needs to be taken into account when migrating an existing <code>Service</code> instance.</p><p>For more details see <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/service/nlb/" target="_blank" rel="noreferrer">AWS Load Balancer Documentation - Network Load Balancer</a>.</p><h2 id="dns-considerations-to-prevent-downtime-during-a-dual-stack-migration" tabindex="-1">DNS Considerations to Prevent Downtime During a Dual-Stack Migration <a class="header-anchor" href="#dns-considerations-to-prevent-downtime-during-a-dual-stack-migration" aria-label="Permalink to &quot;DNS Considerations to Prevent Downtime During a Dual-Stack Migration&quot;">​</a></h2><p>In case the migration of an existing service is desired, please check if there are DNS entries directly linked to the corresponding load balancer. The migrated load balancer will have a new domain name immediately, which will not be ready in the beginning. Therefore, a direct migration of the domain name entries is not desired as it may cause a short downtime, i.e. domain name entries without backing IP addresses.</p><p>If there are DNS entries directly linked to the corresponding load balancer and they are managed by the <a href="https://github.com/gardener/gardener-extension-shoot-dns-service" target="_blank" rel="noreferrer">shoot-dns-service</a>, you can identify this via annotations with the prefix <code>dns.gardener.cloud/</code>. Those annotations can be linked to a <code>Service</code>, <code>Ingress</code> or <code>Gateway</code> resources. Alternatively, they may also use <code>DNSEntry</code> or <code>DNSAnnotation</code> resources.</p><p>⚠️ <strong>Note:</strong> Shoot owners using external DNS management with versions below v0.26.0 may experience runtime impacts during migration.</p><p>For a seamless migration without downtime use the following three step approach:</p><ol><li>Temporarily prevent direct DNS updates</li><li>Migrate the load balancer and wait until it is operational</li><li>Allow DNS updates again</li></ol><p>To prevent direct updates of the DNS entries when the load balancer is migrated add the annotation <code>dns.gardener.cloud/ignore: &#39;true&#39;</code> to all affected resources next to the other <code>dns.gardener.cloud/...</code> annotations before starting the migration. For example, in case of a <code>Service</code> ensure that the service looks like the following:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    dns.gardener.cloud/ignore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;true&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    dns.gardener.cloud/class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    dns.gardener.cloud/dnsnames</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;...&#39;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span></code></pre></div><p>Next, migrate the load balancer to be dual-stack enabled by adding/changing the corresponding annotations.</p><p>You have multiple options how to check that the load balancer has been provisioned successfully. It might be useful to peek into <code>status.loadBalancer.ingress</code> of the corresponding <code>Service</code> to identify the load balancer:</p><ul><li>Check in the AWS console for the corresponding load balancer provisioning state</li><li>Perform domain name lookups with <code>nslookup</code>/<code>dig</code> to check whether the name resolves to an IP address.</li><li>Call your workload via the new load balancer, e.g. using <code>curl --resolve &lt;my-domain-name&gt;:&lt;port&gt;:&lt;IP-address&gt; https://&lt;my-domain-name&gt;:&lt;port&gt;</code>, which allows you to call your service with the &quot;correct&quot; domain name without using actual name resolution.</li><li>Wait a fixed period of time as load balancer creation is usually finished within 15 minutes</li></ul><p>Once the load balancer has been provisioned, you can remove the annotation <code>dns.gardener.cloud/ignore: &#39;true&#39;</code> again from the affected resources. It may take some additional time until the domain name change finally propagates (up to one hour).</p><h2 id="important-check-aws-quotas-before-migration" tabindex="-1">Important: Check AWS Quotas Before Migration <a class="header-anchor" href="#important-check-aws-quotas-before-migration" aria-label="Permalink to &quot;Important: Check AWS Quotas Before Migration&quot;">​</a></h2><p>Before migrating to dual-stack ingress, verify that your AWS account has sufficient quotas to avoid service disruptions.</p><h3 id="network-load-balancer-quotas" tabindex="-1">Network Load Balancer Quotas <a class="header-anchor" href="#network-load-balancer-quotas" aria-label="Permalink to &quot;Network Load Balancer Quotas&quot;">​</a></h3><p><strong>1. Network Load Balancers per Region</strong></p><ul><li><strong>Default limit:</strong> 50 per region</li><li><strong>Migration impact:</strong> If migrating from Classic Load Balancers to Network Load Balancers, ensure this quota is sufficient</li><li><strong>Dual-stack migration:</strong> During migration, you temporarily need <strong>double</strong> the number of load balancers</li></ul><p><strong>2. Targets per Network Load Balancer per Availability Zone</strong></p><ul><li><p>Migrating from classic load balancers to network load balancers, this quota needs to be checked, as a similar limitation does not exist for classic load balancers.</p></li><li><p><strong>Default limit:</strong> 500 targets per AZ per NLB</p></li><li><p><strong>Critical calculation:</strong> <code>(number of nodes × number of service ports) ÷ number of availability zones</code></p></li><li><p><strong>Example:</strong> 10 nodes × 3 service ports ÷ 2 AZs = 15 targets per AZ (well within limit)</p></li><li><p><strong>Example:</strong> 200 nodes × 5 service ports ÷ 2 AZs = 500 targets per AZ (at limit - consider increasing)</p></li></ul><p>⚠️ <strong>Important:</strong> Quota increase requests can take up to 24-48 hours to process. Plan accordingly.</p><p>For complete quota details, see the <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-limits.html" target="_blank" rel="noreferrer">AWS Network Load Balancer Limits documentation</a>.</p>`,42)]))}const g=a(t,[["render",o]]);export{k as __pageData,g as default};
