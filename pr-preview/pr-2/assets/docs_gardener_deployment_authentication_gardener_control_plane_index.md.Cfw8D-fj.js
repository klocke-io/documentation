import{_ as s,c as a,o as t,a2 as i}from"./chunks/framework.Bfq10Vlj.js";const k=JSON.parse('{"title":"Authentication Gardener Control Plane","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/deployment","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/deployment/authentication_gardener_control_plane.md","to":"authentication_gardener_control_plane.md"},"title":"Authentication Gardener Control Plane","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/deployment/authentication_gardener_control_plane/index.md","filePath":"docs/gardener/deployment/authentication_gardener_control_plane.md","lastUpdated":null}'),n={name:"docs/gardener/deployment/authentication_gardener_control_plane/index.md"};function r(l,e,o,h,c,d){return t(),a("div",null,e[0]||(e[0]=[i(`<h1 id="authentication-of-gardener-control-plane-components-against-the-garden-cluster" tabindex="-1">Authentication of Gardener Control Plane Components Against the Garden Cluster <a class="header-anchor" href="#authentication-of-gardener-control-plane-components-against-the-garden-cluster" aria-label="Permalink to &quot;Authentication of Gardener Control Plane Components Against the Garden Cluster&quot;">​</a></h1><blockquote><p><strong>Note:</strong> This document refers to Gardener&#39;s API server, admission controller, controller manager and scheduler components. Any reference to the term <strong>Gardener control plane component</strong> can be replaced with any of the mentioned above.</p></blockquote><p>There are several authentication possibilities depending on whether or not <a href="https://github.com/gardener/garden-setup#concept-the-virtual-cluster" target="_blank" rel="noreferrer">the concept of Virtual Garden</a> is used.</p><h2 id="virtual-garden-is-not-used-i-e-the-runtime-garden-cluster-is-also-the-target-garden-cluster" tabindex="-1">Virtual Garden is not used, i.e., the <code>runtime</code> Garden cluster is also the <code>target</code> Garden cluster. <a class="header-anchor" href="#virtual-garden-is-not-used-i-e-the-runtime-garden-cluster-is-also-the-target-garden-cluster" aria-label="Permalink to &quot;Virtual Garden is not used, i.e., the \`runtime\` Garden cluster is also the \`target\` Garden cluster.&quot;">​</a></h2><h3 id="automounted-service-account-token" tabindex="-1">Automounted Service Account Token <a class="header-anchor" href="#automounted-service-account-token" aria-label="Permalink to &quot;Automounted Service Account Token&quot;">​</a></h3><p>The easiest way to deploy a <strong>Gardener control plane component</strong> is to not provide a <code>kubeconfig</code> at all. This way in-cluster configuration and an automounted service account token will be used. The drawback of this approach is that the automounted token will not be automatically rotated.</p><h3 id="service-account-token-volume-projection" tabindex="-1">Service Account Token Volume Projection <a class="header-anchor" href="#service-account-token-volume-projection" aria-label="Permalink to &quot;Service Account Token Volume Projection&quot;">​</a></h3><p>Another solution is to use <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection" target="_blank" rel="noreferrer">Service Account Token Volume Projection</a> combined with a <code>kubeconfig</code> referencing a token file (see the example below).</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Config</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">clusters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    certificate-authority-data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;CA-DATA&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://default.kubernetes.svc.cluster.local</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">contexts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">current-context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    tokenFile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/run/secrets/projected/serviceaccount/token</span></span></code></pre></div><p>This will allow for automatic rotation of the service account token by the <code>kubelet</code>. The configuration can be achieved by setting both <code>.Values.global.&lt;GardenerControlPlaneComponent&gt;.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.&lt;GardenerControlPlaneComponent&gt;.kubeconfig</code> in the respective chart&#39;s <code>values.yaml</code> file.</p><h2 id="virtual-garden-is-used-i-e-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster" tabindex="-1">Virtual Garden is used, i.e., the <code>runtime</code> Garden cluster is different from the <code>target</code> Garden cluster. <a class="header-anchor" href="#virtual-garden-is-used-i-e-the-runtime-garden-cluster-is-different-from-the-target-garden-cluster" aria-label="Permalink to &quot;Virtual Garden is used, i.e., the \`runtime\` Garden cluster is different from the \`target\` Garden cluster.&quot;">​</a></h2><h3 id="service-account" tabindex="-1">Service Account <a class="header-anchor" href="#service-account" aria-label="Permalink to &quot;Service Account&quot;">​</a></h3><p>The easiest way to setup the authentication is to create a service account and the respective roles will be bound to this service account in the <code>target</code> cluster. Then use the generated service account token and craft a <code>kubeconfig</code>, which will be used by the workload in the <code>runtime</code> cluster. This approach does not provide a solution for the rotation of the service account token. However, this setup can be achieved by setting <code>.Values.global.deployment.virtualGarden.enabled: true</code> and following these steps:</p><ol><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Get the service account token and craft the <code>kubeconfig</code>.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h3 id="client-certificate" tabindex="-1">Client Certificate <a class="header-anchor" href="#client-certificate" aria-label="Permalink to &quot;Client Certificate&quot;">​</a></h3><p>Another solution is to bind the roles in the <code>target</code> cluster to a <code>User</code> subject instead of a service account and use a client certificate for authentication. This approach does not provide a solution for the client certificate rotation. However, this setup can be achieved by setting both <code>.Values.global.deployment.virtualGarden.enabled: true</code> and <code>.Values.global.deployment.virtualGarden.&lt;GardenerControlPlaneComponent&gt;.user.name</code>, then following these steps:</p><ol><li>Generate a client certificate for the <code>target</code> cluster for the respective user.</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Craft a <code>kubeconfig</code> using the already generated client certificate.</li><li>Set the crafted <code>kubeconfig</code> and deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><h3 id="projected-service-account-token" tabindex="-1">Projected Service Account Token <a class="header-anchor" href="#projected-service-account-token" aria-label="Permalink to &quot;Projected Service Account Token&quot;">​</a></h3><p>This approach requires an already deployed and configured <a href="https://github.com/gardener/oidc-webhook-authenticator" target="_blank" rel="noreferrer">oidc-webhook-authenticator</a> for the <code>target</code> cluster. Also, the <code>runtime</code> cluster should be registered as a trusted identity provider in the <code>target</code> cluster. Then, projected service accounts tokens from the <code>runtime</code> cluster can be used to authenticate against the <code>target</code> cluster. The needed steps are as follows:</p><ol><li>Deploy <a href="https://github.com/gardener/oidc-webhook-authenticator" target="_blank" rel="noreferrer">OWA</a> and establish the needed trust.</li><li>Set <code>.Values.global.deployment.virtualGarden.enabled: true</code> and <code>.Values.global.deployment.virtualGarden.&lt;GardenerControlPlaneComponent&gt;.user.name</code>. <blockquote><p><strong>Note:</strong> username value will depend on the trust configuration, e.g., <code>&lt;prefix&gt;:system:serviceaccount:&lt;namespace&gt;:&lt;serviceaccount&gt;</code></p></blockquote></li><li>Set <code>.Values.global.&lt;GardenerControlPlaneComponent&gt;.serviceAccountTokenVolumeProjection.enabled: true</code> and <code>.Values.global.&lt;GardenerControlPlaneComponent&gt;.serviceAccountTokenVolumeProjection.audience</code>. <blockquote><p><strong>Note:</strong> audience value will depend on the trust configuration, e.g., <code>&lt;client-id-from-trust-config&gt;</code>.</p></blockquote></li><li>Craft a kubeconfig (see the example below).</li><li>Deploy the <code>application</code> part of the charts in the <code>target</code> cluster.</li><li>Deploy the <code>runtime</code> part of the charts in the <code>runtime</code> cluster.</li></ol><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Config</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">clusters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    certificate-authority-data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;CA-DATA&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://virtual-garden.api</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">virtual-garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">contexts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">virtual-garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">virtual-garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">virtual-garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">current-context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">virtual-garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">virtual-garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    tokenFile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/run/secrets/projected/serviceaccount/token</span></span></code></pre></div>`,21)]))}const u=s(n,[["render",r]]);export{k as __pageData,u as default};
