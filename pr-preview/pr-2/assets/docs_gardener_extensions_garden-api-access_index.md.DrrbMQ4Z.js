import{_ as e,c as i,o as a,a2 as n}from"./chunks/framework.B8WFj13S.js";const c=JSON.parse('{"title":"Access to the Garden Cluster for Extensions","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/extensions","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/extensions/garden-api-access.md","to":"garden-api-access.md"},"title":"Access to the Garden Cluster for Extensions","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/extensions/garden-api-access/index.md","filePath":"docs/gardener/extensions/garden-api-access.md","lastUpdated":null}'),t={name:"docs/gardener/extensions/garden-api-access/index.md"};function l(h,s,r,p,d,k){return a(),i("div",null,s[0]||(s[0]=[n(`<h1 id="access-to-the-garden-cluster-for-extensions" tabindex="-1">Access to the Garden Cluster for Extensions <a class="header-anchor" href="#access-to-the-garden-cluster-for-extensions" aria-label="Permalink to &quot;Access to the Garden Cluster for Extensions&quot;">​</a></h1><p>Gardener offers different means to provide or equip registered extensions with a kubeconfig which may be used to connect to the garden cluster.</p><h2 id="admission-controllers" tabindex="-1">Admission Controllers <a class="header-anchor" href="#admission-controllers" aria-label="Permalink to &quot;Admission Controllers&quot;">​</a></h2><p>For extensions with an admission controller deployment, <code>gardener-operator</code> injects a token-based kubeconfig as a volume and volume mount. The token is valid for <code>12h</code>, automatically renewed, and associated with a dedicated <code>ServiceAccount</code> in the garden cluster. The path to this kubeconfig is revealed under the <code>GARDEN_KUBECONFIG</code> environment variable, also added to the pod spec(s).</p><h2 id="extensions-on-seed-clusters" tabindex="-1">Extensions on <code>Seed</code> Clusters <a class="header-anchor" href="#extensions-on-seed-clusters" aria-label="Permalink to &quot;Extensions on \`Seed\` Clusters&quot;">​</a></h2><p>Extensions that are installed on seed clusters via a <code>ControllerInstallation</code> can request <code>gardenlet</code> to inject a kubeconfig and a token for the garden cluster.</p><p>In order to do so, <code>injectGardenKubeconfig</code> must be set to <code>true</code> in the referenced <code>ControllerDeployment</code>. If it should still be disabled for an individual workload resource (<code>Deployment</code>, <code>StatefulSet</code>, etc.), they must be labeled with <code>extensions.gardener.cloud/inject-garden-kubeconfig=false</code>.</p><p>When enabled, extensions can then simply read the kubeconfig file specified by the <code>GARDEN_KUBECONFIG</code> environment variable to create a garden cluster client. With this, they use a short-lived token (valid for <code>12h</code>) associated with a dedicated <code>ServiceAccount</code> in the <code>seed-&lt;seed-name&gt;</code> namespace to securely access the garden cluster. The used <code>ServiceAccounts</code> are granted permissions in the garden cluster similar to gardenlet clients.</p><h3 id="background" tabindex="-1">Background <a class="header-anchor" href="#background" aria-label="Permalink to &quot;Background&quot;">​</a></h3><p>Historically, <code>gardenlet</code> has been the only component running in the seed cluster that has access to both the seed cluster and the garden cluster. Accordingly, extensions running on the seed cluster didn&#39;t have access to the garden cluster.</p><p>Starting from Gardener <a href="https://github.com/gardener/gardener/releases/v1.74.0" target="_blank" rel="noreferrer"><code>v1.74.0</code></a>, there is a new mechanism for components running on seed clusters to get access to the garden cluster. For this, <code>gardenlet</code> runs an instance of the <a href="documentation/pr-preview/pr-2/docs/gardener/concepts/gardenlet/#tokenrequestor-controller"><code>TokenRequestor</code></a> for requesting tokens that can be used to communicate with the garden cluster.</p><h3 id="using-gardenlet-managed-garden-access" tabindex="-1">Using Gardenlet-Managed Garden Access <a class="header-anchor" href="#using-gardenlet-managed-garden-access" aria-label="Permalink to &quot;Using Gardenlet-Managed Garden Access&quot;">​</a></h3><p>By default, extensions are equipped with secure access to the garden cluster using a dedicated <code>ServiceAccount</code> without requiring any additional action. They can simply read the file specified by the <code>GARDEN_KUBECONFIG</code> and construct a garden client with it.</p><p>When installing a <a href="documentation/pr-preview/pr-2/docs/gardener/extensions/registration/#deploying-extension-controllers"><code>ControllerInstallation</code></a>, gardenlet creates two secrets in the installation&#39;s namespace: a generic garden kubeconfig (<code>generic-garden-kubeconfig-&lt;hash&gt;</code>) and a garden access secret (<code>garden-access-extension</code>). Note that the <code>ServiceAccount</code> created based on this access secret will be created in the respective <code>seed-*</code> namespace in the garden cluster and labelled with <code>controllerregistration.core.gardener.cloud/name=&lt;name&gt;</code>.</p><p>Additionally, gardenlet injects <code>volume</code>, <code>volumeMounts</code>, and two environment variables into all (init) containers in all objects in the <code>apps</code> and <code>batch</code> API groups:</p><ul><li><code>GARDEN_KUBECONFIG</code>: points to the path where the generic garden kubeconfig is mounted.</li><li><code>SEED_NAME</code>: set to the name of the <code>Seed</code> where the extension is installed. This is useful for restricting watches in the garden cluster to relevant objects.</li></ul><p>If an object already contains the <code>GARDEN_KUBECONFIG</code> environment variable, it is not overwritten and injection of <code>volume</code> and <code>volumeMounts</code> is skipped.</p><p>For example, a <code>Deployment</code> deployed via a <code>ControllerInstallation</code> will be mutated as follows:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-extension-provider-local</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    reference.resources.gardener.cloud/secret-795f7ca6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-access-extension</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    reference.resources.gardener.cloud/secret-d5f5a834</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">generic-garden-kubeconfig-81fb3a88</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  template</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        reference.resources.gardener.cloud/secret-795f7ca6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-access-extension</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        reference.resources.gardener.cloud/secret-d5f5a834</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">generic-garden-kubeconfig-81fb3a88</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      containers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-extension-provider-local</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">GARDEN_KUBECONFIG</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/run/secrets/gardener.cloud/garden/generic-kubeconfig/kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">SEED_NAME</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">local</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        volumeMounts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">mountPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/run/secrets/gardener.cloud/garden/generic-kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          readOnly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        projected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          defaultMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">420</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          sources</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">secret</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              items</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">                path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">generic-garden-kubeconfig-81fb3a88</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">secret</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              items</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">                path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-access-extension</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span></code></pre></div><p>The generic garden kubeconfig will look like this:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Config</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">clusters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    certificate-authority-data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">LS0t...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://garden.local.gardener.cloud:6443</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">contexts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">extension</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">current-context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">extension</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    tokenFile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/run/secrets/gardener.cloud/garden/generic-kubeconfig/token</span></span></code></pre></div><h3 id="manually-requesting-a-token-for-the-garden-cluster" tabindex="-1">Manually Requesting a Token for the Garden Cluster <a class="header-anchor" href="#manually-requesting-a-token-for-the-garden-cluster" aria-label="Permalink to &quot;Manually Requesting a Token for the Garden Cluster&quot;">​</a></h3><p>Seed components that need to communicate with the garden cluster can request a token in the garden cluster by creating a garden access secret. This secret has to be labelled with <code>resources.gardener.cloud/purpose=token-requestor</code> and <code>resources.gardener.cloud/class=garden</code>, e.g.:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Secret</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-access-example</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">example</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    resources.gardener.cloud/purpose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">token-requestor</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    resources.gardener.cloud/class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    serviceaccount.resources.gardener.cloud/name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">example</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Opaque</span></span></code></pre></div><p>This will instruct gardenlet to create a new <code>ServiceAccount</code> named <code>example</code> in its own <code>seed-&lt;seed-name&gt;</code> namespace in the garden cluster, request a token for it, and populate the token in the secret&#39;s data under the <code>token</code> key.</p><h3 id="permissions-in-the-garden-cluster" tabindex="-1">Permissions in the Garden Cluster <a class="header-anchor" href="#permissions-in-the-garden-cluster" aria-label="Permalink to &quot;Permissions in the Garden Cluster&quot;">​</a></h3><p>Both the <a href="documentation/pr-preview/pr-2/docs/gardener/deployment/gardenlet_api_access/"><code>SeedAuthorizer</code> and the <code>SeedRestriction</code> plugin</a> handle extensions clients and generally grant the same permissions in the garden cluster to them as to gardenlet clients. With this, extensions are restricted to work with objects in the garden cluster that are related to seed they are running one just like gardenlet. Note that if the plugins are not enabled, extension clients are only granted read access to global resources like <code>CloudProfiles</code> (this is granted to all authenticated users). There are a few exceptions to the granted permissions as documented <a href="documentation/pr-preview/pr-2/docs/gardener/deployment/gardenlet_api_access/#rule-exceptions-for-extension-clients">here</a>.</p><h3 id="additional-permissions" tabindex="-1">Additional Permissions <a class="header-anchor" href="#additional-permissions" aria-label="Permalink to &quot;Additional Permissions&quot;">​</a></h3><p>If an extension needs access to additional resources in the garden cluster (e.g., extension-specific custom resources), permissions need to be granted via the usual RBAC means. Let&#39;s consider the following example: An extension requires the privileges to create <a href="https://kubernetes.io/docs/reference/kubernetes-api/authorization-resources/subject-access-review-v1/" target="_blank" rel="noreferrer"><code>authorization.k8s.io/v1.SubjectAccessReview</code></a>s (which is not covered by the &quot;default&quot; permissions mentioned above). This requires a human Gardener operator to create a <code>ClusterRole</code> in the garden cluster with the needed rules:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rbac.authorization.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ClusterRole</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">extension-create-subjectaccessreviews</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    authorization.gardener.cloud/extensions-serviceaccount-selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;{&quot;matchLabels&quot;:{&quot;controllerregistration.core.gardener.cloud/name&quot;:&quot;&lt;extension-name&gt;&quot;}}&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    authorization.gardener.cloud/custom-extensions-permissions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">rules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiGroups</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  resources</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">subjectaccessreviews</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  verbs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">create</span></span></code></pre></div><p>Note the label <code>authorization.gardener.cloud/extensions-serviceaccount-selector</code> which contains a label selector for <code>ServiceAccount</code>s.</p><p>There is a controller part of <code>gardener-controller-manager</code> which takes care of maintaining the respective <code>ClusterRoleBinding</code> resources. It binds all <code>ServiceAccount</code>s in the seed namespaces in the garden cluster (i.e., all extension clients) whose labels match. You can read more about this controller <a href="documentation/pr-preview/pr-2/docs/gardener/concepts/controller-manager/#-extension-clusterrole--reconciler">here</a>.</p><h4 id="custom-permissions" tabindex="-1">Custom Permissions <a class="header-anchor" href="#custom-permissions" aria-label="Permalink to &quot;Custom Permissions&quot;">​</a></h4><p>If an extension wants to create a dedicated <code>ServiceAccount</code> for accessing the garden cluster <strong>without</strong> automatically inheriting all permissions of the gardenlet, it first needs to create a garden access secret in its extension namespace in the seed cluster:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Secret</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">my-custom-component</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;extension-namespace&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    resources.gardener.cloud/purpose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">token-requestor</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    resources.gardener.cloud/class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    serviceaccount.resources.gardener.cloud/name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">my-custom-component-extension-foo</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    serviceaccount.resources.gardener.cloud/labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;{&quot;foo&quot;:&quot;bar}&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Opaque</span></span></code></pre></div><p>❗️<strong>️Do not prefix the service account name with <code>extension-</code> to prevent inheriting the gardenlet permissions!</strong> It is still recommended to add the extension name (e.g., as a suffix) for easier identification where this <code>ServiceAccount</code> comes from.</p><p>Next, you can follow the same approach <a href="documentation/pr-preview/pr-2/docs/gardener/extensions/garden-api-access/#additional-permissions">described above</a>. However, the <code>authorization.gardener.cloud/extensions-serviceaccount-selector</code> annotation should <strong>not</strong> contain <code>controllerregistration.core.gardener.cloud/name=&lt;extension-name&gt;</code> but rather custom labels, e.g. <code>foo=bar</code>.</p><p>This way, the created <code>ServiceAccount</code> will only get the permissions of <a href="documentation/pr-preview/pr-2/docs/gardener/extensions/garden-api-access/#additional-permissions">above <code>ClusterRole</code></a> and nothing else.</p><h3 id="renewing-all-garden-access-secrets" tabindex="-1">Renewing All Garden Access Secrets <a class="header-anchor" href="#renewing-all-garden-access-secrets" aria-label="Permalink to &quot;Renewing All Garden Access Secrets&quot;">​</a></h3><p>Operators can trigger an automatic renewal of all garden access secrets in a given <code>Seed</code> and their requested <code>ServiceAccount</code> tokens, e.g., when rotating the garden cluster&#39;s <code>ServiceAccount</code> signing key. For this, the <code>Seed</code> has to be annotated with <code>gardener.cloud/operation=renew-garden-access-secrets</code>.</p>`,40)]))}const E=e(t,[["render",l]]);export{c as __pageData,E as default};
