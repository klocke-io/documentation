import{_ as s,c as i,o as a,a2 as n}from"./chunks/framework.B8WFj13S.js";const t="/documentation/pr-preview/pr-2/assets/resource-manager-projected-token-controlplane-to-shoot-apiserver.BMegY0wT.jpg",l="/documentation/pr-preview/pr-2/assets/resource-manager-projected-token-shoot-to-shoot-apiserver.CqJQ_Qtt.jpg",E=JSON.parse('{"title":"Gardener Resource Manager","description":"Set of controllers with different responsibilities running once per seed and once per shoot","frontmatter":{"description":"Set of controllers with different responsibilities running once per seed and once per shoot","github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/concepts","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/concepts/resource-manager.md","to":"resource-manager.md"},"title":"Gardener Resource Manager","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/concepts/resource-manager/index.md","filePath":"docs/gardener/concepts/resource-manager.md","lastUpdated":null}'),o={name:"docs/gardener/concepts/resource-manager/index.md"};function r(h,e,p,d,c,k){return a(),i("div",null,e[0]||(e[0]=[n(`<h1 id="gardener-resource-manager" tabindex="-1">Gardener Resource Manager <a class="header-anchor" href="#gardener-resource-manager" aria-label="Permalink to &quot;Gardener Resource Manager&quot;">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>Gardener heavily utilizes Kubernetes resources for its operations. Therefore, any unintentional changes to those resources by a user or operator could lead to problems ranging from failure of a shoot, seed, or even the whole landscape. The <code>gardener-resource-manager</code> solves this problem by providing a way to define the desired state of a Kubernetes resource in a target cluster. It reverts any unexpected changes applied to it.</p><p>Apart from this functionality, <code>gardener-resource-manager</code> has evolved to a more generic component comprising several controllers and webhook handlers. It is deployed by gardenlet once per seed (in the <code>garden</code> namespace) and once per shoot (in the respective shoot namespaces in the seed).</p><h2 id="component-configuration" tabindex="-1">Component Configuration <a class="header-anchor" href="#component-configuration" aria-label="Permalink to &quot;Component Configuration&quot;">​</a></h2><p>Similar to other Gardener components, the <code>gardener-resource-manager</code> uses a so-called component configuration file. It allows specifying certain central settings like log level and formatting, client connection configuration, server ports and bind addresses, etc. In addition, controllers and webhooks can be configured and sometimes even disabled.</p><p>Note that the very basic <code>ManagedResource</code> and health controllers cannot be disabled.</p><p>You can find an example configuration file <a href="https://github.com/gardener/gardener/blob/master/example/resource-manager/10-componentconfig.yaml" target="_blank" rel="noreferrer">here</a>.</p><h2 id="controllers" tabindex="-1">Controllers <a class="header-anchor" href="#controllers" aria-label="Permalink to &quot;Controllers&quot;">​</a></h2><h3 id="managedresource-controller" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/managedresource" target="_blank" rel="noreferrer"><code>ManagedResource</code> Controller</a> <a class="header-anchor" href="#managedresource-controller" aria-label="Permalink to &quot;[\`ManagedResource\` Controller](https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/managedresource)&quot;">​</a></h3><p>This controller watches custom objects called <code>ManagedResource</code>s in the <code>resources.gardener.cloud/v1alpha1</code> API group. These objects contain references to secrets, which itself contain the resources to be managed. The reason why a <code>Secret</code> is used to store the resources is that they could contain confidential information like credentials.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Secret</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">managedresource-example1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Opaque</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  objects.yaml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">YXBpVmVyc2lvbjogdjEKa2luZDogQ29uZmlnTWFwCm1ldGFkYXRhOgogIG5hbWU6IHRlc3QtMTIzNAogIG5hbWVzcGFjZTogZGVmYXVsdAotLS0KYXBpVmVyc2lvbjogdjEKa2luZDogQ29uZmlnTWFwCm1ldGFkYXRhOgogIG5hbWU6IHRlc3QtNTY3OAogIG5hbWVzcGFjZTogZGVmYXVsdAo=</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # apiVersion: v1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # kind: ConfigMap</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # metadata:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   name: test-1234</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   namespace: default</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ---</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # apiVersion: v1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # kind: ConfigMap</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # metadata:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   name: test-5678</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   namespace: default</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">resources.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ManagedResource</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">example</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  secretRefs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">managedresource-example1</span></span></code></pre></div><p>In the above example, the controller creates two <code>ConfigMap</code>s in the <code>default</code> namespace. When a user is manually modifying them, they will be reconciled back to the desired state stored in the <code>managedresource-example</code> secret.</p><p>It is also possible to inject labels into all the resources:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Secret</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">managedresource-example2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Opaque</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  other-objects.yaml</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">YXBpVmVyc2lvbjogYXBwcy92MSAjIGZvciB2ZXJzaW9ucyBiZWZvcmUgMS45LjAgdXNlIGFwcHMvdjFiZXRhMgpraW5kOiBEZXBsb3ltZW50Cm1ldGFkYXRhOgogIG5hbWU6IG5naW54LWRlcGxveW1lbnQKc3BlYzoKICBzZWxlY3RvcjoKICAgIG1hdGNoTGFiZWxzOgogICAgICBhcHA6IG5naW54CiAgcmVwbGljYXM6IDIgIyB0ZWxscyBkZXBsb3ltZW50IHRvIHJ1biAyIHBvZHMgbWF0Y2hpbmcgdGhlIHRlbXBsYXRlCiAgdGVtcGxhdGU6CiAgICBtZXRhZGF0YToKICAgICAgbGFiZWxzOgogICAgICAgIGFwcDogbmdpbngKICAgIHNwZWM6CiAgICAgIGNvbnRhaW5lcnM6CiAgICAgIC0gbmFtZTogbmdpbngKICAgICAgICBpbWFnZTogbmdpbng6MS43LjkKICAgICAgICBwb3J0czoKICAgICAgICAtIGNvbnRhaW5lclBvcnQ6IDgwCg==</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # apiVersion: apps/v1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # kind: Deployment</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # metadata:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   name: nginx-deployment</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # spec:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   selector:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #     matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #       app: nginx</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   replicas: 2 # tells deployment to run 2 pods matching the template</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   template:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #     metadata:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #       labels:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #         app: nginx</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #     spec:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #       containers:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #       - name: nginx</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #         image: nginx:1.7.9</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #         ports:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #         - containerPort: 80</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">resources.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ManagedResource</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">example</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  secretRefs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">managedresource-example2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  injectLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bar</span></span></code></pre></div><p>In this example, the label <code>foo=bar</code> will be injected into the <code>Deployment</code>, as well as into all created <code>ReplicaSet</code>s and <code>Pod</code>s.</p><h4 id="preventing-reconciliations" tabindex="-1">Preventing Reconciliations <a class="header-anchor" href="#preventing-reconciliations" aria-label="Permalink to &quot;Preventing Reconciliations&quot;">​</a></h4><p>If a <code>ManagedResource</code> is annotated with <code>resources.gardener.cloud/ignore=true</code>, then it will be skipped entirely by the controller (no reconciliations or deletions of managed resources at all). However, when the <code>ManagedResource</code> itself is deleted (for example when a shoot is deleted), then the annotation is not respected and all resources will be deleted as usual. This feature can be helpful to temporarily patch/change resources managed as part of such <code>ManagedResource</code>. Condition checks will be skipped for such <code>ManagedResource</code>s.</p><h4 id="modes" tabindex="-1">Modes <a class="header-anchor" href="#modes" aria-label="Permalink to &quot;Modes&quot;">​</a></h4><p>The <code>gardener-resource-manager</code> can manage a resource in the following supported modes:</p><ul><li><code>Ignore</code><ul><li>The corresponding resource is removed from the <code>ManagedResource</code> status (<code>.status.resources</code>). No action is performed on the cluster.</li><li>The resource is no longer &quot;managed&quot; (updated or deleted).</li><li>The primary use case is a migration of a resource from one <code>ManagedResource</code> to another one.</li></ul></li></ul><p>The mode for a resource can be specified with the <code>resources.gardener.cloud/mode</code> annotation. The annotation should be specified in the encoded resource manifest in the Secret that is referenced by the <code>ManagedResource</code>.</p><h4 id="resource-class-and-reconciliation-scope" tabindex="-1">Resource Class and Reconciliation Scope <a class="header-anchor" href="#resource-class-and-reconciliation-scope" aria-label="Permalink to &quot;Resource Class and Reconciliation Scope&quot;">​</a></h4><p>By default, the <code>gardener-resource-manager</code> controller watches for <code>ManagedResource</code>s in all namespaces. The <code>.sourceClientConnection.namespace</code> field in the component configuration restricts the watch to <code>ManagedResource</code>s in a single namespace only. Note that this setting also affects all other controllers and webhooks since it&#39;s a central configuration.</p><p>A <code>ManagedResource</code> has an optional <code>.spec.class</code> field that allows it to indicate that it belongs to a given class of resources. The <code>.controllers.resourceClass</code> field in the component configuration restricts the watch to <code>ManagedResource</code>s with the given <code>.spec.class</code>. A default class is assumed if no class is specified.</p><p>For instance, the <code>gardener-resource-manager</code> which is deployed in the Shoot’s control plane namespace in the Seed does not specify a <code>.spec.class</code> and watches only for resources in the control plane namespace by specifying it in the <code>.sourceClientConnection.namespace</code> field.</p><p>If the <code>.spec.class</code> changes this means that the resources have to be handled by a different Gardener Resource Manager. That is achieved by:</p><ol><li>Cleaning all referenced resources by the Gardener Resource Manager that was responsible for the old class in its target cluster.</li><li>Creating all referenced resources by the Gardener Resource Manager that is responsible for the new class in its target cluster.</li></ol><h4 id="conditions" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/health" target="_blank" rel="noreferrer">Conditions</a> <a class="header-anchor" href="#conditions" aria-label="Permalink to &quot;[Conditions](https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/health)&quot;">​</a></h4><p>A <code>ManagedResource</code> has a <code>ManagedResourceStatus</code>, which has an array of Conditions. Conditions currently include:</p><table tabindex="0"><thead><tr><th>Condition</th><th>Description</th></tr></thead><tbody><tr><td><code>ResourcesApplied</code></td><td><code>True</code> if all resources are applied to the target cluster</td></tr><tr><td><code>ResourcesHealthy</code></td><td><code>True</code> if all resources are present and healthy</td></tr><tr><td><code>ResourcesProgressing</code></td><td><code>False</code> if all resources have been fully rolled out</td></tr></tbody></table><p><code>ResourcesApplied</code> may be <code>False</code> when:</p><ul><li>the resource <code>apiVersion</code> is not known to the target cluster</li><li>the resource spec is invalid (for example the label value does not match the required regex for it)</li><li>...</li></ul><p><code>ResourcesHealthy</code> may be <code>False</code> when:</p><ul><li>the resource is not found</li><li>the resource is a Deployment and the Deployment does not have the minimum availability.</li><li>...</li></ul><p><code>ResourcesProgressing</code> may be <code>True</code> when:</p><ul><li>a <code>Deployment</code>, <code>StatefulSet</code> or <code>DaemonSet</code> has not been fully rolled out yet, i.e. not all replicas have been updated with the latest changes to <code>spec.template</code>.</li><li>there are still old <code>Pod</code>s belonging to an older <code>ReplicaSet</code> of a <code>Deployment</code> which are not terminated yet.</li></ul><p>Each Kubernetes resources has different notion for being healthy. For example, a Deployment is considered healthy if the controller observed its current revision and if the number of updated replicas is equal to the number of replicas.</p><p>The following <code>status.conditions</code> section describes a healthy <code>ManagedResource</code>:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">conditions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">lastTransitionTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2022-05-03T10:55:39Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  lastUpdateTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2022-05-03T10:55:39Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">All resources are healthy.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  reason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ResourcesHealthy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;True&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ResourcesHealthy</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">lastTransitionTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2022-05-03T10:55:36Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  lastUpdateTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2022-05-03T10:55:36Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">All resources have been fully rolled out.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  reason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ResourcesRolledOut</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;False&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ResourcesProgressing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">lastTransitionTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2022-05-03T10:55:18Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  lastUpdateTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2022-05-03T10:55:18Z&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">All resources are applied.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  reason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ApplySucceeded</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;True&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ResourcesApplied</span></span></code></pre></div><h4 id="ignoring-updates" tabindex="-1">Ignoring Updates <a class="header-anchor" href="#ignoring-updates" aria-label="Permalink to &quot;Ignoring Updates&quot;">​</a></h4><p>In some cases, it is not desirable to update or re-apply some of the cluster components (for example, if customization is required or needs to be applied by the end-user). For these resources, the annotation &quot;resources.gardener.cloud/ignore&quot; needs to be set to &quot;true&quot; or a truthy value (Truthy values are &quot;1&quot;, &quot;t&quot;, &quot;T&quot;, &quot;true&quot;, &quot;TRUE&quot;, &quot;True&quot;) in the corresponding managed resource secrets. This can be done from the components that create the managed resource secrets, for example Gardener extensions or Gardener. Once this is done, the resource will be initially created and later ignored during reconciliation.</p><h4 id="finalizing-deletion-of-resources-after-grace-period" tabindex="-1">Finalizing Deletion of Resources After Grace Period <a class="header-anchor" href="#finalizing-deletion-of-resources-after-grace-period" aria-label="Permalink to &quot;Finalizing Deletion of Resources After Grace Period&quot;">​</a></h4><p>When a <code>ManagedResource</code> is deleted, the controller deletes all managed resources from the target cluster. In case the resources still have entries in their <code>.metadata.finalizers[]</code> list, they will remain stuck in the system until another entity removes the finalizers. If you want the controller to forcefully finalize the deletion after some grace period (i.e., setting <code>.metadata.finalizers=null</code>), you can annotate the managed resources with <code>resources.gardener.cloud/finalize-deletion-after=&lt;duration&gt;</code>, e.g., <code>resources.gardener.cloud/finalize-deletion-after=1h</code>.</p><h4 id="preserving-replicas-or-resources-in-workload-resources" tabindex="-1">Preserving <code>replicas</code> or <code>resources</code> in Workload Resources <a class="header-anchor" href="#preserving-replicas-or-resources-in-workload-resources" aria-label="Permalink to &quot;Preserving \`replicas\` or \`resources\` in Workload Resources&quot;">​</a></h4><p>The objects which are part of the <code>ManagedResource</code> can be annotated with:</p><ul><li><code>resources.gardener.cloud/preserve-replicas=true</code> in case the <code>.spec.replicas</code> field of workload resources like <code>Deployment</code>s, <code>StatefulSet</code>s, etc., shall be preserved during updates.</li><li><code>resources.gardener.cloud/preserve-resources=true</code> in case the <code>.spec.containers[*].resources</code> fields of all containers of workload resources like <code>Deployment</code>s, <code>StatefulSet</code>s, etc., shall be preserved during updates.</li></ul><blockquote><p>This can be useful if there are non-standard horizontal/vertical auto-scaling mechanisms in place. Standard mechanisms like <code>HorizontalPodAutoscaler</code> or <code>VerticalPodAutoscaler</code> will be auto-recognized by <code>gardener-resource-manager</code>, i.e., in such cases the annotations are not needed.</p></blockquote><h4 id="origin" tabindex="-1">Origin <a class="header-anchor" href="#origin" aria-label="Permalink to &quot;Origin&quot;">​</a></h4><p>All the objects managed by the resource manager get a dedicated annotation <code>resources.gardener.cloud/origin</code> describing the <code>ManagedResource</code> object that describes this object. The default format is <code>&lt;namespace&gt;/&lt;objectname&gt;</code>.</p><p>In multi-cluster scenarios (the <code>ManagedResource</code> objects are maintained in a cluster different from the one the described objects are managed), it might be useful to include the cluster identity, as well.</p><p>This can be enforced by setting the <code>.controllers.clusterID</code> field in the component configuration. Here, several possibilities are supported:</p><ul><li>given a direct value: use this as id for the source cluster.</li><li><code>&lt;cluster&gt;</code>: read the cluster identity from a <code>cluster-identity</code> config map in the <code>kube-system</code> namespace (attribute <code>cluster-identity</code>). This is automatically maintained in all clusters managed or involved in a gardener landscape.</li><li><code>&lt;default&gt;</code>: try to read the cluster identity from the config map. If not found, no identity is used.</li><li>empty string: no cluster identity is used (completely cluster local scenarios).</li></ul><p>By default, cluster id is not used. If cluster id is specified, the format is <code>&lt;cluster id&gt;:&lt;namespace&gt;/&lt;objectname&gt;</code>.</p><p>In addition to the origin annotation, all objects managed by the resource manager get a dedicated label <code>resources.gardener.cloud/managed-by</code>. This label can be used to describe these objects with a <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/" target="_blank" rel="noreferrer">selector</a>. By default it is set to &quot;gardener&quot;, but this can be overwritten by setting the <code>.conrollers.managedResources.managedByLabelValue</code> field in the component configuration.</p><h4 id="compression" tabindex="-1">Compression <a class="header-anchor" href="#compression" aria-label="Permalink to &quot;Compression&quot;">​</a></h4><p>The number and size of manifests for a <code>ManagedResource</code> can accumulate to a considerable amount which leads to increased <code>Secret</code> data. A decent compression algorithm helps to reduce the footprint of such <code>Secret</code>s and the load they put on <code>etcd</code>, the <code>kube-apiserver</code>, and client caches. We found <a href="https://github.com/google/brotli" target="_blank" rel="noreferrer">Brotli</a> to be a suitable candidate for most use cases (see comparison table <a href="https://github.com/gardener/gardener/pull/9868" target="_blank" rel="noreferrer">here</a>). When the <code>gardener-resource-manager</code> detects a data key with the known suffix <code>.br</code>, it automatically un-compresses the data first before processing the contained manifest.</p><p>To decompress a ManagedResource Secret use:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>kubectl -n &lt;namespace&gt; get secret &lt;managed-resource-secret&gt; -o jsonpath=&#39;{.data.data\\.yaml\\.br}&#39; | base64 -d | brotli -d</span></span></code></pre></div><p>On macOS, the brotli binary can be installed via homebrew using the <a href="https://formulae.brew.sh/formula/brotli" target="_blank" rel="noreferrer">brotli formula</a>.</p><h3 id="health-controller" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/health" target="_blank" rel="noreferrer"><code>health</code> Controller</a> <a class="header-anchor" href="#health-controller" aria-label="Permalink to &quot;[\`health\` Controller](https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/health)&quot;">​</a></h3><p>This controller processes <code>ManagedResource</code>s that were reconciled by the main <a href="documentation/pr-preview/pr-2/docs/gardener/concepts/resource-manager/#managedResource-controller">ManagedResource Controller</a> at least once. Its main job is to perform checks for maintaining the well <a href="documentation/pr-preview/pr-2/docs/gardener/concepts/resource-manager/#conditions">known conditions</a> <code>ResourcesHealthy</code> and <code>ResourcesProgressing</code>.</p><h4 id="progressing-checks" tabindex="-1">Progressing Checks <a class="header-anchor" href="#progressing-checks" aria-label="Permalink to &quot;Progressing Checks&quot;">​</a></h4><p>In Kubernetes, applied changes must usually be rolled out first, e.g. when changing the base image in a <code>Deployment</code>. Progressing checks detect ongoing roll-outs and report them in the <code>ResourcesProgressing</code> condition of the corresponding <code>ManagedResource</code>.</p><p>The following object kinds are considered for progressing checks:</p><ul><li><code>DaemonSet</code></li><li><code>Deployment</code></li><li><code>StatefulSet</code></li><li><a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank" rel="noreferrer"><code>Prometheus</code></a></li><li><a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank" rel="noreferrer"><code>Alertmanager</code></a></li><li><a href="https://github.com/gardener/cert-management" target="_blank" rel="noreferrer"><code>Certificate</code></a></li><li><a href="https://github.com/gardener/cert-management" target="_blank" rel="noreferrer"><code>Issuer</code></a></li></ul><h4 id="health-checks" tabindex="-1">Health Checks <a class="header-anchor" href="#health-checks" aria-label="Permalink to &quot;Health Checks&quot;">​</a></h4><p><code>gardener-resource-manager</code> can evaluate the health of specific resources, often by consulting their conditions. Health check results are regularly updated in the <code>ResourcesHealthy</code> condition of the corresponding <code>ManagedResource</code>.</p><p>The following object kinds are considered for health checks:</p><ul><li><code>CustomResourceDefinition</code></li><li><code>DaemonSet</code></li><li><code>Deployment</code></li><li><code>Job</code></li><li><code>Pod</code></li><li><code>ReplicaSet</code></li><li><code>ReplicationController</code></li><li><code>Service</code></li><li><code>StatefulSet</code></li><li><a href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler" target="_blank" rel="noreferrer"><code>VerticalPodAutoscaler</code></a></li><li><a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank" rel="noreferrer"><code>Prometheus</code></a></li><li><a href="https://github.com/prometheus-operator/prometheus-operator" target="_blank" rel="noreferrer"><code>Alertmanager</code></a></li><li><a href="https://github.com/gardener/cert-management" target="_blank" rel="noreferrer"><code>Certificate</code></a></li><li><a href="https://github.com/gardener/cert-management" target="_blank" rel="noreferrer"><code>Issuer</code></a></li></ul><h4 id="skipping-health-check" tabindex="-1">Skipping Health Check <a class="header-anchor" href="#skipping-health-check" aria-label="Permalink to &quot;Skipping Health Check&quot;">​</a></h4><p>If a resource owned by a <code>ManagedResource</code> is annotated with <code>resources.gardener.cloud/skip-health-check=true</code>, then the resource will be skipped during health checks by the <code>health</code> controller. The <code>ManagedResource</code> conditions will not reflect the health condition of this resource anymore. The <code>ResourcesProgressing</code> condition will also be set to <code>False</code>.</p><h3 id="garbage-collector-for-immutable-configmaps-secrets" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/garbagecollector" target="_blank" rel="noreferrer">Garbage Collector For Immutable <code>ConfigMap</code>s/<code>Secret</code>s</a> <a class="header-anchor" href="#garbage-collector-for-immutable-configmaps-secrets" aria-label="Permalink to &quot;[Garbage Collector For Immutable \`ConfigMap\`s/\`Secret\`s](https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/garbagecollector)&quot;">​</a></h3><p>In Kubernetes, workload resources (e.g., <code>Pod</code>s) can mount <code>ConfigMap</code>s or <code>Secret</code>s or reference them via environment variables in containers. Typically, when the content of such a <code>ConfigMap</code>/<code>Secret</code> gets changed, then the respective workload is usually not dynamically reloading the configuration, i.e., a restart is required. The most commonly used approach is probably having the so-called <a href="https://helm.sh/docs/howto/charts_tips_and_tricks/#automatically-roll-deployments" target="_blank" rel="noreferrer">checksum annotations in the pod template</a>, which makes Kubernetes recreate the pod if the checksum changes. However, it has the downside that old, still running versions of the workload might not be able to properly work with the already updated content in the <code>ConfigMap</code>/<code>Secret</code>, potentially causing application outages.</p><p>In order to protect users from such outages (and also to improve the performance of the cluster), the Kubernetes community provides the <a href="https://kubernetes.io/docs/concepts/configuration/configmap/#configmap-immutable" target="_blank" rel="noreferrer">&quot;immutable <code>ConfigMap</code>s/<code>Secret</code>s feature&quot;</a>. Enabling immutability requires <code>ConfigMap</code>s/<code>Secret</code>s to have unique names. Having unique names requires the client to delete <code>ConfigMap</code>s/<code>Secret</code>s no longer in use.</p><p>In order to provide a similarly lightweight experience for clients (compared to the well-established checksum annotation approach), the <code>gardener-resource-manager</code> features an optional garbage collector controller (disabled by default). The purpose of this controller is cleaning up such immutable <code>ConfigMap</code>s/<code>Secret</code>s if they are no longer in use.</p><h4 id="how-does-the-garbage-collector-work" tabindex="-1">How Does the Garbage Collector Work? <a class="header-anchor" href="#how-does-the-garbage-collector-work" aria-label="Permalink to &quot;How Does the Garbage Collector Work?&quot;">​</a></h4><p>The following algorithm is implemented in the GC controller:</p><ol><li>List all <code>ConfigMap</code>s and <code>Secret</code>s labeled with <code>resources.gardener.cloud/garbage-collectable-reference=true</code>.</li><li>List all <code>Deployment</code>s, <code>StatefulSet</code>s, <code>DaemonSet</code>s, <code>Job</code>s, <code>CronJob</code>s, <code>Pod</code>s, <code>ManagedResource</code>s and for each of them: <ul><li>iterate over the <code>.metadata.annotations</code> and for each of them: <ul><li>If the annotation key follows the <code>reference.resources.gardener.cloud/{configmap,secret}-&lt;hash&gt;</code> scheme and the value equals <code>&lt;name&gt;</code>, then consider it as &quot;in-use&quot;.</li></ul></li></ul></li><li>Delete all <code>ConfigMap</code>s and <code>Secret</code>s not considered as &quot;in-use&quot;.</li></ol><p>Consequently, clients need to:</p><ol><li><p>Create immutable <code>ConfigMap</code>s/<code>Secret</code>s with unique names (e.g., a checksum suffix based on the <code>.data</code>).</p></li><li><p>Label such <code>ConfigMap</code>s/<code>Secret</code>s with <code>resources.gardener.cloud/garbage-collectable-reference=true</code>.</p></li><li><p>Annotate their workload resources with <code>reference.resources.gardener.cloud/{configmap,secret}-&lt;hash&gt;=&lt;name&gt;</code> for all <code>ConfigMap</code>s/<code>Secret</code>s used by the containers of the respective <code>Pod</code>s.</p><p>⚠️ Add such annotations to <code>.metadata.annotations</code>, as well as to all templates of other resources (e.g., <code>.spec.template.metadata.annotations</code> in <code>Deployment</code>s or <code>.spec.jobTemplate.metadata.annotations</code> and <code>.spec.jobTemplate.spec.template.metadata.annotations</code> for <code>CronJob</code>s. This ensures that the GC controller does not unintentionally consider <code>ConfigMap</code>s/<code>Secret</code>s as &quot;not in use&quot; just because there isn&#39;t a <code>Pod</code> referencing them anymore (e.g., they could still be used by a <code>Deployment</code> scaled down to <code>0</code>).</p></li></ol><p>ℹ️ For the last step, there is a helper function <code>InjectAnnotations</code> in the <code>pkg/controller/garbagecollector/references</code>, which you can use for your convenience.</p><p><strong>Example:</strong></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ConfigMap</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">test-1234</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    resources.gardener.cloud/garbage-collectable-reference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ConfigMap</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">test-5678</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    resources.gardener.cloud/garbage-collectable-reference</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;true&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Pod</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">example</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    reference.resources.gardener.cloud/configmap-82a3537f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">test-5678</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  containers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nginx</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">nginx:1.14.2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    terminationGracePeriodSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span></span></code></pre></div><p>The GC controller would delete the <code>ConfigMap/test-1234</code> because it is considered as not &quot;in-use&quot;.</p><p>ℹ️ If the GC controller is activated then the <code>ManagedResource</code> controller will no longer delete <code>ConfigMap</code>s/<code>Secret</code>s having the above label.</p><h4 id="how-to-activate-the-garbage-collector" tabindex="-1">How to Activate the Garbage Collector? <a class="header-anchor" href="#how-to-activate-the-garbage-collector" aria-label="Permalink to &quot;How to Activate the Garbage Collector?&quot;">​</a></h4><p>The GC controller can be activated by setting the <code>.controllers.garbageCollector.enabled</code> field to <code>true</code> in the component configuration.</p><h3 id="tokenrequestor-controller" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/controller/tokenrequestor" target="_blank" rel="noreferrer">TokenRequestor Controller</a> <a class="header-anchor" href="#tokenrequestor-controller" aria-label="Permalink to &quot;[TokenRequestor Controller](https://github.com/gardener/gardener/tree/master/pkg/controller/tokenrequestor)&quot;">​</a></h3><p>This controller provides the service to create and auto-renew tokens via the <a href="https://kubernetes.io/docs/reference/kubernetes-api/authentication-resources/token-request-v1/" target="_blank" rel="noreferrer"><code>TokenRequest</code> API</a>.</p><p>It provides a functionality similar to the kubelet&#39;s <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection" target="_blank" rel="noreferrer">Service Account Token Volume Projection</a>. It was created to handle the special case of issuing tokens to pods that run in a different cluster than the API server they communicate with (hence, using the native token volume projection feature is not possible).</p><p>The controller differentiates between <code>source cluster</code> and <code>target cluster</code>. The <code>source cluster</code> hosts the <code>gardener-resource-manager</code> pod. Secrets in this cluster are watched and modified by the controller. The <code>target cluster</code> <em>can</em> be configured to point to another cluster. The existence of ServiceAccounts are ensured and token requests are issued against the target. When the <code>gardener-resource-manager</code> is deployed next to the Shoot&#39;s controlplane in the Seed, the <code>source cluster</code> is the Seed while the <code>target cluster</code> points to the Shoot.</p><h4 id="reconciliation-loop" tabindex="-1">Reconciliation Loop <a class="header-anchor" href="#reconciliation-loop" aria-label="Permalink to &quot;Reconciliation Loop&quot;">​</a></h4><p>This controller reconciles <code>Secret</code>s in all namespaces in the source cluster with the label: <code>resources.gardener.cloud/purpose=token-requestor</code>. See <a href="https://github.com/gardener/gardener/blob/master/example/resource-manager/30-secret-tokenrequestor.yaml" target="_blank" rel="noreferrer">this YAML file</a> for an example of the secret.</p><p>The controller ensures a <code>ServiceAccount</code> exists in the target cluster as specified in the annotations of the <code>Secret</code> in the source cluster:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">serviceaccount.resources.gardener.cloud/name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;sa-name&gt;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">serviceaccount.resources.gardener.cloud/namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;sa-namespace&gt;</span></span></code></pre></div><p>You can optionally annotate the <code>Secret</code> with <code>serviceaccount.resources.gardener.cloud/labels</code>, e.g. <code>serviceaccount.resources.gardener.cloud/labels={&quot;some&quot;:&quot;labels&quot;,&quot;foo&quot;:&quot;bar&quot;}</code>. This will make the <code>ServiceAccount</code> getting labelled accordingly.</p><p>The requested tokens will act with the privileges which are assigned to this <code>ServiceAccount</code>.</p><p>The controller will then request a token via the <a href="https://kubernetes.io/docs/reference/kubernetes-api/authentication-resources/token-request-v1/" target="_blank" rel="noreferrer"><code>TokenRequest</code> API</a> and populate it into the <code>.data.token</code> field to the <code>Secret</code> in the source cluster.</p><p>Alternatively, the client can provide a raw kubeconfig (in YAML or JSON format) via the <code>Secret</code>&#39;s <code>.data.kubeconfig</code> field. The controller will then populate the requested token in the kubeconfig for the user used in the <code>.current-context</code>. For example, if <code>.data.kubeconfig</code> is</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">clusters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    certificate-authority-data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">AAAA</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">some-server-url</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot--foo--bar</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">contexts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    cluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot--foo--bar</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot--foo--bar-token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot--foo--bar</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">current-context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot--foo--bar</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Config</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">preferences</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {}</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot--foo--bar-token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    token</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span></code></pre></div><p>then the <code>.users[0].user.token</code> field of the kubeconfig will be updated accordingly.</p><p>The TokenRequestor can also optionally inject the current CA bundle if the secret is annotated with</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">serviceaccount.resources.gardener.cloud/inject-ca-bundle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;true&quot;</span></span></code></pre></div><p>If a <code>kubeconfig</code> is present in the secret, the CA bundle is set in the in the <code>cluster.certificate-authority-data</code> field of the cluster of the current context. Otherwise, the bundle is stored in an additional secret key <code>bundle.crt</code>.</p><p>The controller also adds an annotation to the <code>Secret</code> to keep track when to renew the token before it expires. By default, the tokens are issued to expire after 12 hours. The expiration time can be set with the following annotation:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">serviceaccount.resources.gardener.cloud/token-expiration-duration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">6h</span></span></code></pre></div><p>It automatically renews once 80% of the lifetime is reached, or after <code>24h</code>.</p><p>Optionally, the controller can also populate the token into a <code>Secret</code> in the target cluster. This can be requested by annotating the <code>Secret</code> in the source cluster with:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">token-requestor.resources.gardener.cloud/target-secret-name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;foo&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">token-requestor.resources.gardener.cloud/target-secret-namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bar&quot;</span></span></code></pre></div><p>Overall, the TokenRequestor controller provides credentials with limited lifetime (JWT tokens) used by Shoot control plane components running in the Seed to talk to the Shoot API Server. Please see the graphic below:</p><p><img src="`+t+`" alt="image"></p><blockquote><p>ℹ️ Generally, the controller can run with multiple instances in different components. For example, <code>gardener-resource-manager</code> might run the <code>TokenRequestor</code> controller, but <code>gardenlet</code> might run it, too. In order to differentiate which instance of the controller is responsible for a <code>Secret</code>, it can be labeled with <code>resources.gardener.cloud/class=&lt;class&gt;</code>. The <code>&lt;class&gt;</code> must be configured in the respective controller, otherwise it will be responsible for all <code>Secret</code>s no matter whether they have the label or not.</p></blockquote><h3 id="certificatesigningrequest-approver" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/csrapprover" target="_blank" rel="noreferrer"><code>CertificateSigningRequest</code> Approver</a> <a class="header-anchor" href="#certificatesigningrequest-approver" aria-label="Permalink to &quot;[\`CertificateSigningRequest\` Approver](https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/csrapprover)&quot;">​</a></h3><h4 id="kubelet-server" tabindex="-1">Kubelet Server <a class="header-anchor" href="#kubelet-server" aria-label="Permalink to &quot;Kubelet Server&quot;">​</a></h4><p>Gardener configures the kubelets such that they request two certificates via the <code>CertificateSigningRequest</code> API:</p><ol><li>client certificate for communicating with the <code>kube-apiserver</code></li><li>server certificate for serving its HTTPS server</li></ol><p>For client certificates, the <code>kubernetes.io/kube-apiserver-client-kubelet</code> signer is used (see <a href="https://kubernetes.io/docs/reference/access-authn-authz/certificate-signing-requests/#kubernetes-signers" target="_blank" rel="noreferrer">Certificate Signing Requests</a> for more details). The <code>kube-controller-manager</code>&#39;s <code>csrapprover</code> controller is responsible for auto-approving such <code>CertificateSigningRequest</code>s so that the respective certificates can be issued.</p><p>For server certificates, the <code>kubernetes.io/kubelet-serving</code> signer is used. Unfortunately, the <code>kube-controller-manager</code> is not able to auto-approve such <code>CertificateSigningRequest</code>s (see <a href="https://github.com/kubernetes/kubernetes/issues/73356" target="_blank" rel="noreferrer">kubernetes/kubernetes#73356</a> for details).</p><p>That&#39;s the motivation for having this controller as part of <code>gardener-resource-manager</code>. It watches <code>CertificateSigningRequest</code>s with the <code>kubernetes.io/kubelet-serving</code> signer and auto-approves them when all the following conditions are met:</p><ul><li>The <code>.spec.username</code> is prefixed with <code>system:node:</code>.</li><li>There must be at least one DNS name or IP address as part of the certificate SANs.</li><li>The common name in the CSR must match the <code>.spec.username</code>.</li><li>The organization in the CSR must only contain <code>system:nodes</code>.</li><li>There must be a <code>Node</code> object with the same name in the shoot cluster.</li><li>There must be exactly one <code>Machine</code> for the node in the seed cluster.</li><li>The DNS names part of the SANs must be equal to all <code>.status.addresses[]</code> of type <code>Hostname</code> in the <code>Node</code>.</li><li>The IP addresses part of the SANs must be equal to all <code>.status.addresses[]</code> of type <code>InternalIP</code> in the <code>Node</code>.</li></ul><p>If any one of these requirements is violated, the <code>CertificateSigningRequest</code> will be denied. Otherwise, once approved, the <code>kube-controller-manager</code>&#39;s <code>csrsigner</code> controller will issue the requested certificate.</p><h4 id="gardener-node-agent" tabindex="-1">Gardener Node Agent <a class="header-anchor" href="#gardener-node-agent" aria-label="Permalink to &quot;Gardener Node Agent&quot;">​</a></h4><p>There is a second use case for <code>CSR Approver</code>, because <a href="documentation/pr-preview/pr-2/docs/gardener/concepts/node-agent/">Gardener Node Agent</a> is able to use client certificates for communication with <code>kube-apiserver</code>. These certificates are requested via the <code>CertificateSigningRequest</code> API. They are using the <code>kubernetes.io/kube-apiserver-client</code> signer. Three use cases are covered:</p><ul><li>Bootstrap a new <code>node</code>.</li><li>Renew certificates.</li><li>Migrate nodes using <code>gardener-node-agent</code> service account.</li></ul><p>There is no auto-approve for these <code>CertificateSigningRequest</code>s either. As there are more users of <code>kubernetes.io/kube-apiserver-client</code> signer this controller handles only <code>CertificateSigningRequest</code>s when the common name in the CSR is prefixed with <code>gardener.cloud:node-agent:machine:</code>. The prefix is followed by the <code>username</code> which must be equal to the <code>machine.Name</code>. It auto-approves them when the following conditions are met.</p><p>Bootstrapping:</p><ul><li>The <code>.spec.username</code> is prefixed with <code>system:node:</code>.</li><li>A <code>Machine</code> for common name pattern <code>gardener.cloud:node-agent:machine:&lt;machine-name&gt;</code> in the CSR exists.</li><li>The <code>Machine</code> does not have a <code>label</code> with key <code>node</code>.</li></ul><p>Certificate renewal:</p><ul><li>The <code>.spec.username</code> is prefixed with <code>gardener.cloud:node-agent:machine:</code>.</li><li>A <code>Machine</code> for common name pattern <code>gardener.cloud:node-agent:machine:&lt;machine-name&gt;</code> in the CSR exists.</li><li>The common name in the CSR must match the <code>.spec.username</code>.</li></ul><p>Migration:</p><ul><li>The <code>.spec.username</code> is equal to <code>system:serviceaccount:kube-system:gardener-node-agent</code>.</li><li>A <code>Machine</code> for common name pattern <code>gardener.cloud:node-agent:machine:&lt;machine-name&gt;</code> in the CSR exists.</li><li>The <code>Machine</code> has a <code>label</code> with key <code>node</code>.</li></ul><p>If the common name in the CSR is not prefixed with <code>gardener.cloud:node-agent:machine:</code>, the <code>CertificateSigningRequest</code> will be ignored. If any one of these requirements is violated, the <code>CertificateSigningRequest</code> will be denied. Otherwise, once approved, the <code>kube-controller-manager</code>&#39;s <code>csrsigner</code> controller will issue the requested certificate.</p><h3 id="networkpolicy-controller" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/networkpolicy" target="_blank" rel="noreferrer"><code>NetworkPolicy</code> Controller</a> <a class="header-anchor" href="#networkpolicy-controller" aria-label="Permalink to &quot;[\`NetworkPolicy\` Controller](https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/networkpolicy)&quot;">​</a></h3><p>This controller reconciles <code>Service</code>s with a non-empty <code>.spec.podSelector</code>. It creates two <code>NetworkPolicy</code>s for each port in the <code>.spec.ports[]</code> list. For example:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Service</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  selector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">server</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">443</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    targetPort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10250</span></span></code></pre></div><p>leads to</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    gardener.cloud/description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Allows ingress TCP traffic to port 10250 for pods</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      selected by the a/gardener-resource-manager service selector from pods running</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      in namespace a labeled with map[networking.resources.gardener.cloud/to-gardener-resource-manager-tcp-10250:allowed].</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ingress-to-gardener-resource-manager-tcp-10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ingress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          networking.resources.gardener.cloud/to-gardener-resource-manager-tcp-10250</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">allowed</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  policyTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    gardener.cloud/description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Allows egress TCP traffic to port 10250 from pods</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      running in namespace a labeled with map[networking.resources.gardener.cloud/to-gardener-resource-manager-tcp-10250:allowed]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      to pods selected by the a/gardener-resource-manager service selector.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">egress-to-gardener-resource-manager-tcp-10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  egress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">to</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      networking.resources.gardener.cloud/to-gardener-resource-manager-tcp-10250</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">allowed</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  policyTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Egress</span></span></code></pre></div><p>A component that initiates the connection to <code>gardener-resource-manager</code>&#39;s <code>tcp/10250</code> port can now be labeled with <code>networking.resources.gardener.cloud/to-gardener-resource-manager-tcp-10250=allowed</code>. That&#39;s all this component needs to do - it does not need to create any <code>NetworkPolicy</code>s itself.</p><h4 id="cross-namespace-communication" tabindex="-1">Cross-Namespace Communication <a class="header-anchor" href="#cross-namespace-communication" aria-label="Permalink to &quot;Cross-Namespace Communication&quot;">​</a></h4><p>Apart from this &quot;simple&quot; case where both communicating components run in the same namespace <code>a</code>, there is also the cross-namespace communication case. With above example, let&#39;s say there are components running in another namespace <code>b</code>, and they would like to initiate the communication with <code>gardener-resource-manager</code> in <code>a</code>. To cover this scenario, the <code>Service</code> can be annotated with <code>networking.resources.gardener.cloud/namespace-selectors=&#39;[{&quot;matchLabels&quot;:{&quot;kubernetes.io/metadata.name&quot;:&quot;b&quot;}}]&#39;</code>.</p><blockquote><p>Note that you can specify multiple namespace selectors in this annotation which are OR-ed.</p></blockquote><p>This will make the controller create additional <code>NetworkPolicy</code>s as follows:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    gardener.cloud/description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Allows ingress TCP traffic to port 10250 for pods selected</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      by the a/gardener-resource-manager service selector from pods running in namespace b</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      labeled with map[networking.resources.gardener.cloud/to-a-gardener-resource-manager-tcp-10250:allowed].</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ingress-to-gardener-resource-manager-tcp-10250-from-b</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ingress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">namespaceSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          kubernetes.io/metadata.name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          networking.resources.gardener.cloud/to-a-gardener-resource-manager-tcp-10250</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">allowed</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  policyTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    gardener.cloud/description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Allows egress TCP traffic to port 10250 from pods running in</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      namespace b labeled with map[networking.resources.gardener.cloud/to-a-gardener-resource-manager-tcp-10250:allowed]</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      to pods selected by the a/gardener-resource-manager service selector.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">egress-to-a-gardener-resource-manager-tcp-10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">b</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  egress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">to</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">namespaceSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          kubernetes.io/metadata.name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      networking.resources.gardener.cloud/to-a-gardener-resource-manager-tcp-10250</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">allowed</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  policyTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Egress</span></span></code></pre></div><p>The components in namespace <code>b</code> now need to be labeled with <code>networking.resources.gardener.cloud/to-a-gardener-resource-manager-tcp-10250=allowed</code>, but that&#39;s already it.</p><blockquote><p>Obviously, this approach also works for namespace selectors different from <code>kubernetes.io/metadata.name</code> to cover scenarios where the namespace name is not known upfront or where multiple namespaces with a similar label are relevant. The controller creates two dedicated policies for each namespace matching the selectors.</p></blockquote><h4 id="service-targets-in-multiple-namespaces" tabindex="-1"><code>Service</code> Targets In Multiple Namespaces <a class="header-anchor" href="#service-targets-in-multiple-namespaces" aria-label="Permalink to &quot;\`Service\` Targets In Multiple Namespaces&quot;">​</a></h4><p>Finally, let&#39;s say there is a <code>Service</code> called <code>example</code> which exists in different namespaces whose names are not static (e.g., <code>foo-1</code>, <code>foo-2</code>), and a component in namespace <code>bar</code> wants to initiate connections with all of them.</p><p>The <code>example</code> <code>Service</code>s in these namespaces can now be annotated with <code>networking.resources.gardener.cloud/namespace-selectors=&#39;[{&quot;matchLabels&quot;:{&quot;kubernetes.io/metadata.name&quot;:&quot;bar&quot;}}]&#39;</code>. As a consequence, the component in namespace <code>bar</code> now needs to be labeled with <code>networking.resources.gardener.cloud/to-foo-1-example-tcp-8080=allowed</code>, <code>networking.resources.gardener.cloud/to-foo-2-example-tcp-8080=allowed</code>, etc. This approach does not work in practice, however, since the namespace names are neither static nor known upfront.</p><p>To overcome this, it is possible to specify an alias for the concrete namespace in the pod label selector via the <code>networking.resources.gardener.cloud/pod-label-selector-namespace-alias</code> annotation.</p><p>In above case, the <code>example</code> <code>Service</code> in the <code>foo-*</code> namespaces could be annotated with <code>networking.resources.gardener.cloud/pod-label-selector-namespace-alias=all-foos</code>. This would modify the label selector in all <code>NetworkPolicy</code>s related to cross-namespace communication, i.e. instead of <code>networking.resources.gardener.cloud/to-foo-{1,2,...}-example-tcp-8080=allowed</code>, <code>networking.resources.gardener.cloud/to-all-foos-example-tcp-8080=allowed</code> would be used. Now the component in namespace <code>bar</code> only needs this single label and is able to talk to all such <code>Service</code>s in the different namespaces.</p><blockquote><p>Real-world examples for this scenario are the <code>kube-apiserver</code> <code>Service</code> (which exists in all shoot namespaces), or the <code>istio-ingressgateway</code> <code>Service</code> (which exists in all <code>istio-ingress*</code> namespaces). In both cases, the names of the namespaces are not statically known and depend on user input.</p></blockquote><h4 id="overwriting-the-pod-selector-label" tabindex="-1">Overwriting The Pod Selector Label <a class="header-anchor" href="#overwriting-the-pod-selector-label" aria-label="Permalink to &quot;Overwriting The Pod Selector Label&quot;">​</a></h4><p>For a component which initiates the connection to many other components, it&#39;s sometimes impractical to specify all the respective labels in its pod template. For example, let&#39;s say a component <code>foo</code> talks to <code>bar{0..9}</code> on ports <code>tcp/808{0..9}</code>. <code>foo</code> would need to have the ten <code>networking.resources.gardener.cloud/to-bar{0..9}-tcp-808{0..9}=allowed</code> labels.</p><p>As an alternative and to simplify this, it is also possible to annotate the targeted <code>Service</code>s with <code>networking.resources.gardener.cloud/from-&lt;some-alias&gt;-allowed-ports</code>. For our example, <code>&lt;some-alias&gt;</code> could be <code>all-bars</code>.</p><p>As a result, component <code>foo</code> just needs to have the label <code>networking.resources.gardener.cloud/to-all-bars=allowed</code> instead of all the other ten explicit labels.</p><p>⚠️ Note that this also requires to specify the list of allowed container ports as annotation value since the pod selector label will no longer be specific for a dedicated service/port. For our example, the <code>Service</code> for <code>barX</code> with <code>X</code> in <code>{0..9}</code> needs to be annotated with <code>networking.resources.gardener.cloud/from-all-bars-allowed-ports=[{&quot;port&quot;:808X,&quot;protocol&quot;:&quot;TCP&quot;}]</code> in addition.</p><blockquote><p>Real-world examples for this scenario are the <code>Prometheis</code> in seed clusters which initiate the communication to a lot of components in order to scrape their metrics. Another example is the <code>kube-apiserver</code> which initiates the communication to webhook servers (potentially of extension components that are not known by Gardener itself).</p></blockquote><h4 id="ingress-from-everywhere" tabindex="-1">Ingress From Everywhere <a class="header-anchor" href="#ingress-from-everywhere" aria-label="Permalink to &quot;Ingress From Everywhere&quot;">​</a></h4><p>All above scenarios are about components initiating connections to some targets. However, some components also receive incoming traffic from sources outside the cluster. This traffic requires adequate ingress policies so that it can be allowed.</p><p>To cover this scenario, the <code>Service</code> can be annotated with <code>networking.resources.gardener.cloud/from-world-to-ports=[{&quot;port&quot;:&quot;10250&quot;,&quot;protocol&quot;:&quot;TCP&quot;}]</code>. As a result, the controller creates the following <code>NetworkPolicy</code>:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ingress-to-gardener-resource-manager-from-world</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ingress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  policyTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Ingress</span></span></code></pre></div><p>The respective pods don&#39;t need any additional labels. If the annotation&#39;s value is empty (<code>[]</code>) then all ports are allowed.</p><h4 id="services-exposed-via-ingress-resources" tabindex="-1">Services Exposed via <code>Ingress</code> Resources <a class="header-anchor" href="#services-exposed-via-ingress-resources" aria-label="Permalink to &quot;Services Exposed via \`Ingress\` Resources&quot;">​</a></h4><p>The controller can optionally be configured to watch <code>Ingress</code> resources by specifying the pod and namespace selectors for the <code>Ingress</code> controller. If this information is provided, it automatically creates <code>NetworkPolicy</code> resources allowing the respective ingress/egress traffic for the backends exposed by the <code>Ingress</code>es. This way, neither custom <code>NetworkPolicy</code>s nor custom labels must be provided.</p><p>The needed configuration is part of the component configuration:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">controllers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networkPolicy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    concurrentSyncs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # namespaceSelectors:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # - matchLabels:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #     kubernetes.io/metadata.name: default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ingressControllerSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bar</span></span></code></pre></div><p>As an example, let&#39;s assume that above <code>gardener-resource-manager</code> <code>Service</code> was exposed via the following <code>Ingress</code> resource:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  rules</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">grm.foo.example.com</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      paths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">backend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">443</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        pathType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Prefix</span></span></code></pre></div><p>As a result, the controller would automatically create the following <code>NetworkPolicy</code>s:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    gardener.cloud/description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Allows ingress TCP traffic to port 10250 for pods</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      selected by the a/gardener-resource-manager service selector from ingress controller</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      pods running in the default namespace labeled with map[foo:bar].</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ingress-to-gardener-resource-manager-tcp-10250-from-ingress-controller</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ingress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bar</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      namespaceSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          kubernetes.io/metadata.name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  policyTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Ingress</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">---</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">networking.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkPolicy</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  annotations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    gardener.cloud/description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Allows egress TCP traffic to port 10250 from pods</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      running in the default namespace labeled with map[foo:bar] to pods selected by</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      the a/gardener-resource-manager service selector.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">egress-to-a-gardener-resource-manager-tcp-10250-from-ingress-controller</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">default</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  egress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">to</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener-resource-manager</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      namespaceSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          kubernetes.io/metadata.name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10250</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      protocol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TCP</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  podSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">bar</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  policyTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Egress</span></span></code></pre></div><blockquote><p>ℹ️ Note that <code>Ingress</code> resources reference the service port while <code>NetworkPolicy</code>s reference the target port/container port. The controller automatically translates this when reconciling the <code>NetworkPolicy</code> resources.</p></blockquote><h3 id="node-controller" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/node" target="_blank" rel="noreferrer"><code>Node</code> Controller</a> <a class="header-anchor" href="#node-controller" aria-label="Permalink to &quot;[\`Node\` Controller](https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/node)&quot;">​</a></h3><h4 id="critical-components-controller" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/node/criticalcomponents" target="_blank" rel="noreferrer">Critical Components Controller</a> <a class="header-anchor" href="#critical-components-controller" aria-label="Permalink to &quot;[Critical Components Controller](https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/node/criticalcomponents)&quot;">​</a></h4><p>Gardenlet configures kubelet of shoot worker nodes to register the <code>Node</code> object with the <code>node.gardener.cloud/critical-components-not-ready</code> taint (effect <code>NoSchedule</code>). This controller watches newly created <code>Node</code> objects in the shoot cluster and removes the taint once all node-critical components are scheduled and ready. If the controller finds node-critical components that are not scheduled or not ready yet, it checks the <code>Node</code> again after the duration configured in <code>ResourceManagerConfiguration.controllers.node.backoff</code> Please refer to the <a href="documentation/pr-preview/pr-2/docs/gardener/advanced/node-readiness/">feature documentation</a> or <a href="https://github.com/gardener/gardener/issues/7117" target="_blank" rel="noreferrer">proposal issue</a> for more details.</p><h4 id="node-agent-reconciliation-delay-controller" tabindex="-1"><a href="https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/node/agentreconciliationdelay" target="_blank" rel="noreferrer">Node Agent Reconciliation Delay Controller</a> <a class="header-anchor" href="#node-agent-reconciliation-delay-controller" aria-label="Permalink to &quot;[Node Agent Reconciliation Delay Controller](https://github.com/gardener/gardener/tree/master/pkg/resourcemanager/controller/node/agentreconciliationdelay)&quot;">​</a></h4><p>This controller computes a reconciliation delay per node by using a simple linear mapping approach based on the index of the nodes in the list of all nodes in the shoot cluster. This approach ensures that the delays of all instances of <code>gardener-node-agent</code> are distributed evenly.</p><p>The minimum and maximum delays can be configured, but they are defaulted to <code>0s</code> and <code>5m</code>, respectively.</p><p>This approach works well as long as the number of nodes in the cluster is not higher than the configured maximum delay in seconds. In this case, the delay is still computed linearly, however, the more nodes exist in the cluster, the closer the delay times become (which might be of limited use then). Consider increasing the maximum delay by annotating the <code>Shoot</code> with <code>shoot.gardener.cloud/cloud-config-execution-max-delay-seconds=&lt;value&gt;</code>. The highest possible value is <code>1800</code>.</p><p>The controller adds the <code>node-agent.gardener.cloud/reconciliation-delay</code> annotation to nodes whose value is read by the <a href="documentation/pr-preview/pr-2/docs/gardener/concepts/node-agent/">node-agent</a>s.</p><h2 id="webhooks" tabindex="-1">Webhooks <a class="header-anchor" href="#webhooks" aria-label="Permalink to &quot;Webhooks&quot;">​</a></h2><h3 id="mutating-webhooks" tabindex="-1">Mutating Webhooks <a class="header-anchor" href="#mutating-webhooks" aria-label="Permalink to &quot;Mutating Webhooks&quot;">​</a></h3><h4 id="high-availability-config" tabindex="-1">High Availability Config <a class="header-anchor" href="#high-availability-config" aria-label="Permalink to &quot;High Availability Config&quot;">​</a></h4><p>This webhook is used to conveniently apply the configuration to make components deployed to seed or shoot clusters highly available. The details and scenarios are described in <a href="documentation/pr-preview/pr-2/docs/gardener/high-availability-of-components/">High Availability Of Deployed Components</a>.</p><p>The webhook reacts on creation/update of <code>Deployment</code>s, <code>StatefulSet</code>s and <code>HorizontalPodAutoscaler</code>s in namespaces labeled with <code>high-availability-config.resources.gardener.cloud/consider=true</code>.</p><p>The webhook performs the following actions:</p><ol><li><p>The <code>.spec.replicas</code> (or <code>spec.minReplicas</code> respectively) field is mutated based on the <code>high-availability-config.resources.gardener.cloud/type</code> label of the resource and the <code>high-availability-config.resources.gardener.cloud/failure-tolerance-type</code> annotation of the namespace:</p><table tabindex="0"><thead><tr><th>Failure Tolerance Type ➡️<br>/<br>⬇️ Component Type️ ️</th><th>unset</th><th>empty</th><th>non-empty</th></tr></thead><tbody><tr><td><code>controller</code></td><td><code>2</code></td><td><code>1</code></td><td><code>2</code></td></tr><tr><td><code>server</code></td><td><code>2</code></td><td><code>2</code></td><td><code>2</code></td></tr></tbody></table><ul><li>The replica count values can be overwritten by the <code>high-availability-config.resources.gardener.cloud/replicas</code> annotation.</li><li>It does NOT mutate the replicas when: <ul><li>the replicas are already set to <code>0</code> (hibernation case), or</li><li>when the resource is scaled horizontally by <code>HorizontalPodAutoscaler</code>, and the current replica count is higher than what was computed above.</li></ul></li></ul></li><li><p>When the <code>high-availability-config.resources.gardener.cloud/zones</code> annotation is NOT empty and either the <code>high-availability-config.resources.gardener.cloud/failure-tolerance-type</code> annotation is set or the <code>high-availability-config.resources.gardener.cloud/zone-pinning</code> annotation is set to <code>true</code>, then it adds a <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity" target="_blank" rel="noreferrer">node affinity</a> to the pod template spec:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  affinity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    nodeAffinity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      requiredDuringSchedulingIgnoredDuringExecution</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        nodeSelectorTerms</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">matchExpressions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">topology.kubernetes.io/zone</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            operator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">In</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            values</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&lt;zone1&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # - ...</span></span></code></pre></div><p>This ensures that all pods are pinned to only nodes in exactly those concrete zones.</p></li><li><p><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/" target="_blank" rel="noreferrer">Topology Spread Constraints</a> are added to the pod template spec when the <code>.spec.replicas</code> are greater than <code>1</code>. When the <code>high-availability-config.resources.gardener.cloud/zones</code> annotation ...</p><ul><li><p>... contains only one zone, then the following is added:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  topologySpreadConstraints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">topologyKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubernetes.io/hostname</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    minDomains</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # lower value of max replicas or 3</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    maxSkew</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    whenUnsatisfiable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ScheduleAnyway</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # or DoNotSchedule</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabelKeys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pod-template-hash</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    labelSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span></code></pre></div><p>This ensures that the (multiple) pods are scheduled across nodes. <code>minDomains</code> is set when failure tolerance is configured or annotation <code>high-availability-config.resources.gardener.cloud/host-spread=&quot;true&quot;</code> is given.</p></li><li><p>... contains at least two zones, then the following is added:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  topologySpreadConstraints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">topologyKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kubernetes.io/hostname</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    maxSkew</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    whenUnsatisfiable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ScheduleAnyway</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # or DoNotSchedule</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabelKeys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pod-template-hash</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    labelSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">topologyKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">topology.kubernetes.io/zone</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    minDomains</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # lower value of max replicas or number of zones</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    maxSkew</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    whenUnsatisfiable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DoNotSchedule</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    matchLabelKeys</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pod-template-hash</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    labelSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span></span></code></pre></div><p>This enforces that the (multiple) pods are scheduled across zones. The <code>minDomains</code> calculation is based on whatever value is lower - (maximum) replicas or number of zones. This is the number of minimum domains required to schedule pods in a highly available manner.</p></li></ul><p>Independent on the number of zones, when one of the following conditions is true, then the field <code>whenUnsatisfiable</code> is set to <code>DoNotSchedule</code> for the constraint with <code>topologyKey=kubernetes.io/hostname</code> (which enforces the node-spread):</p><ul><li>The <code>high-availability-config.resources.gardener.cloud/host-spread</code> annotation is set to <code>true</code>.</li><li>The <code>high-availability-config.resources.gardener.cloud/failure-tolerance-type</code> annotation is set and NOT empty.</li></ul></li><li><p>Adds default tolerations for <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/#taint-based-evictions" target="_blank" rel="noreferrer">taint-based evictions</a>:</p><p>Tolerations for taints <code>node.kubernetes.io/not-ready</code> and <code>node.kubernetes.io/unreachable</code> are added to the handled <code>Deployment</code> and <code>StatefulSet</code> if their <code>podTemplate</code>s do not already specify them. The <code>TolerationSeconds</code> are taken from the respective configuration section of the webhook&#39;s configuration (see <a href="https://github.com/gardener/gardener/blob/master/example/resource-manager/10-componentconfig.yaml" target="_blank" rel="noreferrer">example</a>)).</p><p>We consider fine-tuned values for those tolerations a matter of high-availability because they often help to reduce recovery times in case of node or zone outages, also see <a href="documentation/pr-preview/pr-2/docs/gardener/high-availability/shoot_high_availability_best_practices/">High-Availability Best Practices</a>. In addition, this webhook handling helps to set defaults for many but not all workload components in a cluster. For instance, Gardener can use this webhook to set defaults for nearly every component in seed clusters but only for the system components in shoot clusters. Any customer workload remains unchanged.</p></li></ol><h4 id="kubernetes-service-host-injection" tabindex="-1">Kubernetes Service Host Injection <a class="header-anchor" href="#kubernetes-service-host-injection" aria-label="Permalink to &quot;Kubernetes Service Host Injection&quot;">​</a></h4><p>By default, when <code>Pod</code>s are created, Kubernetes implicitly injects the <code>KUBERNETES_SERVICE_HOST</code> environment variable into all containers. The value of this variable points it to the default Kubernetes service (i.e., <code>kubernetes.default.svc.cluster.local</code>). This allows pods to conveniently talk to the API server of their cluster.</p><p>In shoot clusters, this network path involves the <code>apiserver-proxy</code> <code>DaemonSet</code> which eventually forwards the traffic to the API server. Hence, it results in additional network hop.</p><p>The purpose of this webhook is to explicitly inject the <code>KUBERNETES_SERVICE_HOST</code> environment variable into all containers and setting its value to the FQDN of the API server. This way, the additional network hop is avoided.</p><h4 id="auto-mounting-projected-serviceaccount-tokens" tabindex="-1">Auto-Mounting Projected <code>ServiceAccount</code> Tokens <a class="header-anchor" href="#auto-mounting-projected-serviceaccount-tokens" aria-label="Permalink to &quot;Auto-Mounting Projected \`ServiceAccount\` Tokens&quot;">​</a></h4><p>When this webhook is activated, then it automatically injects projected <code>ServiceAccount</code> token volumes into <code>Pod</code>s and all its containers if all of the following preconditions are fulfilled:</p><ol><li>The <code>Pod</code> is NOT labeled with <code>projected-token-mount.resources.gardener.cloud/skip=true</code>.</li><li>The <code>Pod</code>&#39;s <code>.spec.serviceAccountName</code> field is NOT empty and NOT set to <code>default</code>.</li><li>The <code>ServiceAccount</code> specified in the <code>Pod</code>&#39;s <code>.spec.serviceAccountName</code> sets <code>.automountServiceAccountToken=false</code>.</li><li>The <code>Pod</code>&#39;s <code>.spec.volumes[]</code> DO NOT already contain a volume with a name prefixed with <code>kube-api-access-</code>.</li></ol><p>The projected volume will look as follows:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kube-api-access-gardener</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    projected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      defaultMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">420</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      sources</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">serviceAccountToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          expirationSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">43200</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">configMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          items</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ca.crt</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ca.crt</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">kube-root-ca.crt</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">downwardAPI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          items</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">fieldRef</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">              fieldPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">metadata.namespace</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">namespace</span></span></code></pre></div><blockquote><p>The <code>expirationSeconds</code> are defaulted to <code>12h</code> and can be overwritten with the <code>.webhooks.projectedTokenMount.expirationSeconds</code> field in the component configuration, or with the <code>projected-token-mount.resources.gardener.cloud/expiration-seconds</code> annotation on a <code>Pod</code> resource.</p></blockquote><p>The volume will be mounted into all containers specified in the <code>Pod</code> to the path <code>/var/run/secrets/kubernetes.io/serviceaccount</code>. This is the default location where client libraries expect to find the tokens and mimics the <a href="https://github.com/kubernetes/kubernetes/tree/v1.22.2/plugin/pkg/admission/serviceaccount" target="_blank" rel="noreferrer">upstream <code>ServiceAccount</code> admission plugin</a>. See <a href="https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/#serviceaccount-admission-controller" target="_blank" rel="noreferrer">Managing Service Accounts</a> for more information.</p><p>Overall, this webhook is used to inject projected service account tokens into pods running in the Shoot and the Seed cluster. Hence, it is served from the Seed GRM and each Shoot GRM. Please find an overview below for pods deployed in the Shoot cluster:</p><p><img src="`+l+`" alt="image"></p><h4 id="pod-topology-spread-constraints" tabindex="-1">Pod Topology Spread Constraints <a class="header-anchor" href="#pod-topology-spread-constraints" aria-label="Permalink to &quot;Pod Topology Spread Constraints&quot;">​</a></h4><p>When this webhook is enabled, then it mimics the <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/#spread-constraint-definition" target="_blank" rel="noreferrer">topologyKey feature</a> for <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints" target="_blank" rel="noreferrer">Topology Spread Constraints (TSC)</a> on the label <code>pod-template-hash</code>. Concretely, when a pod is labelled with <code>pod-template-hash</code>, the handler of this webhook extends any topology spread constraint in the pod:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    pod-template-hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">123abc</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  topologySpreadConstraints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">maxSkew</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    topologyKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">topology.kubernetes.io/zone</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    whenUnsatisfiable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DoNotSchedule</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    labelSelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      matchLabels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        pod-template-hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">123abc</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # added by webhook</span></span></code></pre></div><p>The procedure circumvents a <a href="https://github.com/kubernetes/kubernetes/issues/98215" target="_blank" rel="noreferrer">known limitation</a> with TSCs which leads to imbalanced deployments after rolling updates. Gardener enables this webhook to schedule pods of deployments across nodes and zones. This webhook is enabled only when the <code>MatchLabelKeysInPodTopologySpread</code> feature gate (beta since <code>v1.27</code>) is explicitly disabled in the <code>kube-apiserver</code> and <code>kube-scheduler</code>.</p><p>Please note that the <code>gardener-resource-manager</code> itself as well as pods labelled with <code>topology-spread-constraints.resources.gardener.cloud/skip</code> are excluded from any mutations.</p><h4 id="system-components-webhook" tabindex="-1">System Components Webhook <a class="header-anchor" href="#system-components-webhook" aria-label="Permalink to &quot;System Components Webhook&quot;">​</a></h4><p>If enabled, this webhook handles scheduling concerns for system components <code>Pod</code>s (except those managed by <code>DaemonSet</code>s). The following tasks are performed by this webhook:</p><ol><li>Add <code>pod.spec.nodeSelector</code> as given in the webhook configuration.</li><li>Add <code>pod.spec.tolerations</code> as given in the webhook configuration.</li><li>Add <code>pod.spec.tolerations</code> for any existing nodes matching the node selector given in the webhook configuration. Known taints and tolerations used for <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/#taint-based-evictions" target="_blank" rel="noreferrer">taint based evictions</a> are disregarded.</li></ol><p>Gardener enables this webhook for <code>kube-system</code> and <code>kubernetes-dashboard</code> namespaces in shoot clusters, selecting <code>Pod</code>s being labelled with <code>resources.gardener.cloud/managed-by: gardener</code>. It adds a configuration, so that <code>Pod</code>s will get the <code>worker.gardener.cloud/system-components: true</code> node selector (step 1) as well as tolerate any custom taint (step 2) that is added to system component worker nodes (<code>shoot.spec.provider.workers[].systemComponents.allow: true</code>). In addition, the webhook merges these tolerations with the ones required for at that time available system component <code>Node</code>s in the cluster (step 3). Both is required to ensure system component <code>Pod</code>s can be <em>scheduled</em> or <em>executed</em> during an active shoot reconciliation that is happening due to any modifications to <code>shoot.spec.provider.workers[].taints</code>, e.g. <code>Pod</code>s must be scheduled while there are still <code>Node</code>s not having the updated taint configuration.</p><blockquote><p>You can opt-out of this behaviour for <code>Pod</code>s by labeling them with <code>system-components-config.resources.gardener.cloud/skip=true</code>.</p></blockquote><h4 id="endpointslice-hints" tabindex="-1">EndpointSlice Hints <a class="header-anchor" href="#endpointslice-hints" aria-label="Permalink to &quot;EndpointSlice Hints&quot;">​</a></h4><p>This webhook mutates <a href="https://kubernetes.io/docs/concepts/services-networking/endpoint-slices/" target="_blank" rel="noreferrer"><code>EndpointSlice</code>s</a>. For each endpoint in the EndpointSlice, it sets the endpoint&#39;s hints to the endpoint&#39;s zone.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">discovery.k8s.io/v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EndpointSlice</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">example-hints</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">endpoints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">addresses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;10.1.2.3&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  conditions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ready</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  hostname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pod-1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  zone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">zone-a</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  hints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    forZones</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zone-a&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # added by webhook</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">addresses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;10.1.2.4&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  conditions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    ready</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  hostname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pod-2</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  zone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">zone-b</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  hints</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    forZones</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;zone-b&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # added by webhook</span></span></code></pre></div><p>The webhook aims to circumvent issues with the Kubernetes <code>TopologyAwareHints</code> feature that currently does not allow to achieve a deterministic topology-aware traffic routing. For more details, see the following issue <a href="https://github.com/kubernetes/kubernetes/issues/113731" target="_blank" rel="noreferrer">kubernetes/kubernetes#113731</a> that describes drawbacks of the <code>TopologyAwareHints</code> feature for our use case. If the above-mentioned issue gets resolved and there is a native support for deterministic topology-aware traffic routing in Kubernetes, then this webhook can be dropped in favor of the native Kubernetes feature.</p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p>The EndpointSlice Hints webhook is disabled when the runtime Kubernetes version is &gt;= 1.32. Instead, the <code>ServiceTrafficDistribution</code> feature is used. See more details in <a href="documentation/pr-preview/pr-2/docs/gardener/topology_aware_routing/">Topology-Aware Traffic Routing</a>.</p></div><h4 id="pod-kube-api-server-load-balancing" tabindex="-1">Pod Kube API Server Load Balancing <a class="header-anchor" href="#pod-kube-api-server-load-balancing" aria-label="Permalink to &quot;Pod Kube API Server Load Balancing&quot;">​</a></h4><p>This webhook is used in the context of <a href="documentation/pr-preview/pr-2/docs/gardener/kube_apiserver_loadbalancing/">L7 load balancing for kube-apiservers</a>. It facilitates access of control plane components to the kube-apiserver via istio ingress gateway which is the Gardener l7 load balancer.</p><p>For those control plane pods which use the generic token kubeconfig the webhook adds these items:</p><ul><li>It adds a network policy label to allow the pods to access the internal istio ingress gateway service which is responsible for &quot;its&quot; kube-apiserver.</li><li>It adds a host alias which resolves the cluster externally resolvable kube-apiserver host to the internal istio ingress gateway service cluster IP address.</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">v1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Pod</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    networking.resources.gardener.cloud/to-istio-ingress-istio-ingressgateway-internal-tcp-9443</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">allowed</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # added by webhook</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  hostAliases</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hostnames</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># added by webhook</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">api.local.local.internal.local.gardener.cloud</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # added by webhook</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      ip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10.2.15.178</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # added by webhook</span></span></code></pre></div><p>For mutating pods, the webhook needs to know the namespace of the istio ingress gateway responsible for the kube-apiserver and its host names. These values are stored in <code>istio-internal-load-balancing</code> configmap in the same namespace as the pod being mutated.</p><h3 id="validating-webhooks" tabindex="-1">Validating Webhooks <a class="header-anchor" href="#validating-webhooks" aria-label="Permalink to &quot;Validating Webhooks&quot;">​</a></h3><h4 id="unconfirmed-deletion-prevention-for-custom-resources-and-definitions" tabindex="-1">Unconfirmed Deletion Prevention For Custom Resources And Definitions <a class="header-anchor" href="#unconfirmed-deletion-prevention-for-custom-resources-and-definitions" aria-label="Permalink to &quot;Unconfirmed Deletion Prevention For Custom Resources And Definitions&quot;">​</a></h4><p>As part of Gardener&#39;s <a href="documentation/pr-preview/pr-2/docs/gardener/extensions/">extensibility concepts</a>, a lot of <code>CustomResourceDefinition</code>s are deployed to the seed clusters that serve as extension points for provider-specific controllers. For example, the <a href="documentation/pr-preview/pr-2/docs/gardener/extensions/resources/infrastructure/"><code>Infrastructure</code> CRD</a> triggers the provider extension to prepare the IaaS infrastructure of the underlying cloud provider for a to-be-created shoot cluster. Consequently, these extension CRDs have a lot of power and control large portions of the end-user&#39;s shoot cluster. Accidental or undesired deletions of those resource can cause tremendous and hard-to-recover-from outages and should be prevented.</p><p>When this webhook is activated, it reacts for <code>CustomResourceDefinition</code>s and most of the custom resources in the <code>extensions.gardener.cloud/v1alpha1</code> API group. It also reacts for the <code>druid.gardener.cloud/v1alpha1.Etcd</code> resources.</p><p>The webhook prevents <code>DELETE</code> requests for those <code>CustomResourceDefinition</code>s labeled with <code>gardener.cloud/deletion-protected=true</code>, and for all mentioned custom resources if they were not previously annotated with the <code>confirmation.gardener.cloud/deletion=true</code>. This prevents that undesired <code>kubectl delete &lt;...&gt;</code> requests are accepted.</p><h4 id="extension-resource-validation" tabindex="-1">Extension Resource Validation <a class="header-anchor" href="#extension-resource-validation" aria-label="Permalink to &quot;Extension Resource Validation&quot;">​</a></h4><p>When this webhook is activated, it reacts for most of the custom resources in the <code>extensions.gardener.cloud/v1alpha1</code> API group. It also reacts for the <code>druid.gardener.cloud/v1alpha1.Etcd</code> resources.</p><p>The webhook validates the resources specifications for <code>CREATE</code> and <code>UPDATE</code> requests.</p><h3 id="authorization-webhooks" tabindex="-1">Authorization Webhooks <a class="header-anchor" href="#authorization-webhooks" aria-label="Permalink to &quot;Authorization Webhooks&quot;">​</a></h3><h4 id="node-agent-authorizer-webhook" tabindex="-1"><code>node-agent-authorizer</code> webhook <a class="header-anchor" href="#node-agent-authorizer-webhook" aria-label="Permalink to &quot;\`node-agent-authorizer\` webhook&quot;">​</a></h4><p><code>gardener-resource-manager</code> serves an authorization webhook for shoot <code>kube-apiserver</code>s which authorizes requests made by the <code>gardener-node-agent</code>. It works similar to <a href="documentation/pr-preview/pr-2/docs/gardener/deployment/gardenlet_api_access/"><code>SeedAuthorizer</code></a>. However, the logic used to make decisions is much simpler so it does not implement a decision graph. In many cases, the objects <code>gardener-node-agent</code> is allowed to access depend on the <code>Node</code> it is running on.</p><p>The username of the <code>gardener-node-agent</code> used for authorization requests is derived from the name of the <code>Machine</code> resource responsible for the node that the <code>gardener-node-agent</code> is running on. It follows the pattern <code>gardener.cloud:node-agent:machine:&lt;machine-name&gt;</code>. The name of the <code>Node</code> which runs on a <code>Machine</code> is read from <code>node</code> label of the <code>Machine</code>. All <code>gardener-node-agent</code> users are assigned to <code>gardener.cloud:node-agents</code> group.</p><p>Today, the following rules are implemented:</p><table tabindex="0"><thead><tr><th>Resource</th><th>Verbs</th><th>Description</th></tr></thead><tbody><tr><td><code>CertificateSigningRequests</code></td><td><code>get</code> , <code>create</code></td><td>Allow <code>create</code> requests for all <code>CertificateSigningRequests</code> s. Allow <code>get</code> requests for <code>CertificateSigningRequests</code> s created by the same user.</td></tr><tr><td><code>Events</code></td><td><code>create</code> , <code>patch</code></td><td>Allow to <code>create</code> and <code>patch</code> all <code>Event</code> s.</td></tr><tr><td><code>Leases</code></td><td><code>get</code> , <code>list</code> , <code>watch</code> , <code>create</code> , <code>update</code></td><td>Allow <code>get</code> , <code>list</code> , <code>watch</code> , <code>create</code> , <code>update</code> requests for <code>Leases</code> with the name <code>gardener-node-agent-&lt;node-name&gt;</code> in <code>kube-system</code> namespace.</td></tr><tr><td><code>Nodes</code></td><td><code>get</code> , <code>list</code> , <code>watch</code> , <code>patch</code> , <code>update</code></td><td>Allow <code>get</code> , <code>watch</code> , <code>patch</code> , <code>update</code> requests for the <code>Node</code> where <code>gardener-node-agent</code> is running. Allow <code>list</code> requests for all nodes.</td></tr><tr><td><code>Secrets</code></td><td><code>get</code> , <code>list</code> , <code>watch</code></td><td>Allow <code>get</code> , <code>list</code> , <code>watch</code> request to <code>gardener-valitail</code> secret and the gardener-node-agent-secret of the worker group of the <code>Node</code> where <code>gardener-node-agent</code> is running.</td></tr><tr><td><code>Pods</code></td><td><code>get</code> , <code>list</code> , <code>watch</code> , <code>delete</code></td><td>Allow <code>list</code> and <code>watch</code> permissions on <code>Pods</code> . For Shoot clusters running Kubernetes v1.31 or later, where the <code>AuthorizeWithSelectors</code> feature gate is enabled (it&#39;s beta and enabled by default in v1.32+), allow <code>list</code> and <code>watch</code> only if the request contains a field selector <code>spec.nodeName=&lt;node-on-which-gardener-node-agent-is-running&gt;</code> . Allow <code>get</code> and <code>delete</code> requests if the <code>.spec.nodeName</code> of the <code>Pod</code> matches the <code>Node</code> on which <code>gardener-node-agent</code> is running.</td></tr></tbody></table>`,235)]))}const u=s(o,[["render",r]]);export{E as __pageData,u as default};
