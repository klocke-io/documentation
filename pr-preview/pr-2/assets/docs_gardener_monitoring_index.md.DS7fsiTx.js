import{_ as s}from"./chunks/monitoring.CHLveUVA.js";import{_ as a,c as t,o as i,a2 as n}from"./chunks/framework.Bfq10Vlj.js";const u=JSON.parse('{"title":"Monitoring","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/monitoring","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/monitoring/_index.md","to":"README.md"},"persona":"Operators","title":"Monitoring","weight":50,"prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/monitoring/index.md","filePath":"docs/gardener/monitoring/index.md","lastUpdated":null}'),r={name:"docs/gardener/monitoring/index.md"};function o(h,e,l,p,d,c){return i(),t("div",null,e[0]||(e[0]=[n('<h1 id="monitoring" tabindex="-1">Monitoring <a class="header-anchor" href="#monitoring" aria-label="Permalink to &quot;Monitoring&quot;">​</a></h1><h2 id="roles-of-the-different-prometheus-instances" tabindex="-1">Roles of the different Prometheus instances <a class="header-anchor" href="#roles-of-the-different-prometheus-instances" aria-label="Permalink to &quot;Roles of the different Prometheus instances&quot;">​</a></h2><p><img src="'+s+`" alt="monitoring"></p><h3 id="cache-prometheus" tabindex="-1">Cache Prometheus <a class="header-anchor" href="#cache-prometheus" aria-label="Permalink to &quot;Cache Prometheus&quot;">​</a></h3><p>Deployed in the <code>garden</code> namespace. Important scrape targets:</p><ul><li>cadvisor</li><li>node-exporter</li><li>kube-state-metrics</li></ul><p><strong>Purpose</strong>: Act as a reverse proxy that supports server-side filtering, which is not supported by Prometheus exporters but by federation. Metrics in this Prometheus are kept for a short amount of time (~1 day) since other Prometheus instances are expected to federate from it and move metrics over. For example, the <a href="/docs/gardener/monitoring/#shoot-prometheus">shoot Prometheus</a> queries this Prometheus to retrieve metrics corresponding to the shoot&#39;s control plane. This way, we achieve isolation so that shoot owners are only able to query metrics for their shoots. Please note Prometheus does not support isolation features. Another example is if another Prometheus needs access to cadvisor metrics, which does not support server-side filtering, so it will query this Prometheus instead of the cadvisor. This strategy also reduces load on the kubelets and API Server.</p><p>Note some of these Prometheus&#39; metrics have high cardinality (e.g., metrics related to all shoots managed by the seed). Some of these are aggregated with recording rules. These <em>pre-aggregated</em> metrics are scraped by the <a href="/docs/gardener/monitoring/#aggregate-prometheus">aggregate Prometheus</a>.</p><p>This Prometheus is not used for alerting.</p><h3 id="aggregate-prometheus" tabindex="-1">Aggregate Prometheus <a class="header-anchor" href="#aggregate-prometheus" aria-label="Permalink to &quot;Aggregate Prometheus&quot;">​</a></h3><p>Deployed in the <code>garden</code> namespace. Important scrape targets:</p><ul><li>other Prometheus instances</li><li>logging components</li></ul><p><strong>Purpose</strong>: Store pre-aggregated data from the <a href="/docs/gardener/monitoring/#cache-prometheus">cache Prometheus</a> and <a href="/docs/gardener/monitoring/#shoot-prometheus">shoot Prometheus</a>. An ingress exposes this Prometheus allowing it to be scraped from another cluster. Such pre-aggregated data is also used for alerting.</p><h3 id="seed-prometheus" tabindex="-1">Seed Prometheus <a class="header-anchor" href="#seed-prometheus" aria-label="Permalink to &quot;Seed Prometheus&quot;">​</a></h3><p>Deployed in the <code>garden</code> namespace. Important scrape targets:</p><ul><li>pods in extension namespaces annotated with:</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>prometheus.io/scrape=true</span></span>
<span class="line"><span>prometheus.io/port=&lt;port&gt;</span></span>
<span class="line"><span>prometheus.io/name=&lt;name&gt;</span></span></code></pre></div><ul><li>cadvisor metrics from pods in the garden and extension namespaces</li></ul><p>The job name label will be applied to all metrics from that service.</p><p><strong>Purpose</strong>: Entrypoint for operators when debugging issues with extensions or other garden components.</p><p>This Prometheus is not used for alerting.</p><h3 id="shoot-prometheus" tabindex="-1">Shoot Prometheus <a class="header-anchor" href="#shoot-prometheus" aria-label="Permalink to &quot;Shoot Prometheus&quot;">​</a></h3><p>Deployed in the shoot control plane namespace. Important scrape targets:</p><ul><li>control plane components</li><li>shoot nodes (node-exporter)</li><li>blackbox-exporter used to measure <a href="/docs/gardener/monitoring/connectivity/">connectivity</a></li></ul><p><strong>Purpose</strong>: Monitor all relevant components belonging to a shoot cluster managed by Gardener. Shoot owners can view the metrics in Plutono dashboards and receive alerts based on these metrics. For alerting internals refer to <a href="/docs/gardener/monitoring/alerting/">this</a> document.</p><h4 id="federate-from-the-shoot-prometheus-to-an-external-prometheus" tabindex="-1">Federate from the Shoot Prometheus to an External Prometheus <a class="header-anchor" href="#federate-from-the-shoot-prometheus-to-an-external-prometheus" aria-label="Permalink to &quot;Federate from the Shoot Prometheus to an External Prometheus&quot;">​</a></h4><p>Shoot owners that are interested in collecting metrics for their shoot&#39;s control-planes can do so by federating from their shoot Prometheus instances. This allows shoot owners to selectively pull metrics from the shoot Prometheus into their own Prometheus instance. Collecting shoot&#39;s control-plane metrics by directly scraping control-plane resources will not work because such resources are managed by Gardener and are either not accessible to shoot owners or are behind a load balancer.</p><p>Note Gardener is working on an OpenTelemetry-based approach for observability, but there is no official timeline for its release yet.</p><h5 id="step-1-retrieve-prometheus-credentials-and-url" tabindex="-1">Step 1: Retrieve Prometheus Credentials and URL <a class="header-anchor" href="#step-1-retrieve-prometheus-credentials-and-url" aria-label="Permalink to &quot;Step 1: Retrieve Prometheus Credentials and URL&quot;">​</a></h5><p>Gardener provides access to the shoot control plane Prometheus instance through a monitoring secret stored in the virtual garden cluster. The necessary credentials can be found in the dashboard or by following these steps:</p><ol><li><p>Target the shoot&#39;s project using <code>gardenctl</code>:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gardenctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> target</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --garden</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">garden-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --project</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">project-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div></li><li><p>Retrieve the shoot&#39;s monitoring secret:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secret</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot-nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.monitoring</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yaml</span></span></code></pre></div></li><li><p>Extract the Prometheus URL from the secret’s annotations:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">metadata.annotations.prometheus-url</span></span></code></pre></div></li><li><p>Extract the credentials from the secret’s data fields:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get secret </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot-name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.monitoring </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jsonpath=&#39;{.data.username}&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> base64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --decode</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kubectl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> get secret </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">shoot-name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.monitoring </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jsonpath=&#39;{.data.password}&#39; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> base64</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --decode</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot;</span></span></code></pre></div></li></ol><h5 id="step-2-configure-federation-in-your-prometheus" tabindex="-1">Step 2: Configure Federation in Your Prometheus <a class="header-anchor" href="#step-2-configure-federation-in-your-prometheus" aria-label="Permalink to &quot;Step 2: Configure Federation in Your Prometheus&quot;">​</a></h5><p>Once the Prometheus URL, username, and password are obtained, federation can be configured in the external Prometheus instance.</p><ol><li><p>Edit the external Prometheus configuration to add a federation job:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">scrape_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">job_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gardener-federation&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    honor_labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    metrics_path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/federate&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    params</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;match[]&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;{job=&quot;kube-apiserver&quot;}&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    scheme</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    basic_auth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&lt;prometheus-username&gt;&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      password</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&lt;prometheus-password&gt;&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    static_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">targets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&lt;prometheus-url&gt;&#39;</span></span></code></pre></div><p>Replace <code>&lt;prometheus-username&gt;</code>, <code>&lt;prometheus-password&gt;</code>, and <code>&lt;prometheus-url&gt;</code> with the values obtained earlier. In this example, the federation job is configured to federate metrics scraped by the <code>kube-apiserver</code> job, but <code>match[]</code> entry should be adjusted to the specific use-case.</p></li><li><p>Restart Prometheus to apply the configuration.</p></li></ol><h2 id="collect-all-shoot-prometheus-with-remote-write" tabindex="-1">Collect all shoot Prometheus with remote write <a class="header-anchor" href="#collect-all-shoot-prometheus-with-remote-write" aria-label="Permalink to &quot;Collect all shoot Prometheus with remote write&quot;">​</a></h2><p>An optional collection of all shoot Prometheus metrics to a central Prometheus (or cortex) instance is possible with the <code>monitoring.shoot</code> setting in <code>GardenletConfiguration</code>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>monitoring:</span></span>
<span class="line"><span>  shoot:</span></span>
<span class="line"><span>    remoteWrite:</span></span>
<span class="line"><span>      url: https://remoteWriteUrl # remote write URL</span></span>
<span class="line"><span>      keep:# metrics that should be forwarded to the external write endpoint. If empty all metrics get forwarded</span></span>
<span class="line"><span>      - kube_pod_container_info</span></span>
<span class="line"><span>    externalLabels: # add additional labels to metrics to identify it on the central instance</span></span>
<span class="line"><span>      additional: label</span></span></code></pre></div><p>If basic auth is needed it can be set via secret in garden namespace (Gardener API Server). <a href="https://github.com/gardener/gardener/blob/master/example/10-secret-remote-write.yaml" target="_blank" rel="noreferrer">Example secret</a></p><h2 id="disable-gardener-monitoring" tabindex="-1">Disable Gardener Monitoring <a class="header-anchor" href="#disable-gardener-monitoring" aria-label="Permalink to &quot;Disable Gardener Monitoring&quot;">​</a></h2><p>If you wish to disable metric collection for every shoot and roll your own then you can simply set.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>monitoring:</span></span>
<span class="line"><span>  shoot:</span></span>
<span class="line"><span>    enabled: false</span></span></code></pre></div>`,41)]))}const m=a(r,[["render",o]]);export{u as __pageData,m as default};
