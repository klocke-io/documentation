import{_ as t,c as o,o as r,a2 as n}from"./chunks/framework.Bfq10Vlj.js";const u=JSON.parse('{"title":"Developer Docs for Gardener Extension Registry Cache","description":"Learn about the inner workings","frontmatter":{"description":"Learn about the inner workings","github_repo":"https://github.com/gardener/gardener-extension-registry-cache","github_subdir":"docs/development","params":{"github_branch":"main"},"path_base_for_github_subdir":{"from":"content/docs/extensions/others/gardener-extension-registry-cache/extension-registry-cache.md","to":"extension-registry-cache.md"},"persona":"Developers","title":"Developer Docs for Gardener Extension Registry Cache","prev":false,"next":false},"headers":[],"relativePath":"docs/extensions/others/gardener-extension-registry-cache/extension-registry-cache/index.md","filePath":"docs/extensions/others/gardener-extension-registry-cache/extension-registry-cache.md","lastUpdated":null}'),i={name:"docs/extensions/others/gardener-extension-registry-cache/extension-registry-cache/index.md"};function s(a,e,c,h,l,d){return r(),o("div",null,e[0]||(e[0]=[n('<h1 id="developer-docs-for-gardener-extension-registry-cache" tabindex="-1">Developer Docs for Gardener Extension Registry Cache <a class="header-anchor" href="#developer-docs-for-gardener-extension-registry-cache" aria-label="Permalink to &quot;Developer Docs for Gardener Extension Registry Cache&quot;">​</a></h1><p>This document outlines how Shoot reconciliation and deletion works for a Shoot with the registry-cache extension enabled.</p><h2 id="shoot-reconciliation" tabindex="-1">Shoot Reconciliation <a class="header-anchor" href="#shoot-reconciliation" aria-label="Permalink to &quot;Shoot Reconciliation&quot;">​</a></h2><p>This section outlines how the reconciliation works for a Shoot with the registry-cache extension enabled.</p><h3 id="extension-enablement-reconciliation" tabindex="-1">Extension Enablement / Reconciliation <a class="header-anchor" href="#extension-enablement-reconciliation" aria-label="Permalink to &quot;Extension Enablement / Reconciliation&quot;">​</a></h3><p>This section outlines how the extension enablement/reconciliation works, e.g., the extension has been added to the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href="/docs/gardener/extensions/resources/extension/">Extension</a> resource.</li><li>The registry-cache extension reconciles the Extension resource. <a href="https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/controller/cache/actuator.go" target="_blank" rel="noreferrer">pkg/controller/cache/actuator.go</a> contains the implementation of the <a href="https://github.com/gardener/gardener/blob/v1.88.0/extensions/pkg/controller/extension/actuator.go" target="_blank" rel="noreferrer">extension.Actuator</a> interface. The reconciliation of an Extension of type <code>registry-cache</code> consists of the following steps: <ol><li>The registry-cache extension deploys resources to the Shoot cluster via ManagedResource. For every configured upstream, it creates a StatefulSet (with PVC), Service, and other resources.</li><li>It lists all Services from the <code>kube-system</code> namespace that have the <code>upstream-host</code> label. It will return an error (and retry in exponential backoff) until the Services count matches the configured registries count.</li><li>When there is a Service created for each configured upstream registry, the registry-cache extension populates the Extension resource status. In the Extension status, for each upstream, it maintains an endpoint (in the format <code>http://&lt;cluster-ip&gt;:5000</code>) which can be used to access the registry cache from within the Shoot cluster. <code>&lt;cluster-ip&gt;</code> is the cluster IP of the registry cache Service. The cluster IP of a Service is assigned by the Kubernetes API server on Service creation.</li></ol></li><li>As part of the Shoot reconciliation flow, the gardenlet deploys the <a href="/docs/gardener/extensions/resources/operatingsystemconfig/">OperatingSystemConfig</a> resource.</li><li>The registry-cache extension serves a webhook that mutates the OperatingSystemConfig resource for Shoots having the registry-cache extension enabled (the corresponding namespace gets labeled by the gardenlet with <code>extensions.gardener.cloud/registry-cache=true</code>). <a href="https://github.com/gardener/gardener-extension-registry-cache/blob/main/pkg/webhook/cache/ensurer.go" target="_blank" rel="noreferrer">pkg/webhook/cache/ensurer.go</a> contains an implementation of the <a href="https://github.com/gardener/gardener/blob/v1.88.0/extensions/pkg/webhook/controlplane/genericmutator/mutator.go" target="_blank" rel="noreferrer">genericmutator.Ensurer</a> interface. <ol><li>The webhook appends or updates <code>RegistryConfig</code> entries in the <a href="/docs/gardener/extensions/resources/operatingsystemconfig/#cri-support">OperatingSystemConfig CRI</a> configuration that corresponds to configured registry caches in the Shoot. The <code>RegistryConfig</code> readiness probe is enabled so that <a href="/docs/gardener/concepts/node-agent/">gardener-node-agent</a> creates a <code>hosts.toml</code> containerd registry configuration file when all <code>RegistryConfig</code> hosts are reachable.</li></ol></li></ol><h3 id="extension-disablement" tabindex="-1">Extension Disablement <a class="header-anchor" href="#extension-disablement" aria-label="Permalink to &quot;Extension Disablement&quot;">​</a></h3><p>This section outlines how the extension disablement works, i.e., the extension has to be removed from the Shoot spec.</p><ol><li>As part of the Shoot reconciliation flow, the gardenlet destroys the <a href="/docs/gardener/extensions/resources/extension/">Extension</a> resource because it is no longer needed. <ol><li>The extension deletes the ManagedResource containing the registry cache resources.</li><li>The OperatingSystemConfig resource will not be mutated and no <code>RegistryConfig</code> entries will be added or updated. The <a href="/docs/gardener/concepts/node-agent/">gardener-node-agent</a> detects that <code>RegistryConfig</code> entries have been removed or changed and deletes or updates corresponding <code>hosts.toml</code> configuration files under <code>/etc/containerd/certs.d</code> folder.</li></ol></li></ol><h2 id="shoot-deletion" tabindex="-1">Shoot Deletion <a class="header-anchor" href="#shoot-deletion" aria-label="Permalink to &quot;Shoot Deletion&quot;">​</a></h2><p>This section outlines how the deletion works for a Shoot with the registry-cache extension enabled.</p><ol><li>As part of the Shoot deletion flow, the gardenlet destroys the <a href="/docs/gardener/extensions/resources/extension/">Extension</a> resource. <ol><li>The extension deletes the ManagedResource containing the registry cache resources.</li></ol></li></ol>',13)]))}const p=t(i,[["render",s]]);export{u as __pageData,p as default};
