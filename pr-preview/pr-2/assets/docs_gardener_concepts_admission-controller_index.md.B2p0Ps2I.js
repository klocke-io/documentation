import{_ as s,c as a,o as i,a2 as t}from"./chunks/framework.B8WFj13S.js";const u=JSON.parse('{"title":"Gardener Admission Controller","description":"Functions and list of handlers for the Gardener Admission Controller","frontmatter":{"description":"Functions and list of handlers for the Gardener Admission Controller","github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/concepts","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/concepts/admission-controller.md","to":"admission-controller.md"},"title":"Gardener Admission Controller","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/concepts/admission-controller/index.md","filePath":"docs/gardener/concepts/admission-controller.md","lastUpdated":null}'),n={name:"docs/gardener/concepts/admission-controller/index.md"};function o(r,e,l,d,h,c){return i(),a("div",null,e[0]||(e[0]=[t(`<h1 id="gardener-admission-controller" tabindex="-1">Gardener Admission Controller <a class="header-anchor" href="#gardener-admission-controller" aria-label="Permalink to &quot;Gardener Admission Controller&quot;">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>While the Gardener API server works with <a href="documentation/pr-preview/pr-2/docs/gardener/concepts/apiserver-admission-plugins/">admission plugins</a> to validate and mutate resources belonging to Gardener related API groups, e.g. <code>core.gardener.cloud</code>, the same is needed for resources belonging to non-Gardener API groups as well, e.g. secrets in the <code>core</code> API group. Therefore, the Gardener Admission Controller runs a http(s) server with the following handlers which serve as validating/mutating endpoints for <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noreferrer">admission webhooks</a>. It is also used to serve http(s) handlers for authorization webhooks.</p><h2 id="admission-webhook-handlers" tabindex="-1">Admission Webhook Handlers <a class="header-anchor" href="#admission-webhook-handlers" aria-label="Permalink to &quot;Admission Webhook Handlers&quot;">​</a></h2><p>This section describes the admission webhook handlers that are currently served.</p><h3 id="authentication-configuration-validator" tabindex="-1">Authentication Configuration Validator <a class="header-anchor" href="#authentication-configuration-validator" aria-label="Permalink to &quot;Authentication Configuration Validator&quot;">​</a></h3><p>In <code>Shoot</code>s, it is possible to reference <a href="https://kubernetes.io/blog/2024/04/25/structured-authentication-moves-to-beta" target="_blank" rel="noreferrer">structured authentication configurations</a>. This validation handler validates that such configurations are valid.</p><h3 id="authorization-configuration-validator" tabindex="-1">Authorization Configuration Validator <a class="header-anchor" href="#authorization-configuration-validator" aria-label="Permalink to &quot;Authorization Configuration Validator&quot;">​</a></h3><p>In <code>Shoot</code>s, it is possible to reference <a href="https://kubernetes.io/blog/2024/04/26/multi-webhook-and-modular-authorization-made-much-easier" target="_blank" rel="noreferrer">structured authorization configurations</a>. This validation handler validates that such configurations are valid.</p><h3 id="admission-plugin-secret-validator" tabindex="-1">Admission Plugin Secret Validator <a class="header-anchor" href="#admission-plugin-secret-validator" aria-label="Permalink to &quot;Admission Plugin Secret Validator&quot;">​</a></h3><p>In <code>Shoot</code>s, <code>AdmissionPlugin</code> can have reference to other files. This validation handler validates the referred admission plugin secret and ensures that the secret always contains the required data <code>kubeconfig</code>.</p><h3 id="kubeconfig-secret-validator" tabindex="-1">Kubeconfig Secret Validator <a class="header-anchor" href="#kubeconfig-secret-validator" aria-label="Permalink to &quot;Kubeconfig Secret Validator&quot;">​</a></h3><p><a href="https://github.com/kubernetes/kubectl/issues/697" target="_blank" rel="noreferrer">Malicious Kubeconfigs</a> applied by end users may cause a leakage of sensitive data. This handler checks if the incoming request contains a Kubernetes secret with a <code>.data.kubeconfig</code> field and denies the request if the Kubeconfig structure violates Gardener&#39;s security standards.</p><h3 id="namespace-validator" tabindex="-1">Namespace Validator <a class="header-anchor" href="#namespace-validator" aria-label="Permalink to &quot;Namespace Validator&quot;">​</a></h3><p>Namespaces are the backing entities of Gardener projects in which shoot cluster objects reside. This validation handler protects active namespaces against premature deletion requests. Therefore, it denies deletion requests if a namespace still contains shoot clusters or if it belongs to a non-deleting Gardener project (without <code>.metadata.deletionTimestamp</code>).</p><h3 id="resource-size-validator" tabindex="-1">Resource Size Validator <a class="header-anchor" href="#resource-size-validator" aria-label="Permalink to &quot;Resource Size Validator&quot;">​</a></h3><p>Since users directly apply Kubernetes native objects to the Garden cluster, it also involves the risk of being vulnerable to DoS attacks because these resources are continuously watched and read by controllers. One example is the creation of shoot resources with large annotation values (up to 256 kB per value), which can cause severe out-of-memory issues for the gardenlet component. <a href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler" target="_blank" rel="noreferrer">Vertical autoscaling</a> can help to mitigate such situations, but we cannot expect to scale infinitely, and thus need means to block the attack itself.</p><p>The Resource Size Validator checks arbitrary incoming admission requests against a configured maximum size for the resource&#39;s group-version-kind combination. It denies the request if the object exceeds the quota.</p><div class="note custom-block github-alert"><p class="custom-block-title">NOTE</p><p>The contents of <code>status</code> subresources and <code>metadata.managedFields</code> are not taken into account for the resource size calculation.</p></div><p>Example for Gardener Admission Controller configuration:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  resourceAdmissionConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    limits</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiGroups</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;core.gardener.cloud&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;*&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      resources</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shoots&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">100k</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiGroups</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;v1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      resources</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;secrets&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">100k</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    unrestrictedSubjects</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Group</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">gardener.cloud:system:seeds</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiGroup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #  - kind: User</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #    name: admin</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #    apiGroup: rbac.authorization.k8s.io</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #  - kind: ServiceAccount</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #    name: &quot;*&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #    namespace: garden</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #    apiGroup: &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    operationMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">block</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #log</span></span></code></pre></div><p>With the configuration above, the Resource Size Validator denies requests for shoots with Gardener&#39;s core API group which exceed a size of 100 kB. The same is done for Kubernetes secrets.</p><p>As this feature is meant to protect the system from malicious requests sent by users, it is recommended to exclude trusted groups, users or service accounts from the size restriction via <code>resourceAdmissionConfiguration.unrestrictedSubjects</code>. For example, the backing user for the gardenlet should always be capable of changing the shoot resource instead of being blocked due to size restrictions. This is because the gardenlet itself occasionally changes the shoot specification, labels or annotations, and might violate the quota if the existing resource is already close to the quota boundary. Also, operators are supposed to be trusted users and subjecting them to a size limitation can inhibit important operational tasks. Wildcard (&quot;*&quot;) in subject <code>name</code> is supported.</p><p>Size limitations depend on the individual Gardener setup and choosing the wrong values can affect the availability of your Gardener service. <code>resourceAdmissionConfiguration.operationMode</code> allows to control if a violating request is actually denied (default) or only logged. It&#39;s recommended to start with <code>log</code>, check the logs for exceeding requests, adjust the limits if necessary and finally switch to <code>block</code>.</p><h3 id="seedrestriction" tabindex="-1">SeedRestriction <a class="header-anchor" href="#seedrestriction" aria-label="Permalink to &quot;SeedRestriction&quot;">​</a></h3><p>Please refer to <a href="documentation/pr-preview/pr-2/docs/gardener/deployment/gardenlet_api_access/">Scoped API Access for Gardenlets</a> for more information.</p><h3 id="updaterestriction" tabindex="-1">UpdateRestriction <a class="header-anchor" href="#updaterestriction" aria-label="Permalink to &quot;UpdateRestriction&quot;">​</a></h3><p>Gardener stores public data regarding shoot clusters, i.e. certificate authority bundles, OIDC discovery documents, etc. This information can be used by third parties so that they establish trust to specific authorities, making the integrity of the stored data extremely important in a way that any unwanted modifications can be considered a security risk. This handler protects <code>secrets</code> and <code>configmaps</code> against tampering. It denies <code>CREATE</code>, <code>UPDATE</code> and <code>DELETE</code> requests if the resource is labeled with <code>gardener.cloud/update-restriction=true</code> and the request is not made by a <code>gardenlet</code>.</p><p>In addition, the following service accounts are allowed to perform certain operations:</p><ul><li><code>system:serviceaccount:kube-system:generic-garbage-collector</code> is allowed to <code>DELETE</code> restricted resources.</li><li><code>system:serviceaccount:kube-system:gardener-internal</code> is allowed to <code>UPDATE</code> restricted resources.</li></ul><h2 id="authorization-webhook-handlers" tabindex="-1">Authorization Webhook Handlers <a class="header-anchor" href="#authorization-webhook-handlers" aria-label="Permalink to &quot;Authorization Webhook Handlers&quot;">​</a></h2><p>This section describes the authorization webhook handlers that are currently served.</p><h3 id="seedauthorization" tabindex="-1">SeedAuthorization <a class="header-anchor" href="#seedauthorization" aria-label="Permalink to &quot;SeedAuthorization&quot;">​</a></h3><p>Please refer to <a href="documentation/pr-preview/pr-2/docs/gardener/deployment/gardenlet_api_access/">Scoped API Access for Gardenlets</a> for more information.</p>`,34)]))}const k=s(n,[["render",o]]);export{u as __pageData,k as default};
