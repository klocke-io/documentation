import{_ as s,c as i,o as a,a2 as t}from"./chunks/framework.B8WFj13S.js";const c=JSON.parse('{"title":"Logging Guidelines","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/development","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/logging-guidelines.md","to":"logging-guidelines.md"},"persona":"Developers","title":"Logging Guidelines","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/logging-guidelines/index.md","filePath":"docs/gardener/logging-guidelines.md","lastUpdated":null}'),n={name:"docs/gardener/logging-guidelines/index.md"};function o(l,e,r,h,p,g){return a(),i("div",null,e[0]||(e[0]=[t(`<h1 id="logging-guidelines-in-gardener-components" tabindex="-1">Logging Guidelines in Gardener Components <a class="header-anchor" href="#logging-guidelines-in-gardener-components" aria-label="Permalink to &quot;Logging Guidelines in Gardener Components&quot;">​</a></h1><p>This document aims at providing a general developer guideline on different aspects of logging practices and conventions used in the Gardener codebase. It contains mostly Gardener-specific points, and references other existing and commonly accepted logging guidelines for general advice. Developers and reviewers should consult this guide when writing, refactoring, and reviewing Gardener code. If parts are unclear or new learnings arise, this guide should be adapted accordingly.</p><h2 id="logging-libraries-implementations" tabindex="-1">Logging Libraries / Implementations <a class="header-anchor" href="#logging-libraries-implementations" aria-label="Permalink to &quot;Logging Libraries / Implementations&quot;">​</a></h2><p>Historically, Gardener components have been using <a href="https://github.com/sirupsen/logrus" target="_blank" rel="noreferrer">logrus</a>. There is a global logrus logger (<a href="https://github.com/gardener/gardener/blob/626ba7c10e1150819b3905116d3988512c18c9ee/pkg/logger/logrus.go#L28" target="_blank" rel="noreferrer"><code>logger.Logger</code></a>) that is initialized by components on startup and used across the codebase. In most places, it is used as a <code>printf</code>-style logger and only in some instances we make use of logrus&#39; structured logging functionality.</p><p>In the process of migrating our components to native controller-runtime components (see <a href="https://github.com/gardener/gardener/issues/4251" target="_blank" rel="noreferrer">gardener/gardener#4251</a>), we also want to make use of controller-runtime&#39;s built-in mechanisms for streamlined logging. controller-runtime uses <a href="https://github.com/go-logr/logr" target="_blank" rel="noreferrer">logr</a>, a simple structured logging interface, for library-internal logging and logging in controllers.</p><p>logr itself is only an interface and doesn&#39;t provide an implementation out of the box. Instead, it needs to be backed by a logging implementation like <a href="https://github.com/go-logr/zapr" target="_blank" rel="noreferrer">zapr</a>. Code that uses the logr interface is thereby not tied to a specific logging implementation and makes the implementation easily exchangeable. controller-runtime already provides a <a href="https://github.com/kubernetes-sigs/controller-runtime/tree/v0.11.0/pkg/log/zap" target="_blank" rel="noreferrer">set of helpers</a> for constructing zapr loggers, i.e., logr loggers backed by <a href="https://github.com/uber-go/zap" target="_blank" rel="noreferrer">zap</a>, which is a popular logging library in the go community. Hence, we are migrating our component logging from logrus to logr (backed by zap) as part of <a href="https://github.com/gardener/gardener/issues/4251" target="_blank" rel="noreferrer">gardener/gardener#4251</a>.</p><blockquote><p>⚠️ <code>logger.Logger</code> (logrus logger) is deprecated in Gardener and shall not be used in new code – use logr loggers when writing new code! (also see <a href="/documentation/pr-preview/pr-2/docs/gardener/logging-guidelines/#migration-from-logrus-to-logr">Migration from logrus to logr</a>)</p><p>ℹ️ Don&#39;t use zap loggers directly, always use the logr interface in order to avoid tight coupling to a specific logging implementation.</p></blockquote><p>gardener-apiserver differs from the other components as it is based on the <a href="https://github.com/kubernetes/apiserver" target="_blank" rel="noreferrer">apiserver library</a> and therefore uses <a href="https://github.com/kubernetes/klog" target="_blank" rel="noreferrer">klog</a> – just like kube-apiserver. As gardener-apiserver writes (almost) no logs in our coding (outside the apiserver library), there is currently no plan for switching the logging implementation. Hence, the following sections focus on logging in the controller and admission components only.</p><h2 id="logcheck-tool" tabindex="-1"><code>logcheck</code> Tool <a class="header-anchor" href="#logcheck-tool" aria-label="Permalink to &quot;\`logcheck\` Tool&quot;">​</a></h2><p>To ensure a smooth migration to logr and make logging in Gardener components more consistent, the <a href="https://github.com/gardener/gardener/tree/master/hack/tools/logcheck" target="_blank" rel="noreferrer"><code>logcheck</code> tool</a> was added. It enforces (parts of) this guideline and detects programmer-level errors early on in order to prevent bugs. Please check out the <a href="https://github.com/gardener/gardener/tree/master/hack/tools/logcheck" target="_blank" rel="noreferrer">tool&#39;s documentation</a> for a detailed description.</p><h2 id="structured-logging" tabindex="-1">Structured Logging <a class="header-anchor" href="#structured-logging" aria-label="Permalink to &quot;Structured Logging&quot;">​</a></h2><p>Similar to <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/migration-to-structured-logging.md" target="_blank" rel="noreferrer">efforts in the Kubernetes project</a>, we want to migrate our component logs to structured logging. As motivated above, we will use the logr interface instead of klog though.</p><p>You can read more about the motivation behind structured logging in <a href="https://github.com/go-logr/logr#background" target="_blank" rel="noreferrer">logr&#39;s background and FAQ</a> (also see <a href="http://dave.cheney.net/2015/11/05/lets-talk-about-logging" target="_blank" rel="noreferrer">this blog post by Dave Cheney</a>). Also, make sure to check out controller-runtime&#39;s <a href="https://github.com/kubernetes-sigs/controller-runtime/blob/v0.11.0/TMP-LOGGING.md" target="_blank" rel="noreferrer">logging guideline</a> with specifics for projects using the library. The following sections will focus on the most important takeaways from those guidelines and give general instructions on how to apply them to Gardener and its controller-runtime components.</p><blockquote><p>Note: Some parts in this guideline differ slightly from controller-runtime&#39;s document.</p></blockquote><h3 id="tl-dr-of-structured-logging" tabindex="-1">TL;DR of Structured Logging <a class="header-anchor" href="#tl-dr-of-structured-logging" aria-label="Permalink to &quot;TL;DR of Structured Logging&quot;">​</a></h3><p>❌ Stop using <code>printf</code>-style logging:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> logger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">logrus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Logger</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Infof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Scaling deployment </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replicas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, deployment.Namespace, deployment.Name, replicaCount)</span></span></code></pre></div><p>✅ Instead, write static log messages and enrich them with additional structured information in form of key-value pairs:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> logger </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">logr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Logger</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Scaling deployment&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deployment&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ObjectKeyFromObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deployment), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;replicas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, replicaCount)</span></span></code></pre></div><h2 id="log-configuration" tabindex="-1">Log Configuration <a class="header-anchor" href="#log-configuration" aria-label="Permalink to &quot;Log Configuration&quot;">​</a></h2><p>Gardener components can be configured to either log in <code>json</code> (default) or <code>text</code> format: <code>json</code> format is supposed to be used in production, while <code>text</code> format might be nicer for development.</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># json</span></span>
<span class="line"><span>{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2021-12-16T08:32:21.059+0100&quot;,&quot;msg&quot;:&quot;Hello botanist&quot;,&quot;garden&quot;:&quot;eden&quot;}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># text</span></span>
<span class="line"><span>2021-12-16T08:32:21.059+0100    INFO    Hello botanist  {&quot;garden&quot;: &quot;eden&quot;}</span></span></code></pre></div><p>Components can be set to one of the following log levels (with increasing verbosity): <code>error</code>, <code>info</code> (default), <code>debug</code>.</p><h2 id="log-levels" tabindex="-1">Log Levels <a class="header-anchor" href="#log-levels" aria-label="Permalink to &quot;Log Levels&quot;">​</a></h2><p>logr uses <a href="https://github.com/go-logr/logr#why-v-levels" target="_blank" rel="noreferrer">V-levels</a> (numbered log levels), higher V-level means higher verbosity. V-levels are relative (in contrast to <code>klog</code>&#39;s absolute V-levels), i.e., <code>V(1)</code> creates a logger, that is one level more verbose than its parent logger.</p><p>In Gardener components, the mentioned log levels in the component config (<code>error</code>, <code>info</code>, <code>debug</code>) map to the zap levels with the same names (see <a href="https://github.com/gardener/gardener/blob/770fc01a34b70f6cb77b8cfe929d9daef0026d1c/pkg/logger/zap.go#L43-L55" target="_blank" rel="noreferrer">here</a>). Hence, our loggers follow the same mapping from numerical logr levels to named zap levels like described in <a href="https://github.com/go-logr/zapr/tree/v1.1.0#increasing-verbosity" target="_blank" rel="noreferrer">zapr</a>, i.e.:</p><ul><li>component config specifies <code>debug</code> ➡️ both <code>V(0)</code> and <code>V(1)</code> are enabled</li><li>component config specifies <code>info</code> ➡️ <code>V(0)</code> is enabled, <code>V(1)</code> will not be shown</li><li>component config specifies <code>error</code> ➡️ neither <code>V(0)</code> nor <code>V(1)</code> will be shown</li><li><code>Error()</code> logs will always be shown</li></ul><p>This mapping applies to the components&#39; root loggers (the ones that are not &quot;derived&quot; from any other logger; constructed on component startup). If you derive a new logger with e.g. <code>V(1)</code>, the mapping will shift by one. For example, <code>V(0)</code> will then log at zap&#39;s <code>debug</code> level.</p><p>There is no <code>warning</code> level (see <a href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging" target="_blank" rel="noreferrer">Dave Cheney&#39;s post</a>). If there is an error condition (e.g., unexpected error received from a called function), the error should either be handled or logged at <code>error</code> if it is neither handled nor returned. If you have an <code>error</code> value at hand that doesn&#39;t represent an actual error condition, but you still want to log it as an informational message, log it at <code>info</code> level with key <code>err</code>.</p><p>We might consider to make use of a broader range of log levels in the future when introducing more logs and common command line flags for our components (comparable to <code>--v</code> of Kubernetes components). For now, we stick to the mentioned two log levels like controller-runtime: info (<code>V(0)</code>) and debug (<code>V(1)</code>).</p><h2 id="logging-in-controllers" tabindex="-1">Logging in Controllers <a class="header-anchor" href="#logging-in-controllers" aria-label="Permalink to &quot;Logging in Controllers&quot;">​</a></h2><h3 id="named-loggers" tabindex="-1">Named Loggers <a class="header-anchor" href="#named-loggers" aria-label="Permalink to &quot;Named Loggers&quot;">​</a></h3><p>Controllers should use named loggers that include their name, e.g.:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">controllerLogger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rootLogger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;controller&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;shoot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">controllerLogger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Deploying kube-apiserver&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>results in</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>2021-12-16T09:27:56.550+0100    INFO    controller.shoot    Deploying kube-apiserver</span></span></code></pre></div><p>Logger names are hierarchical. You can make use of it, where controllers are composed of multiple &quot;subcontrollers&quot;, e.g., <code>controller.shoot.hibernation</code> or <code>controller.shoot.maintenance</code>.</p><p>Using the global logger <code>logf.Log</code> directly is discouraged and should be rather exceptional because it makes correlating logs with code harder. Preferably, all parts of the code should use some named logger.</p><h3 id="reconciler-loggers" tabindex="-1">Reconciler Loggers <a class="header-anchor" href="#reconciler-loggers" aria-label="Permalink to &quot;Reconciler Loggers&quot;">​</a></h3><p>In your <code>Reconcile</code> function, retrieve a logger from the given <code>context.Context</code>. It inherits from the controller&#39;s logger (i.e., is already named) and is preconfigured with <code>name</code> and <code>namespace</code> values for the reconciliation request:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reconciler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Reconcile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">request</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reconcile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reconcile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  log </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> logf.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">FromContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Reconciling Shoot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> reconcile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>results in</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>2021-12-16T09:35:59.099+0100    INFO    controller.shoot    Reconciling Shoot        {&quot;name&quot;: &quot;sunflower&quot;, &quot;namespace&quot;: &quot;garden-greenhouse&quot;}</span></span></code></pre></div><p>The logger is injected by controller-runtime&#39;s <code>Controller</code> implementation. The logger returned by <code>logf.FromContext</code> is never <code>nil</code>. If the context doesn&#39;t carry a logger, it falls back to the global logger (<code>logf.Log</code>), which might discard logs if not configured, but is also never <code>nil</code>.</p><blockquote><p>⚠️ Make sure that you don&#39;t overwrite the <code>name</code> or <code>namespace</code> value keys for such loggers, otherwise you will lose information about the reconciled object.</p></blockquote><p>The controller implementation (controller-runtime) itself takes care of logging the error returned by reconcilers. Hence, don&#39;t log an error that you are returning. Generally, functions should not return an error, if they already logged it, because that means the error is already handled and not an error anymore. See <a href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging" target="_blank" rel="noreferrer">Dave Cheney&#39;s post</a> for more on this.</p><h3 id="messages" tabindex="-1">Messages <a class="header-anchor" href="#messages" aria-label="Permalink to &quot;Messages&quot;">​</a></h3><ul><li>Log messages should be static. Don&#39;t put variable content in there, i.e., no <code>fmt.Sprintf</code> or string concatenation (<code>+</code>). Use key-value pairs instead.</li><li>Log messages should be capitalized. Note: This contrasts with error messages, that should not be capitalized. However, both should not end with a punctuation mark.</li></ul><h3 id="keys-and-values" tabindex="-1">Keys and Values <a class="header-anchor" href="#keys-and-values" aria-label="Permalink to &quot;Keys and Values&quot;">​</a></h3><ul><li><p>Use <code>WithValues</code> instead of repeatedly adding key-value pairs for multiple log statements. <code>WithValues</code> creates a new logger from the parent, that carries the given key-value pairs. E.g., use it when acting on one object in multiple steps and logging something for each step:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parentLog.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValues</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;infrastructure&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ObjectKeyFromObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(infrastructure))</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Creating Infrastructure&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Waiting for Infrastructure to be reconciled&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ...</span></span></code></pre></div></li></ul><blockquote><p>Note: <code>WithValues</code> bypasses controller-runtime&#39;s special zap encoder that nicely encodes <code>ObjectKey</code>/<code>NamespacedName</code> and <code>runtime.Object</code> values, see <a href="https://github.com/kubernetes-sigs/controller-runtime/issues/1290" target="_blank" rel="noreferrer">kubernetes-sigs/controller-runtime#1290</a>. Thus, the end result might look different depending on the value and its <code>Stringer</code> implementation.</p></blockquote><ul><li><p>Use <a href="https://en.wiktionary.org/wiki/lowerCamelCase" target="_blank" rel="noreferrer">lowerCamelCase</a> for keys. Don&#39;t put spaces in keys, as it will make log processing with simple tools like <code>jq</code> harder.</p></li><li><p>Keys should be constant, human-readable, consistent across the codebase and naturally match parts of the log message, see <a href="https://github.com/go-logr/logr#how-do-i-choose-my-keys" target="_blank" rel="noreferrer">logr guideline</a>.</p></li><li><p>When logging object keys (name and namespace), use the object&#39;s type as the log key and a <code>client.ObjectKey</code>/<code>types.NamespacedName</code> value as value, e.g.:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> deployment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">appsv1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Deployment</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Creating Deployment&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;deployment&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ObjectKeyFromObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(deployment))</span></span></code></pre></div><p>which results in</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2021-12-16T08:32:21.059+0100&quot;,&quot;msg&quot;:&quot;Creating Deployment&quot;,&quot;deployment&quot;:{&quot;name&quot;: &quot;bar&quot;, &quot;namespace&quot;: &quot;foo&quot;}}</span></span></code></pre></div></li><li><p>There are cases where you don&#39;t have the full object key or the object itself at hand, e.g., if an object references another object (in the same namespace) by name (think <code>secretRef</code> or similar). In such a cases, either construct the full object key including the implied namespace or log the object name under a key ending in <code>Name</code>, e.g.:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // object to reconcile</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  shoot </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gardencorev1beta1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // retrieved via logf.FromContext, preconfigured by controller with namespace and name of reconciliation request</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  log </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">logr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Logger</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// option a: full object key, manually constructed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Shoot uses SecretBinding&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;secretBinding&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ObjectKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{Namespace: shoot.Namespace, Name: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">shoot.Spec.SecretBindingName})</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// option b: only name under respective *Name log key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Shoot uses SecretBinding&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;secretBindingName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">shoot.Spec.SecretBindingName)</span></span></code></pre></div><p>Both options result in well-structured logs, that are easy to interpret and process:</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2022-01-18T18:00:56.672+0100&quot;,&quot;msg&quot;:&quot;Shoot uses SecretBinding&quot;,&quot;name&quot;:&quot;my-shoot&quot;,&quot;namespace&quot;:&quot;garden-project&quot;,&quot;secretBinding&quot;:{&quot;namespace&quot;:&quot;garden-project&quot;,&quot;name&quot;:&quot;aws&quot;}}</span></span>
<span class="line"><span>{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2022-01-18T18:00:56.673+0100&quot;,&quot;msg&quot;:&quot;Shoot uses SecretBinding&quot;,&quot;name&quot;:&quot;my-shoot&quot;,&quot;namespace&quot;:&quot;garden-project&quot;,&quot;secretBindingName&quot;:&quot;aws&quot;}</span></span></code></pre></div></li><li><p>When handling generic <code>client.Object</code> values (e.g. in helper funcs), use <code>object</code> as key.</p></li><li><p>When adding timestamps to key-value pairs, use <code>time.Time</code> values. By this, they will be encoded in the same format as the log entry&#39;s timestamp.<br> Don&#39;t use <code>metav1.Time</code> values, as they will be encoded in a different format by their <code>Stringer</code> implementation. Pass <code>&lt;someTimestamp&gt;.Time</code> to loggers in case you have a <code>metav1.Time</code> value at hand.</p></li><li><p>Same applies to durations. Use <code>time.Duration</code> values instead of <code>*metav1.Duration</code>. Durations can be handled specially by zap just like timestamps.</p></li><li><p>Event recorders not only create <code>Event</code> objects but also log them. However, both Gardener&#39;s manually instantiated event recorders and the ones that controller-runtime provides log to <code>debug</code> level and use generic formats, that are not very easy to interpret or process (no structured logs). Hence, don&#39;t use event recorders as replacements for well-structured logs. If a controller records an event for a completed action or important information, it should probably log it as well, e.g.:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Creating ManagedSeed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;replica&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GetObjectKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">a.recorder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Eventf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(managedSeedSet, corev1.EventTypeNormal, EventCreatingManagedSeed, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Creating ManagedSeed </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GetFullName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span></code></pre></div></li></ul><h2 id="logging-in-test-code" tabindex="-1">Logging in Test Code <a class="header-anchor" href="#logging-in-test-code" aria-label="Permalink to &quot;Logging in Test Code&quot;">​</a></h2><ul><li><p>If the tested production code requires a logger, you can pass <code>logr.Discard()</code> or <code>logf.NullLogger{}</code> in your test, which simply discards all logs.</p></li><li><p><code>logf.Log</code> is safe to use in tests and will not cause a nil pointer deref, even if it&#39;s not initialized via <code>logf.SetLogger</code>. It is initially set to a <code>NullLogger</code> by default, which means all logs are discarded, unless <code>logf.SetLogger</code> is called in the first 30 seconds of execution.</p></li><li><p>Pass <code>zap.WriteTo(GinkgoWriter)</code> in tests where you want to see the logs on test failure but not on success, for example:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">logf.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SetLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MustNewZapLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(logger.DebugLevel, logger.FormatJSON, zap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WriteTo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(GinkgoWriter)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">log </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> logf.Log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;test&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div></li></ul>`,54)]))}const k=s(n,[["render",o]]);export{c as __pageData,k as default};
