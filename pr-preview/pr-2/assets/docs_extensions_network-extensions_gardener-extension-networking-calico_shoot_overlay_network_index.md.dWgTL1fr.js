import{_ as a,c as i,o as e,a2 as n}from"./chunks/framework.B8WFj13S.js";const t="/documentation/pr-preview/pr-2/assets/overlay-network.drawio.CV-4awse.png",l="/documentation/pr-preview/pr-2/assets/no-overlay-network.drawio.DeZrK3Bo.png",E=JSON.parse('{"title":"Shoot Overlay Network","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener-extension-networking-calico","github_subdir":"docs/usage","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/extensions/network-extensions/gardener-extension-networking-calico/shoot_overlay_network.md","to":"shoot_overlay_network.md"},"persona":"Users","title":"Shoot Overlay Network","prev":false,"next":false},"headers":[],"relativePath":"docs/extensions/network-extensions/gardener-extension-networking-calico/shoot_overlay_network/index.md","filePath":"docs/extensions/network-extensions/gardener-extension-networking-calico/shoot_overlay_network.md","lastUpdated":null}'),o={name:"docs/extensions/network-extensions/gardener-extension-networking-calico/shoot_overlay_network/index.md"};function r(h,s,p,k,d,g){return e(),i("div",null,s[0]||(s[0]=[n('<h1 id="enable-disable-overlay-network-for-shoots-with-calico" tabindex="-1">Enable / disable overlay network for shoots with Calico <a class="header-anchor" href="#enable-disable-overlay-network-for-shoots-with-calico" aria-label="Permalink to &quot;Enable / disable overlay network for shoots with Calico&quot;">​</a></h1><p>Gardener can be used with or without the overlay network.</p><p>Starting versions:</p><ul><li><a href="https://github.com/gardener/gardener-extension-provider-gcp/releases/tag/v1.25.0" target="_blank" rel="noreferrer">provider-gcp@v1.25.0</a></li><li><a href="https://github.com/gardener/gardener-extension-provider-alicloud/releases/tag/v1.43.0" target="_blank" rel="noreferrer">provider-alicloud@v1.43.0</a></li><li><a href="https://github.com/gardener/gardener-extension-provider-aws/releases/tag/v1.38.2" target="_blank" rel="noreferrer">provider-aws@v1.38.2</a></li><li><a href="https://github.com/gardener/gardener-extension-provider-openstack/releases/tag/v1.30.0" target="_blank" rel="noreferrer">provider-openstack@v1.30.0</a></li></ul><p>The default configuration of shoot clusters is without overlay network.</p><h2 id="understanding-overlay-network" tabindex="-1">Understanding overlay network <a class="header-anchor" href="#understanding-overlay-network" aria-label="Permalink to &quot;Understanding overlay network&quot;">​</a></h2><p>The Overlay networking permits the routing of packets between multiples pods located on multiple nodes, even if the pod and the node network are not the same.</p><p>This is done through the encapsulation of pod packets in the node network so that the routing can be done as usual. We use <code>ipip</code> encapsulation with calico as default in case the overlay network is enabled. This (simply put) sends an IP packet as workload in another IP packet.</p><p><img src="'+t+'" alt=""></p><p>In order to simplify the troubleshooting of problems and reduce the latency of packets traveling between nodes, the overlay network is disabled by default as stated above for all new clusters.</p><p><img src="'+l+`" alt=""></p><p>This means that the routing is done directly through the VPC routing table. Basically, when a new node is created, it is assigned a slice (usually a /24) of the pod network. All future pods in that node are going to be in this slice. Then, the cloud-controller-manager updates the cloud provider router to add the new route (all packets within the network slice as destination should go to that node).</p><p>This has the advantage of:</p><ul><li>Doing less work for the node as encapsulation takes some CPU cycles.</li><li>The maximum transmission unit (MTU) is slightly bigger resulting in slightly better performance, i.e. potentially more workload bytes per packet.</li><li>More direct and simpler setup, which makes the problems much easier to troubleshoot.</li></ul><p><strong>In the case where multiple shoots are in the same VPC and the overlay network is disabled, if the pod&#39;s network is not configured properly, there is a very strong chance that some pod IP address might overlap, which is going to cause all sorts of funny problems.</strong> So, if someone asks you how to avoid that, they need to make sure that the podCIDRs for each shoot <strong>do not overlap with each other</strong>.</p><h2 id="enabling-the-overlay-network" tabindex="-1">Enabling the overlay network <a class="header-anchor" href="#enabling-the-overlay-network" aria-label="Permalink to &quot;Enabling the overlay network&quot;">​</a></h2><p>In certain cases, the overlay network might be preferable if, for example, the customer wants to create multiple clusters in the same VPC without ensuring there&#39;s no overlap between the pod networks.</p><p>To enable the overlay network, add the following to the shoot&#39;s YAML:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">calico</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    providerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">calico.networking.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      overlay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span></code></pre></div><h2 id="disabling-the-overlay-network" tabindex="-1">Disabling the overlay network <a class="header-anchor" href="#disabling-the-overlay-network" aria-label="Permalink to &quot;Disabling the overlay network&quot;">​</a></h2><p>Inversely, here is how to disable the overlay network:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">calico</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    providerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">calico.networking.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      overlay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span></code></pre></div><h2 id="using-vxlan-as-overlay" tabindex="-1">Using VXLAN as overlay <a class="header-anchor" href="#using-vxlan-as-overlay" aria-label="Permalink to &quot;Using VXLAN as overlay&quot;">​</a></h2><p>To enable the overlay network with VXLAN, add the following to the shoot&#39;s YAML:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">core.gardener.cloud/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Shoot</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">metadata</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">...</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  networking</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">calico</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    providerConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      apiVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">calico.networking.extensions.gardener.cloud/v1alpha1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">NetworkConfig</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      overlay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      vxlan</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  ...</span></span></code></pre></div><h2 id="how-to-know-if-a-cluster-is-using-overlay-or-not" tabindex="-1">How to know if a cluster is using overlay or not? <a class="header-anchor" href="#how-to-know-if-a-cluster-is-using-overlay-or-not" aria-label="Permalink to &quot;How to know if a cluster is using overlay or not?&quot;">​</a></h2><p>You can look at any of the old nodes. If there are <code>tunl0</code> devices at least at some point in time the overlay network was used. Another way is to look into the Network object in the shoot&#39;s control plane namespace on the seed (see example above).</p><h2 id="do-we-have-some-documentation-somewhere-on-how-to-do-the-migration" tabindex="-1">Do we have some documentation somewhere on how to do the migration? <a class="header-anchor" href="#do-we-have-some-documentation-somewhere-on-how-to-do-the-migration" aria-label="Permalink to &quot;Do we have some documentation somewhere on how to do the migration?&quot;">​</a></h2><p>No, not yet. The migration from no overlay to overlay is fairly simply by just setting the configuration as specified above. The other way is more complicated as the Network configuration needs to be changed AND the local routes need to be cleaned. Unfortunately, the change will be rolled out slowly (one calico-node at a time). Hence, it implies some network outages during the migration.</p><h2 id="aws-implementation" tabindex="-1">AWS implementation <a class="header-anchor" href="#aws-implementation" aria-label="Permalink to &quot;AWS implementation&quot;">​</a></h2><p>On AWS, it is not possible to use the cloud-controller-manager for managing the routes as it does not support multiple route tables, which Gardener creates. Therefore, a custom controller is created to manage the routes.</p>`,31)]))}const y=a(o,[["render",r]]);export{E as __pageData,y as default};
