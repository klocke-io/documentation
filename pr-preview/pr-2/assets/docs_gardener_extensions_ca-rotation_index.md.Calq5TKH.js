import{_ as i,c as e,o as a,a2 as n}from"./chunks/framework.Bfq10Vlj.js";const d=JSON.parse('{"title":"CA Rotation","description":"","frontmatter":{"github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/extensions","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/extensions/ca-rotation.md","to":"ca-rotation.md"},"title":"CA Rotation","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/extensions/ca-rotation/index.md","filePath":"docs/gardener/extensions/ca-rotation.md","lastUpdated":null}'),t={name:"docs/gardener/extensions/ca-rotation/index.md"};function l(r,s,h,o,p,k){return a(),e("div",null,s[0]||(s[0]=[n(`<h1 id="ca-rotation-in-extensions" tabindex="-1">CA Rotation in Extensions <a class="header-anchor" href="#ca-rotation-in-extensions" aria-label="Permalink to &quot;CA Rotation in Extensions&quot;">​</a></h1><p><a href="https://github.com/gardener/gardener/blob/master/docs/proposals/18-shoot-CA-rotation.md" target="_blank" rel="noreferrer">GEP-18</a> proposes adding support for automated rotation of Shoot cluster certificate authorities (CAs). This document outlines all the requirements that Gardener extensions need to fulfill in order to support the CA rotation feature.</p><h2 id="requirements-for-shoot-cluster-ca-rotation" tabindex="-1">Requirements for Shoot Cluster CA Rotation <a class="header-anchor" href="#requirements-for-shoot-cluster-ca-rotation" aria-label="Permalink to &quot;Requirements for Shoot Cluster CA Rotation&quot;">​</a></h2><ul><li>Extensions must not rely on static CA <code>Secret</code> names managed by the gardenlet, because their names are changing during CA rotation.</li><li>Extensions cannot issue or use client certificates for authenticating against shoot API servers. Instead, they should use short-lived auto-rotated <code>ServiceAccount</code> tokens via gardener-resource-manager&#39;s <code>TokenRequestor</code>. Also see <a href="/docs/gardener/extensions/conventions/">Conventions</a> and <a href="/docs/gardener/concepts/resource-manager/#tokenrequestor"><code>TokenRequestor</code></a> documents.</li><li>Extensions need to generate dedicated CAs for signing server certificates (e.g. <code>cloud-controller-manager</code>). There should be one CA per controller and purpose in order to bind the lifecycle to the reconciliation cycle of the respective object for which it is created.</li><li>CAs managed by extensions should be rotated in lock-step with the shoot cluster CA. When the user triggers a rotation, the gardenlet writes phase and initiation time to <code>Shoot.status.credentials.rotation.certificateAuthorities.{phase,lastInitiationTime}</code>. See <a href="https://github.com/gardener/gardener/blob/master/docs/proposals/18-shoot-CA-rotation.md#rotation-sequence-for-cluster-and-client-ca" target="_blank" rel="noreferrer">GEP-18</a> for a detailed description on what needs to happen in each phase. Extensions can retrieve this information from <a href="/docs/gardener/extensions/cluster/"><code>Cluster.shoot.status</code></a>.</li></ul><h2 id="utilities-for-secrets-management" tabindex="-1">Utilities for Secrets Management <a class="header-anchor" href="#utilities-for-secrets-management" aria-label="Permalink to &quot;Utilities for Secrets Management&quot;">​</a></h2><p>In order to fulfill the requirements listed above, extension controllers can reuse the <a href="/docs/gardener/secrets_management/"><code>SecretsManager</code></a> that the gardenlet uses to manage all shoot cluster CAs, certificates, and other secrets as well. It implements the core logic for managing secrets that need to be rotated, auto-renewed, etc.</p><p>Additionally, there are utilities for reusing <code>SecretsManager</code> in extension controllers. They already implement the above requirements based on the <code>Cluster</code> resource and allow focusing on the extension controllers&#39; business logic.</p><p>For example, a simple <code>SecretsManager</code> usage in an extension controller could look like this:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // identity for SecretsManager instance in ControlPlane controller</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  identity</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;provider-foo-controlplane&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // secret config name of the dedicated CA</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  caControlPlaneName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ca-provider-foo-controlplane&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Reconcile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cluster </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">extensionscontroller</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Cluster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    client  </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">client</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Client</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // define wanted secrets with options</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    secretConfigs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">extensionssecretsmanager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SecretConfigWithOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // dedicated CA for ControlPlane controller</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Config: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">secretutils</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CertificateSecretConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          Name:       caControlPlaneName,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          CommonName: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ca-provider-foo-controlplane&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          CertType:   secretutils.CACert,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // persist CA so that it gets restored on control plane migration</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Options: []</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">secretsmanager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GenerateOption</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{secretsmanager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Persist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // server cert for control plane component</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Config: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">secretutils</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CertificateSecretConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          Name:       </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cloud-controller-manager&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          CommonName: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cloud-controller-manager&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          DNSNames:   kutil.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DNSNamesForService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cloud-controller-manager&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, namespace),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          CertType:   secretutils.ServerCert,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // sign with our dedicated CA</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Options: []</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">secretsmanager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GenerateOption</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{secretsmanager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SignedByCA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(caControlPlaneName)},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // initialize SecretsManager based on Cluster object</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  sm, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> extensionssecretsmanager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">SecretsManagerForCluster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;secretsmanager&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RealClock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}, client, cluster, identity, secretConfigs)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // generate all wanted secrets (first CAs, then the rest)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  secrets, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> extensionssecretsmanager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GenerateAllSecrets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, sm, secretConfigs)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // cleanup any secrets that are not needed any more (e.g. after rotation)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sm.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Cleanup</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Please pay attention to the following points:</p><ul><li>There should be one <code>SecretsManager</code> identity per controller in order to prevent conflicts between different instances. E.g., there should be different identities for <code>Infrastructrue</code>, <code>Worker</code>, <code>ControlPlane</code> controller, etc.</li><li>All other points in <a href="/docs/gardener/secrets_management/#reusing-the-secretsmanager-in-other-components">Reusing the SecretsManager in Other Components</a>.</li></ul>`,11)]))}const E=i(t,[["render",l]]);export{d as __pageData,E as default};
