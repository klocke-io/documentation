import{_ as t,c as s,o as a,a2 as o}from"./chunks/framework.B8WFj13S.js";const g=JSON.parse('{"title":"Testing","description":"","frontmatter":{"github_repo":"https://github.com/gardener/dependency-watchdog","github_subdir":"docs/development","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/other-components/dependency-watchdog/testing.md","to":"testing.md"},"persona":"Developers","title":"Testing","prev":false,"next":false},"headers":[],"relativePath":"docs/other-components/dependency-watchdog/testing/index.md","filePath":"docs/other-components/dependency-watchdog/testing.md","lastUpdated":null}'),i={name:"docs/other-components/dependency-watchdog/testing/index.md"};function r(n,e,l,d,h,c){return a(),s("div",null,e[0]||(e[0]=[o('<h1 id="testing-strategy-and-developer-guideline" tabindex="-1">Testing Strategy and Developer Guideline <a class="header-anchor" href="#testing-strategy-and-developer-guideline" aria-label="Permalink to &quot;Testing Strategy and Developer Guideline&quot;">​</a></h1><p>Intent of this document is to introduce you (the developer) to the following:</p><ul><li>Category of tests that exists.</li><li>Libraries that are used to write tests.</li><li>Best practices to write tests that are correct, stable, fast and maintainable.</li><li>How to run each category of tests.</li></ul><p>For any new contributions <strong>tests are a strict requirement</strong>. <code>Boy Scouts Rule</code> is followed: If you touch a code for which either no tests exist or coverage is insufficient then it is expected that you will add relevant tests.</p><h2 id="tools-used-for-writing-tests" tabindex="-1">Tools Used for Writing Tests <a class="header-anchor" href="#tools-used-for-writing-tests" aria-label="Permalink to &quot;Tools Used for Writing Tests&quot;">​</a></h2><p>These are the following tools that were used to write all the tests (unit + envtest + vanilla kind cluster tests), it is preferred not to introduce any additional tools / test frameworks for writing tests:</p><h3 id="gomega" tabindex="-1">Gomega <a class="header-anchor" href="#gomega" aria-label="Permalink to &quot;Gomega&quot;">​</a></h3><p>We use gomega as our matcher or assertion library. Refer to Gomega&#39;s <a href="https://onsi.github.io/gomega/" target="_blank" rel="noreferrer">official documentation</a> for details regarding its installation and application in tests.</p><h3 id="testing-package-from-standard-library" tabindex="-1"><code>Testing</code> Package from Standard Library <a class="header-anchor" href="#testing-package-from-standard-library" aria-label="Permalink to &quot;`Testing` Package from Standard Library&quot;">​</a></h3><p>We use the <code>Testing</code> package provided by the standard library in golang for writing all our tests. Refer to its <a href="https://pkg.go.dev/testing" target="_blank" rel="noreferrer">official documentation</a> to learn how to write tests using <code>Testing</code> package. You can also refer to <a href="https://go.dev/doc/tutorial/add-a-test" target="_blank" rel="noreferrer">this</a> example.</p><h2 id="writing-tests" tabindex="-1">Writing Tests <a class="header-anchor" href="#writing-tests" aria-label="Permalink to &quot;Writing Tests&quot;">​</a></h2><h3 id="common-for-all-kinds" tabindex="-1">Common for All Kinds <a class="header-anchor" href="#common-for-all-kinds" aria-label="Permalink to &quot;Common for All Kinds&quot;">​</a></h3><ul><li>For naming the individual tests (<code>TestXxx</code> and <code>testXxx</code> methods) and helper methods, make sure that the name describes the implementation of the method. For eg: <code>testScalingWhenMandatoryResourceNotFound</code> tests the behaviour of the <code>scaler</code> when a mandatory resource (KCM deployment) is not present.</li><li>Maintain proper logging in tests. Use <code>t.log()</code> method to add appropriate messages wherever necessary to describe the flow of the test. See <a href="https://github.com/gardener/dependency-watchdog/blob/master/controllers/endpoint/endpoints_controller_test.go" target="_blank" rel="noreferrer">this</a> for examples.</li><li>Make use of the <code>testdata</code> directory for storing arbitrary sample data needed by tests (YAML manifests, etc.). See <a href="https://github.com/gardener/dependency-watchdog/tree/master/controllers" target="_blank" rel="noreferrer">this</a> package for examples. <ul><li>From <a href="https://pkg.go.dev/cmd/go/internal/test:" target="_blank" rel="noreferrer">https://pkg.go.dev/cmd/go/internal/test:</a><blockquote><p>The go tool will ignore a directory named &quot;testdata&quot;, making it available to hold ancillary data needed by the tests.</p></blockquote></li></ul></li></ul><h3 id="table-driven-tests" tabindex="-1">Table-driven tests <a class="header-anchor" href="#table-driven-tests" aria-label="Permalink to &quot;Table-driven tests&quot;">​</a></h3><p>We need a tabular structure in two cases:</p><ul><li><strong>When we have multiple tests which require the same kind of setup</strong>:- In this case we have a <code>TestXxxSuite</code> method which will do the setup and run all the tests. We have a slice of <code>test</code> struct which holds all the tests (typically a <code>title</code> and <code>run</code> method). We use a <code>for</code> loop to run all the tests one by one. See <a href="https://github.com/gardener/dependency-watchdog/blob/master/controllers/cluster/cluster_controller_test.go" target="_blank" rel="noreferrer">this</a> for examples.</li><li><strong>When we have the same code path and multiple possible values to check</strong>:- In this case we have the arguments and expectations in a struct. We iterate through the slice of all such structs, passing the arguments to appropriate methods and checking if the expectation is met. See <a href="https://github.com/gardener/dependency-watchdog/blob/master/internal/prober/scaler/scaler_test.go" target="_blank" rel="noreferrer">this</a> for examples.</li></ul><h3 id="env-tests" tabindex="-1">Env Tests <a class="header-anchor" href="#env-tests" aria-label="Permalink to &quot;Env Tests&quot;">​</a></h3><p>Env tests in Dependency Watchdog use the <code>sigs.k8s.io/controller-runtime/pkg/envtest</code> package. It sets up a temporary control plane (etcd + kube-apiserver) and runs the test against it. The code to set up and teardown the environment can be checked out <a href="https://github.com/gardener/dependency-watchdog/blob/master/internal/test/testenv.go" target="_blank" rel="noreferrer">here</a>.</p><p>These are the points to be followed while writing tests that use <code>envtest</code> setup:</p><ul><li><p>All tests should be divided into two top level partitions:</p><ol><li>tests with common environment (<code>testXxxCommonEnvTests</code>)</li><li>tests which need a dedicated environment for each one. (<code>testXxxDedicatedEnvTests</code>)</li></ol><p>They should be contained within the <code>TestXxxSuite</code> method. See <a href="https://github.com/gardener/dependency-watchdog/blob/master/controllers/cluster/cluster_controller_test.go" target="_blank" rel="noreferrer">this</a> for examples. If all tests are of one kind then this is not needed.</p></li><li><p>Create a method named <code>setUpXxxTest</code> for performing setup tasks before all/each test. It should either return a method or have a separate method to perform teardown tasks. See <a href="https://github.com/gardener/dependency-watchdog/blob/master/controllers/cluster/cluster_controller_test.go" target="_blank" rel="noreferrer">this</a> for examples.</p></li><li><p>The tests run by the suite can be table-driven as well.</p></li><li><p>Use the <code>envtest</code> setup when there is a need of an environment close to an actual setup. Eg: start controllers against a real Kubernetes control plane to catch bugs that can only happen when talking to a real API server.</p></li></ul><blockquote><p>NOTE: It is currently not possible to bring up more than one envtest environments. See <a href="https://github.com/kubernetes-sigs/controller-runtime/issues/1363" target="_blank" rel="noreferrer">issue#1363</a>. We enforce running serial execution of test suites each of which uses a different envtest environments. See <a href="https://github.com/gardener/dependency-watchdog/blob/master/hack/test.sh" target="_blank" rel="noreferrer">hack/test.sh</a>.</p></blockquote><h3 id="vanilla-kind-cluster-tests" tabindex="-1">Vanilla Kind Cluster Tests <a class="header-anchor" href="#vanilla-kind-cluster-tests" aria-label="Permalink to &quot;Vanilla Kind Cluster Tests&quot;">​</a></h3><p>There are some tests where we need a vanilla kind cluster setup, for eg:- The <code>scaler.go</code> code in the <code>prober</code> package uses the <code>scale</code> subresource to scale the deployments mentioned in the prober config. But the <code>envtest</code> setup does not support the <code>scale</code> subresource as of now. So we need this setup to test if the deployments are scaled as per the config or not. You can check out the code for this setup <a href="https://github.com/gardener/dependency-watchdog/blob/master/internal/test/kind.go" target="_blank" rel="noreferrer">here</a>. You can add utility methods for different kubernetes and custom resources in there.</p><p>These are the points to be followed while writing tests that use <code>Vanilla Kind Cluster</code> setup:</p><ul><li>Use this setup only if there is a need of an actual Kubernetes cluster(api server + control plane + etcd) to write the tests. (Because this is slower than your normal <code>envTest</code> setup)</li><li>Create <code>setUpXxxTest</code> similar to the one in <code>envTest</code>. Follow the same structural pattern used in <code>envTest</code> for writing these tests. See <a href="https://github.com/gardener/dependency-watchdog/blob/master/internal/prober/scaler/scaler_test.go" target="_blank" rel="noreferrer">this</a> for examples.</li></ul><h2 id="run-tests" tabindex="-1">Run Tests <a class="header-anchor" href="#run-tests" aria-label="Permalink to &quot;Run Tests&quot;">​</a></h2><p>To run unit tests, use the following Makefile target</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span></span></code></pre></div><p>To run KIND cluster based tests, use the following Makefile target</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-tests</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # these tests will be slower as it brings up a vanilla KIND cluster</span></span></code></pre></div><p>To view coverage after running the tests, run :</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tool</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cover</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -html=cover.out</span></span></code></pre></div><h2 id="flaky-tests" tabindex="-1">Flaky tests <a class="header-anchor" href="#flaky-tests" aria-label="Permalink to &quot;Flaky tests&quot;">​</a></h2><p>If you see that a test is flaky then you can use <code>make stress</code> target which internally uses <a href="https://pkg.go.dev/golang.org/x/tools/cmd/stress" target="_blank" rel="noreferrer">stress tool</a></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stress</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test-package=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">test-packag</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test-func=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">test-fun</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tool-params=&quot;&lt;tool-params&gt;&quot;</span></span></code></pre></div><p>An example invocation:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stress</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test-package=./internal/util</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test-func=TestRetryUntilPredicateWithBackgroundContext</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tool-params=&quot;-p 10&quot;</span></span></code></pre></div><p>The make target will do the following:</p><ol><li>It will create a test binary for the package specified via <code>test-package</code> at <code>/tmp/pkg-stress.test</code> directory.</li><li>It will run <code>stress</code> tool passing the <code>tool-params</code> and targets the function <code>test-func</code>.</li></ol>',39)]))}const u=t(i,[["render",r]]);export{g as __pageData,u as default};
