import{_ as a,c as n,o as i,a2 as t}from"./chunks/framework.Bfq10Vlj.js";const u=JSON.parse('{"title":"Shoot Maintenance","description":"Defining the maintenance time window, configuring automatic version updates, confining reconciliations to only happen during maintenance, adding an additional maintenance operation, etc.","frontmatter":{"aliases":["/docs/gardener/shoot_maintenance/"],"description":"Defining the maintenance time window, configuring automatic version updates, confining reconciliations to only happen during maintenance, adding an additional maintenance operation, etc.","github_repo":"https://github.com/gardener/gardener","github_subdir":"docs/usage/shoot","params":{"github_branch":"master"},"path_base_for_github_subdir":{"from":"content/docs/gardener/shoot/shoot_maintenance.md","to":"shoot_maintenance.md"},"persona":"Users","title":"Shoot Maintenance","prev":false,"next":false},"headers":[],"relativePath":"docs/gardener/shoot/shoot_maintenance/index.md","filePath":"docs/gardener/shoot/shoot_maintenance.md","lastUpdated":null}'),s={name:"docs/gardener/shoot/shoot_maintenance/index.md"};function o(r,e,l,c,h,d){return i(),n("div",null,e[0]||(e[0]=[t(`<h1 id="shoot-maintenance" tabindex="-1">Shoot Maintenance <a class="header-anchor" href="#shoot-maintenance" aria-label="Permalink to &quot;Shoot Maintenance&quot;">​</a></h1><p>Shoots configure a maintenance time window in which Gardener performs certain operations that may restart the control plane, roll out the nodes, result in higher network traffic, etc. A summary of what was changed in the last maintenance time window in shoot specification is kept in the shoot status <code>.status.lastMaintenance</code> field.</p><p>This document outlines what happens during a shoot maintenance.</p><h2 id="time-window" tabindex="-1">Time Window <a class="header-anchor" href="#time-window" aria-label="Permalink to &quot;Time Window&quot;">​</a></h2><p>Via the <code>.spec.maintenance.timeWindow</code> field in the shoot specification, end-users can configure the time window in which maintenance operations are executed. Gardener runs one maintenance operation per day in this time window:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  maintenance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    timeWindow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      begin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">220000+0100</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">230000+0100</span></span></code></pre></div><p>The offset (<code>+0100</code>) is considered with respect to UTC time. The minimum time window is <code>30m</code> and the maximum is <code>6h</code>.</p><p>⚠️ Please note that there is no guarantee that a maintenance operation that, e.g., starts a node roll-out will finish <em>within</em> the time window. Especially for large clusters, it may take several hours until a graceful rolling update of the worker nodes succeeds (also depending on the workload and the configured pod disruption budgets/termination grace periods).</p><p>Internally, Gardener is subtracting <code>15m</code> from the end of the time window to (best-effort) try to finish the maintenance until the end is reached, however, this might not work in all cases.</p><p>If you don&#39;t specify a time window, then Gardener will randomly compute it. You can change it later, of course.</p><h2 id="automatic-version-updates" tabindex="-1">Automatic Version Updates <a class="header-anchor" href="#automatic-version-updates" aria-label="Permalink to &quot;Automatic Version Updates&quot;">​</a></h2><p>The <code>.spec.maintenance.autoUpdate</code> field in the shoot specification allows you to control how/whether automatic updates of Kubernetes patch and machine image versions are performed. Machine image versions are updated per worker pool.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  maintenance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    autoUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      kubernetesVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      machineImageVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><p>During the daily maintenance, the Gardener Controller Manager updates the Shoot&#39;s Kubernetes and machine image version if any of the following criteria applies:</p><ul><li>There is a higher version available and the Shoot opted-in for automatic version updates.</li><li>The currently used version is <code>expired</code>.</li></ul><p>The target version for machine image upgrades is controlled by the <code>updateStrategy</code> field for the machine image in the CloudProfile. Allowed update strategies are <code>patch</code>, <code>minor</code> and <code>major</code>.</p><p>Gardener (gardener-controller-manager) populates the <code>lastMaintenance</code> field in the Shoot status with the maintenance results.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Last Maintenance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:     </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;All maintenance operations successful. Control Plane: Updated Kubernetes version from 1.26.4 to 1.27.1. Reason: Kubernetes version expired - force update required&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:           </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Succeeded</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    Triggered Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2023-07-28T09:07:27Z</span></span></code></pre></div><p>Additionally, Gardener creates events with the type <code>MachineImageVersionMaintenance</code> or <code>KubernetesVersionMaintenance</code> on the Shoot describing the action performed during maintenance, including the reason why an update has been triggered.</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>LAST SEEN   TYPE      REASON                           OBJECT          MESSAGE</span></span>
<span class="line"><span>30m         Normal    MachineImageVersionMaintenance   shoot/local     Worker pool &quot;local&quot;: Updated image from &#39;gardenlinux&#39; version &#39;xy&#39; to version &#39;abc&#39;. Reason: Automatic update of the machine image version is configured (image update strategy: major).</span></span>
<span class="line"><span></span></span>
<span class="line"><span>30m         Normal    KubernetesVersionMaintenance     shoot/local     Control Plane: Updated Kubernetes version from &quot;1.26.4&quot; to &quot;1.27.1&quot;. Reason: Kubernetes version expired - force update required.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>15m         Normal    KubernetesVersionMaintenance     shoot/local     Worker pool &quot;local&quot;: Updated Kubernetes version &#39;1.26.3&#39; to version &#39;1.27.1&#39;. Reason: Kubernetes version expired - force update required.</span></span></code></pre></div><p>If at least one maintenance operation fails, the <code>lastMaintenance</code> field in the Shoot status is set to <code>Failed</code>:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">Last Maintenance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:     </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;(1/2) maintenance operations successful: Control Plane: Updated Kubernetes version from 1.26.4 to 1.27.1. Reason: Kubernetes version expired - force update required, Worker pool x: &#39;gardenlinux&#39; machine image version maintenance failed. Reason for update: machine image version expired&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  FailureReason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:   </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Worker pool x: either the machine image &#39;gardenlinux&#39; is reaching end of life and migration to another machine image is required or there is a misconfiguration in the CloudProfile.&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:           </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Failed</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  Triggered Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2023-07-28T09:07:27Z</span></span></code></pre></div><p>Please refer to the <a href="/docs/gardener/shoot-operations/shoot_versions/">Shoot Kubernetes and Operating System Versioning in Gardener</a> topic for more information about Kubernetes and machine image versions in Gardener.</p><h2 id="cluster-reconciliation" tabindex="-1">Cluster Reconciliation <a class="header-anchor" href="#cluster-reconciliation" aria-label="Permalink to &quot;Cluster Reconciliation&quot;">​</a></h2><p>Gardener administrators/operators can configure the gardenlet in a way that it only reconciles shoot clusters during their maintenance time windows. This behaviour is not controllable by end-users but might make sense for large Gardener installations. Concretely, your shoot will be reconciled regularly during its maintenance time window. Outside of the maintenance time window it will only reconcile if you change the specification or if you explicitly trigger it, see also <a href="/docs/gardener/shoot-operations/shoot_operations/">Trigger Shoot Operations</a>.</p><h2 id="confine-specification-changes-updates-roll-out" tabindex="-1">Confine Specification Changes/Updates Roll Out <a class="header-anchor" href="#confine-specification-changes-updates-roll-out" aria-label="Permalink to &quot;Confine Specification Changes/Updates Roll Out&quot;">​</a></h2><p>Via the <code>.spec.maintenance.confineSpecUpdateRollout</code> field you can control whether you want to make Gardener roll out changes/updates to your shoot specification only during the maintenance time window. It is <code>false</code> by default, i.e., any change to your shoot specification triggers a reconciliation (even outside of the maintenance time window). This is helpful if you want to update your shoot but don&#39;t want the changes to be applied immediately. One example use-case would be a Kubernetes version upgrade that you want to roll out during the maintenance time window. Any update to the specification will not increase the <code>.metadata.generation</code> of the <code>Shoot</code>, which is something you should be aware of. Also, even if Gardener administrators/operators have not enabled the &quot;reconciliation in maintenance time window only&quot; configuration (as mentioned above), then your shoot will only reconcile in the maintenance time window. The reason is that Gardener cannot differentiate between create/update/reconcile operations.</p><p>⚠️ If <code>confineSpecUpdateRollout=true</code>, please note that if you change the maintenance time window itself, then it will only be effective after the upcoming maintenance.</p><p>⚠️ As exceptions to the above rules, <a href="/docs/gardener/shoot-operations/shoot_operations/#immediate-reconciliation">manually triggered reconciliations</a> and changes to the <code>.spec.hibernation.enabled</code> field trigger immediate rollouts. I.e., if you hibernate or wake-up your shoot, or you explicitly tell Gardener to reconcile your shoot, then Gardener gets active right away.</p><h2 id="shoot-operations" tabindex="-1">Shoot Operations <a class="header-anchor" href="#shoot-operations" aria-label="Permalink to &quot;Shoot Operations&quot;">​</a></h2><p>In case you would like to perform a <a href="/docs/gardener/shoot-operations/shoot_operations/#credentials-rotation-operations">shoot credential rotation</a> or a <code>reconcile</code> operation during your maintenance time window, you can annotate the <code>Shoot</code> with</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>maintenance.gardener.cloud/operation=&lt;operation&gt;</span></span></code></pre></div><p>This will execute the specified <code>&lt;operation&gt;</code> during the next maintenance reconciliation. Note that Gardener will remove this annotation after it has been performed in the maintenance reconciliation.</p><blockquote><p>⚠️ This is skipped when the <code>Shoot</code>&#39;s <code>.status.lastOperation.state=Failed</code>. Make sure to <a href="/docs/gardener/shoot-operations/shoot_operations/#retry-failed-reconciliation">retry</a> your shoot reconciliation beforehand.</p></blockquote><h2 id="special-operations-during-maintenance" tabindex="-1">Special Operations During Maintenance <a class="header-anchor" href="#special-operations-during-maintenance" aria-label="Permalink to &quot;Special Operations During Maintenance&quot;">​</a></h2><p>The shoot maintenance controller triggers special operations that are performed as part of the shoot reconciliation.</p><h3 id="infrastructure-and-dnsrecord-reconciliation" tabindex="-1"><code>Infrastructure</code> and <code>DNSRecord</code> Reconciliation <a class="header-anchor" href="#infrastructure-and-dnsrecord-reconciliation" aria-label="Permalink to &quot;\`Infrastructure\` and \`DNSRecord\` Reconciliation&quot;">​</a></h3><p>The reconciliation of the <code>Infrastructure</code> and <code>DNSRecord</code> extension resources is only demanded during the shoot&#39;s maintenance time window. The rationale behind it is to prevent sending too many requests against the cloud provider APIs, especially on large landscapes or if a user has many shoot clusters in the same cloud provider account.</p><h3 id="restart-control-plane-controllers" tabindex="-1">Restart Control Plane Controllers <a class="header-anchor" href="#restart-control-plane-controllers" aria-label="Permalink to &quot;Restart Control Plane Controllers&quot;">​</a></h3><p>Gardener operators can make Gardener restart/delete certain control plane pods during a shoot maintenance. This feature helps to automatically solve service denials of controllers due to stale caches, dead-locks or starving routines.</p><p>Please note that these are exceptional cases but they are observed from time to time. Gardener, for example, takes this precautionary measure for <code>kube-controller-manager</code> pods.</p><p>See <a href="/docs/gardener/extensions/shoot-maintenance/">Shoot Maintenance</a> to see how extension developers can extend this behaviour.</p><h3 id="restart-some-core-addons" tabindex="-1">Restart Some Core Addons <a class="header-anchor" href="#restart-some-core-addons" aria-label="Permalink to &quot;Restart Some Core Addons&quot;">​</a></h3><p>Gardener operators can make Gardener restart some core addons (at the moment only CoreDNS) during a shoot maintenance.</p><p>CoreDNS benefits from this feature as it automatically solve problems with clients stuck to single replica of the deployment and thus overloading it. Please note that these are exceptional cases but they are observed from time to time.</p>`,45)]))}const m=a(s,[["render",o]]);export{u as __pageData,m as default};
